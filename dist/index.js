import Q,{useEffect as ut,useMemo as pt,useRef as tt,useState as et}from"react";import ft from"html2canvas";import{useEffect as ct,useRef as ot,useState as G}from"react";import{jsx as z,jsxs as q}from"react/jsx-runtime";var Z=({children:c,title:g,onClose:u,position:y="bottom-right",width:x=360,height:_=480,minWidth:H=280,minHeight:D=240,offset:O=16,zIndex:j=1e3,className:R,style:M,headerClassName:w,bodyClassName:B,closeButtonAriaLabel:V="Close",closeOnEscape:W=!0,draggable:S=!0,anchorRect:a})=>{let[b,p]=G(!1),v=ot(null),[k,I]=G(!1),s=ot(null),[P,T]=G(null);ct(()=>{if(!W)return;let r=l=>{l.key==="Escape"&&u?.()};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[W,u]);let $=(()=>{let r=`${O}px`;switch(y){case"top-left":return{top:r,left:r};case"top-right":return{top:r,right:r};case"bottom-left":return{bottom:r,left:r};case"bottom-right":default:return{bottom:r,right:r}}})(),L=(()=>{if(y!=="auto"||!a)return null;let r=window.innerWidth,l=window.innerHeight,i=O,m=a.top<l/2,C=a.left>r/2,E=m?["bottom","top"]:["top","bottom"],h=C?["right","left"]:["left","right"],F=[`${E[0]}-${h[0]}`,`${E[0]}-${h[1]}`,`${E[1]}-${h[0]}`,`${E[1]}-${h[1]}`];for(let e of F){let o=0,n=0;if(e==="bottom-right"?(o=a.bottom+i,n=a.right-x):e==="bottom-left"?(o=a.bottom+i,n=a.left):e==="top-right"?(o=a.top-_-i,n=a.right-x):(o=a.top-_-i,n=a.left),o>=0&&n>=0&&o+_<=l&&n+x<=r)return{top:o,left:n}}let A=Math.min(Math.max(a.bottom+i,0),l-_),t=Math.min(Math.max(a.right-x,0),r-x);return{top:A,left:t}})(),K=r=>{if(!S)return;let l=v.current;if(!l)return;let i=l.getBoundingClientRect();s.current={x:r.clientX,y:r.clientY,top:i.top,left:i.left},T({top:i.top,left:i.left}),I(!0);let m=E=>{if(!s.current)return;let h=E.clientX-s.current.x,F=E.clientY-s.current.y;T({top:s.current.top+F,left:s.current.left+h})},C=()=>{I(!1),s.current=null,window.removeEventListener("pointermove",m),window.removeEventListener("pointerup",C)};window.addEventListener("pointermove",m),window.addEventListener("pointerup",C,{once:!0})};return q("div",{ref:v,role:"dialog","aria-modal":"false",className:R,style:{position:"fixed",...P?{top:P.top,left:P.left}:L?{top:L.top,left:L.left}:$,width:x,height:_,minWidth:H,minHeight:D,zIndex:j,background:"#ffffff",border:"1px solid rgba(0,0,0,0.06)",borderRadius:12,boxShadow:"0 10px 30px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08)",display:"flex",flexDirection:"column",overflow:"hidden",userSelect:k?"none":void 0,...M},children:[q("div",{className:w,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 12px",borderBottom:"1px solid rgba(0,0,0,0.06)",background:"#f9fafb",cursor:S?"move":void 0},onPointerDown:K,children:[z("div",{style:{fontWeight:600,color:"#111827"},children:g}),z("button",{type:"button",onClick:u,"aria-label":V,onMouseEnter:()=>p(!0),onMouseLeave:()=>p(!1),style:{width:28,height:28,display:"inline-flex",alignItems:"center",justifyContent:"center",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer",color:b?"#ef4444":void 0,transition:"color 120ms ease"},children:q("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[z("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),z("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),z("div",{className:B,style:{flex:1,overflow:"auto",background:"#ffffff"},children:c})]})};import{jsx as Y,jsxs as gt}from"react/jsx-runtime";var rt=Q.forwardRef(({children:c,onClick:g,label:u="Open chat",position:y="top-right",offset:x=8,icon:_,className:H,containerStyle:D,buttonClassName:O,buttonStyle:j,buttonSize:R=36,zIndex:M=10,disabled:w=!1,trigger:B,open:V,onOpenChange:W,renderButton:S,openWindowOnClick:a=!1,windowProps:b,windowContent:p},v)=>{let[k,I]=et(!1),[s,P]=et(!1),T=tt(null),$=tt(null),L=tt(null),[K,r]=et(null),l=B??"hover",i=pt(()=>{let t={position:"absolute"},e=`${x}px`;switch(y){case"top-left":return{...t,top:e,left:e};case"top-right":return{...t,top:e,right:e};case"bottom-left":return{...t,bottom:e,left:e};case"bottom-right":default:return{...t,bottom:e,right:e}}},[y,x]),m=l==="always"?!0:l==="manual"?!!V:k,C=t=>{W&&W(t)},E={onMouseEnter:l==="hover"?()=>{I(!0),C(!0)}:void 0,onMouseLeave:l==="hover"?()=>{I(!1),C(!1)}:void 0,onFocus:l==="focus"?()=>{I(!0),C(!0)}:void 0,onBlur:l==="focus"?()=>{I(!1),C(!1)}:void 0},h=!!b?.sendComponentImageAsContext;ut(()=>{s&&(async()=>{if(!h)return;let e=L.current;if(e)try{await new Promise(f=>requestAnimationFrame(()=>setTimeout(f,50)));let n=(await ft(e,{useCORS:!0,backgroundColor:null,scale:Math.min(2,Math.max(1,Math.ceil(e.offsetWidth/280)))})).toDataURL("image/png",.92);r(n)}catch{}})()},[s,h]);let F=t=>{T.current=t,typeof v=="function"?v(t):v&&typeof v=="object"&&(v.current=t)},A={type:"button","aria-label":u,onClick:t=>{g?.(t),!w&&a&&P(!0)},className:O,disabled:w,style:{...i,zIndex:M,width:R,height:R,borderRadius:9999,display:"flex",alignItems:"center",justifyContent:"center",border:"1px solid rgba(0,0,0,0.08)",background:w?"#f3f4f6":"white",color:w?"#9ca3af":void 0,boxShadow:"0 2px 6px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06)",cursor:w?"not-allowed":"pointer",transition:"opacity 120ms ease, transform 120ms ease",opacity:m?1:0,transform:m?"scale(1)":"scale(0.95)",pointerEvents:m?"auto":"none",...j},tabIndex:m?0:-1,"aria-hidden":m?void 0:!0,ref:F,visible:m};return gt("div",{className:H,style:{position:"relative",display:"inline-block",...D},...E,ref:$,children:[Y("div",{ref:L,style:{display:"inline-block"},children:c}),S?S(A):Y("button",{...A,children:_??Y("svg",{xmlns:"http://www.w3.org/2000/svg",width:Math.max(12,Math.floor(R*.5)),height:Math.max(12,Math.floor(R*.5)),viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:Y("path",{d:"M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"})})}),a&&s&&p&&Y(Z,{...b,onClose:()=>{b?.onClose?.(),P(!1),r(null)},anchorRect:b?.anchorRect??(T.current?T.current.getBoundingClientRect():null),children:(()=>{if(h){if(!K)return Y("div",{style:{padding:12,color:"#6b7280",fontSize:14},children:"Loading..."});if(Q.isValidElement(p)){let e=[...p.props?.contextImages??[],K];try{return Q.cloneElement(p,{contextImages:e})}catch{return p}}}return p})()})]})});rt.displayName="ChatEnabled";import{useCallback as nt,useEffect as it,useMemo as yt,useRef as at,useState as X}from"react";var J="ai-hud:default-chatbot:history:";function st(c){return`${J}${c}`}function mt(c){try{typeof window<"u"&&window.localStorage.removeItem(st(c))}catch{}}function ht(){try{if(typeof window>"u")return;let c=[];for(let g=0;g<window.localStorage.length;g++){let u=window.localStorage.key(g);u&&u.startsWith(J)&&c.push(u)}c.forEach(g=>window.localStorage.removeItem(g))}catch{}}import{jsx as d,jsxs as N}from"react/jsx-runtime";var bt="https://api.openai.com/v1/chat/completions";async function vt(c){return new Promise((g,u)=>{let y=new FileReader;y.onload=()=>g(y.result),y.onerror=u,y.readAsDataURL(c)})}var xt=({model:c="gpt-4o-mini",placeholderApiKey:g,systemPrompt:u="You are a helpful assistant.",welcome:y="Hi! How can I help you today?",className:x,style:_,conversationId:H,context:D,contextImages:O,inputPlaceholder:j,inputValue:R,agents:M,activeAgentId:w,onAgentChange:B})=>{let W=(t=>{if(t&&t!=="REPLACE_WITH_YOUR_OPENAI_API_KEY")return t;try{let e=globalThis||{};if(typeof e.AI_HUD_OPENAI_API_KEY=="string"&&e.AI_HUD_OPENAI_API_KEY)return e.AI_HUD_OPENAI_API_KEY;if(typeof e.__AI_HUD_OPENAI_API_KEY__=="string"&&e.__AI_HUD_OPENAI_API_KEY__)return e.__AI_HUD_OPENAI_API_KEY__}catch{}try{let e=globalThis.process;if(e&&e.env&&typeof e.env.AI_HUD_OPENAI_API_KEY=="string")return e.env.AI_HUD_OPENAI_API_KEY}catch{}return null})(g),S=at(null);if(!H&&!S.current){let t=(()=>{try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`conv_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`})();S.current=t}let a=H??S.current,b=`${J}${a}`,[p,v]=X(()=>{try{let t=typeof window<"u"?window.localStorage.getItem(b):null;if(t){let e=JSON.parse(t);if(Array.isArray(e))return e}}catch{}return[{id:"welcome",role:"assistant",text:y}]}),[k,I]=X(()=>typeof R=="string"?R:""),[s,P]=X([]),[T,$]=X(!1),L=at(null),[K,r]=X(()=>M?.[0]?.id),l=w??K,i=M?.find(t=>t.id===l),m=nt(()=>{L.current?.scrollIntoView({behavior:"smooth"})},[]),C=async t=>{let e=Array.from(t.target.files||[]);if(e.length===0)return;let o=await Promise.all(e.map(vt));P(n=>[...n,...o]),t.target.value=""},E=t=>{P(e=>e.filter((o,n)=>n!==t))},h=nt((t,e)=>{let o=[];if(i?.systemPrompt&&o.push({role:"system",content:i.systemPrompt}),u&&o.push({role:"system",content:u}),typeof D<"u"){let n="";try{n=JSON.stringify(D)}catch{n=String(D)}o.push({role:"system",content:`Context: ${n}`})}if(typeof i?.context<"u")try{o.push({role:"system",content:`AgentContext: ${JSON.stringify(i.context)}`})}catch{o.push({role:"system",content:`AgentContext: ${String(i.context)}`})}if(Array.isArray(O)&&O.length>0){let n=O.filter(f=>typeof f=="string"&&(f.startsWith("data:image/")||f.startsWith("http")));if(n.length>0){let f=[{type:"text",text:"Context images"},...n.map(U=>({type:"image_url",image_url:{url:U}}))];o.push({role:"user",content:f})}}for(let n of t)if(n.role==="assistant")o.push({role:"assistant",content:n.text||""});else if((n.images?.length||0)>0){let f=[{type:"text",text:n.text||""},...n.images.map(U=>({type:"image_url",image_url:{url:U}}))];o.push({role:"user",content:f})}else o.push({role:"user",content:n.text||""});if(e)if(e.images.length>0){let n=[{type:"text",text:e.text},...e.images.map(f=>({type:"image_url",image_url:{url:f}}))];o.push({role:"user",content:n})}else o.push({role:"user",content:e.text});return console.log("result",o),o},[u,D,i?.systemPrompt,i?.context]),F=nt(async()=>{let t=k.trim();if(!t&&s.length===0)return;let e={id:String(Date.now()),role:"user",text:t||void 0,images:s.length?s:void 0};v(o=>[...o,e]),I(""),P([]),$(!0);try{let o=h(p,{text:e.text||"",images:e.images||[]}),n=await fetch(bt,{method:"POST",headers:{"Content-Type":"application/json",...W?{Authorization:`Bearer ${W}`}:{}},body:JSON.stringify({model:c,messages:o,temperature:.7})});if(!n.ok)throw new Error(`OpenAI error: ${n.status}`);let U=(await n.json())?.choices?.[0]?.message?.content??"",lt={id:String(Date.now()+1),role:"assistant",text:typeof U=="string"?U:String(U)};v(dt=>[...dt,lt]),setTimeout(m,0)}catch(o){let n={id:String(Date.now()+1),role:"assistant",text:`Error: ${o?.message||"Failed to contact OpenAI"}`};v(f=>[...f,n])}finally{$(!1)}},[h,k,p,s,g,c,m]),A=yt(()=>(k.trim().length>0||s.length>0)&&!T,[k,s.length,T]);return it(()=>{try{typeof window<"u"&&window.localStorage.setItem(b,JSON.stringify(p))}catch{}},[p,b]),it(()=>()=>{if(!H)try{typeof window<"u"&&window.localStorage.removeItem(b)}catch{}},[H,b]),N("div",{className:x,style:{display:"flex",flexDirection:"column",height:"100%",..._},children:[N("div",{style:{flex:1,overflow:"auto",padding:12,background:"#ffffff"},children:[Array.isArray(M)&&M.length>0&&d("div",{style:{display:"flex",gap:8,marginBottom:8,flexWrap:"wrap"},children:M.map(t=>{let e=t.id===l;return N("button",{type:"button",onClick:()=>{w&&B&&B(t.id),w||r(t.id)},style:{display:"inline-flex",alignItems:"center",gap:6,padding:"6px 10px",borderRadius:8,border:e?"1px solid #111827":"1px solid #e5e7eb",background:e?"#111827":"white",color:e?"white":"#111827",cursor:"pointer"},children:[t.icon,d("span",{children:t.name})]},t.id)})}),p.map(t=>d("div",{style:{marginBottom:10,display:"flex",justifyContent:t.role==="user"?"flex-end":"flex-start"},children:N("div",{style:{maxWidth:"80%",padding:"8px 10px",borderRadius:10,border:"1px solid rgba(0,0,0,0.06)",background:t.role==="user"?"#111827":"#f3f4f6",color:t.role==="user"?"#ffffff":"#111827",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:[t.text,t.images&&t.images.length>0&&d("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:t.images.map((e,o)=>d("img",{src:e,alt:"upload",style:{width:96,height:72,objectFit:"cover",borderRadius:8,border:"1px solid rgba(0,0,0,0.06)"}},o))})]})},t.id)),d("div",{ref:L})]}),N("div",{style:{padding:12,borderTop:"1px solid rgba(0,0,0,0.06)",background:"#fafafa"},children:[N("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[d("input",{type:"file",accept:"image/*",multiple:!0,onChange:C,style:{display:"none"},id:"ai-hud-chatbot-file"}),d("label",{htmlFor:"ai-hud-chatbot-file",children:d("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:36,height:36,border:"1px solid rgba(0,0,0,0.08)",borderRadius:8,background:"white",cursor:"pointer"},children:N("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[d("path",{d:"M18.5 12.5l-5 5-3-3-5 5"}),d("path",{d:"M20 7a4 4 0 0 0-8 0v10a4 4 0 0 0 8 0Z"})]})})}),d("input",{value:k,onChange:t=>I(t.target.value),placeholder:j??"Type a message...",onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),A&&F())},style:{flex:1,height:36,border:"1px solid rgba(0,0,0,0.15)",borderRadius:8,padding:"0 10px"}}),d("button",{type:"button",disabled:!A,onClick:()=>void F(),style:{height:36,padding:"0 12px",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:A?"#111827":"#e5e7eb",color:A?"#ffffff":"#9ca3af",cursor:A?"pointer":"not-allowed"},children:"Send"})]}),s.length>0&&d("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:s.map((t,e)=>N("div",{style:{position:"relative"},children:[d("img",{src:t,alt:"selected",style:{width:64,height:48,objectFit:"cover",borderRadius:6,border:"1px solid rgba(0,0,0,0.06)"}}),d("button",{type:"button",onClick:()=>E(e),"aria-label":"Remove image",style:{position:"absolute",top:-6,right:-6,width:20,height:20,borderRadius:9999,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer"},children:"\xD7"})]},e))})]})]})};export{J as CHAT_STORAGE_PREFIX,rt as ChatEnabled,xt as DefaultChatbot,Z as FloatingWindow,ht as clearAllConversations,mt as clearConversation,st as getConversationStorageKey};
//# sourceMappingURL=index.js.map