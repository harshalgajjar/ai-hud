import ie,{useEffect as Ce,useMemo as Ee,useRef as le,useState as ce}from"react";import Ie from"html2canvas";import{useEffect as xe,useRef as fe,useState as re}from"react";import{jsx as V,jsxs as se}from"react/jsx-runtime";var ae=({children:d,title:p,onClose:g,position:w="bottom-right",width:I=360,height:P=480,minWidth:L=280,minHeight:O=240,offset:D=16,zIndex:Y=1e3,className:M,style:N,headerClassName:R,bodyClassName:q,closeButtonAriaLabel:j="Close",closeOnEscape:S=!0,draggable:F=!0,anchorRect:a})=>{let[x,b]=re(!1),m=fe(null),[U,l]=re(!1),f=fe(null),[k,T]=re(null);xe(()=>{if(!S)return;let r=i=>{i.key==="Escape"&&g?.()};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[S,g]);let B=(()=>{let r=`${D}px`;switch(w){case"top-left":return{top:r,left:r};case"top-right":return{top:r,right:r};case"bottom-left":return{bottom:r,left:r};case"bottom-right":default:return{bottom:r,right:r}}})(),H=(()=>{if(w!=="auto"||!a)return null;let r=window.innerWidth,i=window.innerHeight,y=D,v=a.top<i/2,C=a.left>r/2,E=v?["bottom","top"]:["top","bottom"],c=C?["right","left"]:["left","right"],t=[`${E[0]}-${c[0]}`,`${E[0]}-${c[1]}`,`${E[1]}-${c[0]}`,`${E[1]}-${c[1]}`];for(let n of t){let s=0,u=0;if(n==="bottom-right"?(s=a.bottom+y,u=a.right-I):n==="bottom-left"?(s=a.bottom+y,u=a.left):n==="top-right"?(s=a.top-P-y,u=a.right-I):(s=a.top-P-y,u=a.left),s>=0&&u>=0&&s+P<=i&&u+I<=r)return{top:s,left:u}}let o=Math.min(Math.max(a.bottom+y,0),i-P),e=Math.min(Math.max(a.right-I,0),r-I);return{top:o,left:e}})(),$=r=>{if(!F)return;let i=m.current;if(!i)return;let y=i.getBoundingClientRect();f.current={x:r.clientX,y:r.clientY,top:y.top,left:y.left},T({top:y.top,left:y.left}),l(!0);let v=E=>{if(!f.current)return;let c=E.clientX-f.current.x,t=E.clientY-f.current.y;T({top:f.current.top+t,left:f.current.left+c})},C=()=>{l(!1),f.current=null,window.removeEventListener("pointermove",v),window.removeEventListener("pointerup",C)};window.addEventListener("pointermove",v),window.addEventListener("pointerup",C,{once:!0})};return se("div",{ref:m,role:"dialog","aria-modal":"false",className:M,style:{position:"fixed",...k?{top:k.top,left:k.left}:H?{top:H.top,left:H.left}:B,width:I,height:P,minWidth:L,minHeight:O,zIndex:Y,background:"#ffffff",border:"1px solid rgba(0,0,0,0.06)",borderRadius:12,boxShadow:"0 10px 30px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08)",display:"flex",flexDirection:"column",overflow:"hidden",userSelect:U?"none":void 0,...N},children:[se("div",{className:R,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 12px",borderBottom:"1px solid rgba(0,0,0,0.06)",background:"#f9fafb",cursor:F?"move":void 0},onPointerDown:$,children:[V("div",{style:{fontWeight:600,color:"#111827"},children:p}),V("button",{type:"button",onClick:g,"aria-label":j,onMouseEnter:()=>b(!0),onMouseLeave:()=>b(!1),style:{width:28,height:28,display:"inline-flex",alignItems:"center",justifyContent:"center",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer",color:x?"#ef4444":void 0,transition:"color 120ms ease"},children:se("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[V("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),V("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),V("div",{className:q,style:{flex:1,overflow:"auto",background:"#ffffff"},children:d})]})};import{jsx as K,jsxs as Ae}from"react/jsx-runtime";var pe=ie.forwardRef(({children:d,onClick:p,label:g="Open chat",position:w="top-right",offset:I=8,icon:P,className:L,containerStyle:O,buttonClassName:D,buttonStyle:Y,buttonSize:M=36,zIndex:N=10,disabled:R=!1,trigger:q,open:j,onOpenChange:S,renderButton:F,openWindowOnClick:a=!1,windowProps:x,windowContent:b},m)=>{let[U,l]=ce(!1),[f,k]=ce(!1),T=le(null),B=le(null),H=le(null),[$,r]=ce(null),i=q??"hover",y=Ee(()=>{let e={position:"absolute"},n=`${I}px`;switch(w){case"top-left":return{...e,top:n,left:n};case"top-right":return{...e,top:n,right:n};case"bottom-left":return{...e,bottom:n,left:n};case"bottom-right":default:return{...e,bottom:n,right:n}}},[w,I]),v=i==="always"?!0:i==="manual"?!!j:U,C=e=>{S&&S(e)},E={onMouseEnter:i==="hover"?()=>{l(!0),C(!0)}:void 0,onMouseLeave:i==="hover"?()=>{l(!1),C(!1)}:void 0,onFocus:i==="focus"?()=>{l(!0),C(!0)}:void 0,onBlur:i==="focus"?()=>{l(!1),C(!1)}:void 0},c=!!x?.sendComponentImageAsContext;Ce(()=>{f&&(async()=>{if(!c)return;let n=H.current;if(n)try{await new Promise(A=>requestAnimationFrame(()=>setTimeout(A,50)));let u=(await Ie(n,{useCORS:!0,backgroundColor:null,scale:Math.min(2,Math.max(1,Math.ceil(n.offsetWidth/280)))})).toDataURL("image/png",.92);r(u)}catch{}})()},[f,c]);let t=e=>{T.current=e,typeof m=="function"?m(e):m&&typeof m=="object"&&(m.current=e)},o={type:"button","aria-label":g,onClick:e=>{p?.(e),!R&&a&&k(!0)},className:D,disabled:R,style:{...y,zIndex:N,width:M,height:M,borderRadius:9999,display:"flex",alignItems:"center",justifyContent:"center",border:"1px solid rgba(0,0,0,0.08)",background:R?"#f3f4f6":"white",color:R?"#9ca3af":void 0,boxShadow:"0 2px 6px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06)",cursor:R?"not-allowed":"pointer",transition:"opacity 120ms ease, transform 120ms ease",opacity:v?1:0,transform:v?"scale(1)":"scale(0.95)",pointerEvents:v?"auto":"none",...Y},tabIndex:v?0:-1,"aria-hidden":v?void 0:!0,ref:t,visible:v};return Ae("div",{className:L,style:{position:"relative",display:"inline-block",...O},...E,ref:B,children:[K("div",{ref:H,style:{display:"inline-block"},children:d}),F?F(o):K("button",{...o,children:P??K("svg",{xmlns:"http://www.w3.org/2000/svg",width:Math.max(12,Math.floor(M*.5)),height:Math.max(12,Math.floor(M*.5)),viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:K("path",{d:"M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"})})}),a&&f&&b&&K(ae,{...x,onClose:()=>{x?.onClose?.(),k(!1),r(null)},anchorRect:x?.anchorRect??(T.current?T.current.getBoundingClientRect():null),children:(()=>{if(c){if(!$)return K("div",{style:{padding:12,color:"#6b7280",fontSize:14},children:"Loading..."});if(ie.isValidElement(b)){let n=[...b.props?.contextImages??[],$];try{return ie.cloneElement(b,{contextImages:n})}catch{return b}}}return b})()})]})});pe.displayName="ChatEnabled";import{useCallback as ee,useEffect as ye,useMemo as he,useRef as be,useState as te}from"react";import{ChatOpenAI as Me}from"@langchain/openai";import{AIMessage as Re,HumanMessage as ve,SystemMessage as Se,ToolMessage as ke}from"@langchain/core/messages";var G="ai-hud:default-chatbot:history:";function me(d){return`${G}${d}`}function _e(d){try{typeof window<"u"&&window.localStorage.removeItem(me(d))}catch{}}function Pe(){try{if(typeof window>"u")return;let d=[];for(let p=0;p<window.localStorage.length;p++){let g=window.localStorage.key(p);g&&g.startsWith(G)&&d.push(g)}d.forEach(p=>window.localStorage.removeItem(p))}catch{}}import{jsx as h,jsxs as W}from"react/jsx-runtime";async function Te(d){return new Promise((p,g)=>{let w=new FileReader;w.onload=()=>p(w.result),w.onerror=g,w.readAsDataURL(d)})}var He=({model:d="gpt-4o-mini",placeholderApiKey:p,systemPrompt:g="You are a helpful assistant.",welcome:w="Hi! How can I help you today?",className:I,style:P,conversationId:L,context:O,contextImages:D,inputPlaceholder:Y,inputValue:M,tools:N,toolMaxIterations:R=3})=>{let j=(t=>{if(t&&t!=="REPLACE_WITH_YOUR_OPENAI_API_KEY")return t;try{let o=globalThis||{};if(typeof o.AI_HUD_OPENAI_API_KEY=="string"&&o.AI_HUD_OPENAI_API_KEY)return o.AI_HUD_OPENAI_API_KEY;if(typeof o.__AI_HUD_OPENAI_API_KEY__=="string"&&o.__AI_HUD_OPENAI_API_KEY__)return o.__AI_HUD_OPENAI_API_KEY__}catch{}try{let o=globalThis.process;if(o&&o.env&&typeof o.env.AI_HUD_OPENAI_API_KEY=="string")return o.env.AI_HUD_OPENAI_API_KEY}catch{}return null})(p),S=be(null);if(!L&&!S.current){let t=(()=>{try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`conv_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`})();S.current=t}let F=L??S.current,a=`${G}${F}`,[x,b]=te(()=>{try{let t=typeof window<"u"?window.localStorage.getItem(a):null;if(t){let o=JSON.parse(t);if(Array.isArray(o))return o}}catch{}return[{id:"welcome",role:"assistant",text:w}]}),[m,U]=te(()=>typeof M=="string"?M:""),[l,f]=te([]),[k,T]=te(!1),B=be(null),H=ee(()=>{B.current?.scrollIntoView({behavior:"smooth"})},[]),$=ee(t=>t?t.replace(/\\\(/g,"(").replace(/\\\)/g,")").replace(/\\times/g,"\xD7").replace(/\\n/g,`
`):"",[]),{toolSchemas:r,toolExecutors:i}=he(()=>{if(!Array.isArray(N))return{toolSchemas:[],toolExecutors:{}};let t=N.map(e=>({type:"function",function:{name:e.function.name,description:e.function.description??"",parameters:e.function.parameters??{type:"object",properties:{}}}})),o={};for(let e of N)o[e.function.name]=async n=>await e.execute(n);return{toolSchemas:t,toolExecutors:o}},[N]),y=async t=>{let o=Array.from(t.target.files||[]);if(o.length===0)return;let e=await Promise.all(o.map(Te));f(n=>[...n,...e]),t.target.value=""},v=t=>{f(o=>o.filter((e,n)=>n!==t))},C=ee((t,o)=>{let e=[];if(g&&e.push({role:"system",content:g}),typeof O<"u"){let n="";try{n=JSON.stringify(O)}catch{n=String(O)}e.push({role:"system",content:`Context: ${n}`})}if(Array.isArray(D)&&D.length>0){let n=D.filter(s=>typeof s=="string"&&(s.startsWith("data:image/")||s.startsWith("http")));if(n.length>0){let s=[{type:"text",text:"Context images"},...n.map(u=>({type:"image_url",image_url:{url:u}}))];e.push({role:"user",content:s})}}for(let n of t)if(n.role==="assistant")e.push({role:"assistant",content:n.text||""});else if((n.images?.length||0)>0){let s=[{type:"text",text:n.text||""},...n.images.map(u=>({type:"image_url",image_url:{url:u}}))];e.push({role:"user",content:s})}else e.push({role:"user",content:n.text||""});if(o)if(o.images.length>0){let n=[{type:"text",text:o.text},...o.images.map(s=>({type:"image_url",image_url:{url:s}}))];e.push({role:"user",content:n})}else e.push({role:"user",content:o.text});return console.log("result",e),e},[g,O]),E=ee(async()=>{let t=m.trim();if(!t&&l.length===0)return;let o={id:String(Date.now()),role:"user",text:t||void 0,images:l.length?l:void 0};b(e=>[...e,o]),U(""),f([]),T(!0);try{let e=[],n=C(x,{text:o.text||"",images:o.images||[]});for(let _ of n)if(_.role==="system")e.push(new Se(_.content));else if(_.role==="assistant")e.push(new Re(_.content));else if(_.role==="user"){let J=_.content;Array.isArray(J)?e.push(new ve({content:J})):e.push(new ve(_.content))}let s=new Me({modelName:d,temperature:.7,apiKey:j??void 0}),u=r.length>0?s.bind({tools:r}):s,A=await u.invoke(e),ue=0;for(;ue<R&&Array.isArray(A.tool_calls)&&A.tool_calls.length>0&&r.length>0;){let _=A.tool_calls,J=[];for(let z of _){let Z=z.name??z.function?.name,Q=z.args??z.function?.arguments,oe=Q;if(typeof Q=="string")try{oe=JSON.parse(Q)}catch{oe=Q}let de=Z?i[Z]:void 0,X=`Tool '${Z}' not found`;try{de&&(X=await de(oe))}catch(ge){X=`Error from tool '${Z}': ${ge?.message||String(ge)}`}J.push(new ke({tool_call_id:z.id,content:typeof X=="string"?X:JSON.stringify(X)}))}e=[...e,A,...J],A=await u.invoke(e),ue+=1}let ne=typeof A.content=="string"?A.content:JSON.stringify(A.content),we={id:String(Date.now()+1),role:"assistant",text:typeof ne=="string"?ne:String(ne)};b(_=>[..._,we]),setTimeout(H,0)}catch(e){let n={id:String(Date.now()+1),role:"assistant",text:`Error: ${e?.message||"Failed to contact OpenAI"}`};b(s=>[...s,n])}finally{T(!1)}},[C,m,x,l,p,d,H]),c=he(()=>(m.trim().length>0||l.length>0)&&!k,[m,l.length,k]);return ye(()=>{try{typeof window<"u"&&window.localStorage.setItem(a,JSON.stringify(x))}catch{}},[x,a]),ye(()=>()=>{if(!L)try{typeof window<"u"&&window.localStorage.removeItem(a)}catch{}},[L,a]),W("div",{className:I,style:{display:"flex",flexDirection:"column",height:"100%",...P},children:[W("div",{style:{flex:1,overflow:"auto",padding:12,background:"#ffffff"},children:[x.map(t=>h("div",{style:{marginBottom:10,display:"flex",justifyContent:t.role==="user"?"flex-end":"flex-start"},children:W("div",{style:{maxWidth:"80%",padding:"8px 10px",borderRadius:10,border:"1px solid rgba(0,0,0,0.06)",background:t.role==="user"?"#111827":"#f3f4f6",color:t.role==="user"?"#ffffff":"#111827",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:[t.role==="assistant"?$(t.text):t.text,t.images&&t.images.length>0&&h("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:t.images.map((o,e)=>h("img",{src:o,alt:"upload",style:{width:96,height:72,objectFit:"cover",borderRadius:8,border:"1px solid rgba(0,0,0,0.06)"}},e))})]})},t.id)),h("div",{ref:B})]}),W("div",{style:{padding:12,borderTop:"1px solid rgba(0,0,0,0.06)",background:"#fafafa"},children:[W("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[h("input",{type:"file",accept:"image/*",multiple:!0,onChange:y,style:{display:"none"},id:"ai-hud-chatbot-file"}),h("label",{htmlFor:"ai-hud-chatbot-file",children:h("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:36,height:36,border:"1px solid rgba(0,0,0,0.08)",borderRadius:8,background:"white",cursor:"pointer"},children:W("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[h("path",{d:"M18.5 12.5l-5 5-3-3-5 5"}),h("path",{d:"M20 7a4 4 0 0 0-8 0v10a4 4 0 0 0 8 0Z"})]})})}),h("input",{value:m,onChange:t=>U(t.target.value),placeholder:Y??"Type a message...",onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),c&&E())},style:{flex:1,height:36,border:"1px solid rgba(0,0,0,0.15)",borderRadius:8,padding:"0 10px"}}),h("button",{type:"button",disabled:!c,onClick:()=>void E(),style:{height:36,padding:"0 12px",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:c?"#111827":"#e5e7eb",color:c?"#ffffff":"#9ca3af",cursor:c?"pointer":"not-allowed"},children:"Send"})]}),l.length>0&&h("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:l.map((t,o)=>W("div",{style:{position:"relative"},children:[h("img",{src:t,alt:"selected",style:{width:64,height:48,objectFit:"cover",borderRadius:6,border:"1px solid rgba(0,0,0,0.06)"}}),h("button",{type:"button",onClick:()=>v(o),"aria-label":"Remove image",style:{position:"absolute",top:-6,right:-6,width:20,height:20,borderRadius:9999,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer"},children:"\xD7"})]},o))})]})]})};export{G as CHAT_STORAGE_PREFIX,pe as ChatEnabled,He as DefaultChatbot,ae as FloatingWindow,Pe as clearAllConversations,_e as clearConversation,me as getConversationStorageKey};
//# sourceMappingURL=index.js.map