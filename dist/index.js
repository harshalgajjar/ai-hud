import q,{useEffect as ce,useMemo as de,useRef as Z,useState as Q}from"react";import ue from"html2canvas";import{useEffect as le,useRef as ne,useState as J}from"react";import{jsx as Y,jsxs as V}from"react/jsx-runtime";var G=({children:u,title:g,onClose:f,position:y="bottom-right",width:w=360,height:_=480,minWidth:k=280,minHeight:H=240,offset:T=16,zIndex:B=1e3,className:P,style:X,headerClassName:M,bodyClassName:F,closeButtonAriaLabel:K="Close",closeOnEscape:x=!0,draggable:C=!0,anchorRect:l})=>{let[b,v]=J(!1),d=ne(null),[O,I]=J(!1),p=ne(null),[A,R]=J(null);le(()=>{if(!x)return;let s=i=>{i.key==="Escape"&&f?.()};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[x,f]);let $=(()=>{let s=`${T}px`;switch(y){case"top-left":return{top:s,left:s};case"top-right":return{top:s,right:s};case"bottom-left":return{bottom:s,left:s};case"bottom-right":default:return{bottom:s,right:s}}})(),L=(()=>{if(y!=="auto"||!l)return null;let s=window.innerWidth,i=window.innerHeight,e=T,t=l.top<i/2,n=l.left>s/2,o=t?["bottom","top"]:["top","bottom"],a=n?["right","left"]:["left","right"],h=[`${o[0]}-${a[0]}`,`${o[0]}-${a[1]}`,`${o[1]}-${a[0]}`,`${o[1]}-${a[1]}`];for(let r of h){let E=0,S=0;if(r==="bottom-right"?(E=l.bottom+e,S=l.right-w):r==="bottom-left"?(E=l.bottom+e,S=l.left):r==="top-right"?(E=l.top-_-e,S=l.right-w):(E=l.top-_-e,S=l.left),E>=0&&S>=0&&E+_<=i&&S+w<=s)return{top:E,left:S}}let D=Math.min(Math.max(l.bottom+e,0),i-_),c=Math.min(Math.max(l.right-w,0),s-w);return{top:D,left:c}})(),W=s=>{if(!C)return;let i=d.current;if(!i)return;let e=i.getBoundingClientRect();p.current={x:s.clientX,y:s.clientY,top:e.top,left:e.left},R({top:e.top,left:e.left}),I(!0);let t=o=>{if(!p.current)return;let a=o.clientX-p.current.x,h=o.clientY-p.current.y;R({top:p.current.top+h,left:p.current.left+a})},n=()=>{I(!1),p.current=null,window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",n)};window.addEventListener("pointermove",t),window.addEventListener("pointerup",n,{once:!0})};return V("div",{ref:d,role:"dialog","aria-modal":"false",className:P,style:{position:"fixed",...A?{top:A.top,left:A.left}:L?{top:L.top,left:L.left}:$,width:w,height:_,minWidth:k,minHeight:H,zIndex:B,background:"#ffffff",border:"1px solid rgba(0,0,0,0.06)",borderRadius:12,boxShadow:"0 10px 30px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08)",display:"flex",flexDirection:"column",overflow:"hidden",userSelect:O?"none":void 0,...X},children:[V("div",{className:M,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 12px",borderBottom:"1px solid rgba(0,0,0,0.06)",background:"#f9fafb",cursor:C?"move":void 0},onPointerDown:W,children:[Y("div",{style:{fontWeight:600,color:"#111827"},children:g}),Y("button",{type:"button",onClick:f,"aria-label":K,onMouseEnter:()=>v(!0),onMouseLeave:()=>v(!1),style:{width:28,height:28,display:"inline-flex",alignItems:"center",justifyContent:"center",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer",color:b?"#ef4444":void 0,transition:"color 120ms ease"},children:V("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[Y("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),Y("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),Y("div",{className:F,style:{flex:1,overflow:"auto",background:"#ffffff"},children:u})]})};import{jsx as U,jsxs as fe}from"react/jsx-runtime";var oe=q.forwardRef(({children:u,onClick:g,label:f="Open chat",position:y="top-right",offset:w=8,icon:_,className:k,containerStyle:H,buttonClassName:T,buttonStyle:B,buttonSize:P=36,zIndex:X=10,disabled:M=!1,trigger:F,open:K,onOpenChange:x,renderButton:C,openWindowOnClick:l=!1,windowProps:b,windowContent:v},d)=>{let[O,I]=Q(!1),[p,A]=Q(!1),R=Z(null),$=Z(null),L=Z(null),[W,s]=Q(null),i=F??"hover",e=de(()=>{let c={position:"absolute"},r=`${w}px`;switch(y){case"top-left":return{...c,top:r,left:r};case"top-right":return{...c,top:r,right:r};case"bottom-left":return{...c,bottom:r,left:r};case"bottom-right":default:return{...c,bottom:r,right:r}}},[y,w]),t=i==="always"?!0:i==="manual"?!!K:O,n=c=>{x&&x(c)},o={onMouseEnter:i==="hover"?()=>{I(!0),n(!0)}:void 0,onMouseLeave:i==="hover"?()=>{I(!1),n(!1)}:void 0,onFocus:i==="focus"?()=>{I(!0),n(!0)}:void 0,onBlur:i==="focus"?()=>{I(!1),n(!1)}:void 0},a=!!b?.sendComponentImageAsContext;ce(()=>{p&&(async()=>{if(!a)return;let r=L.current;if(r)try{await new Promise(te=>requestAnimationFrame(()=>setTimeout(te,50)));let S=(await ue(r,{useCORS:!0,backgroundColor:null,scale:Math.min(2,Math.max(1,Math.ceil(r.offsetWidth/280)))})).toDataURL("image/png",.92);s(S)}catch{}})()},[p,a]);let h=c=>{R.current=c,typeof d=="function"?d(c):d&&typeof d=="object"&&(d.current=c)},D={type:"button","aria-label":f,onClick:c=>{g?.(c),!M&&l&&A(!0)},className:T,disabled:M,style:{...e,zIndex:X,width:P,height:P,borderRadius:9999,display:"flex",alignItems:"center",justifyContent:"center",border:"1px solid rgba(0,0,0,0.08)",background:M?"#f3f4f6":"white",color:M?"#9ca3af":void 0,boxShadow:"0 2px 6px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06)",cursor:M?"not-allowed":"pointer",transition:"opacity 120ms ease, transform 120ms ease",opacity:t?1:0,transform:t?"scale(1)":"scale(0.95)",pointerEvents:t?"auto":"none",...B},tabIndex:t?0:-1,"aria-hidden":t?void 0:!0,ref:h,visible:t};return fe("div",{className:k,style:{position:"relative",display:"inline-block",...H},...o,ref:$,children:[U("div",{ref:L,style:{display:"inline-block"},children:u}),C?C(D):U("button",{...D,children:_??U("svg",{xmlns:"http://www.w3.org/2000/svg",width:Math.max(12,Math.floor(P*.5)),height:Math.max(12,Math.floor(P*.5)),viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:U("path",{d:"M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"})})}),l&&p&&v&&U(G,{...b,onClose:()=>{b?.onClose?.(),A(!1),s(null)},anchorRect:b?.anchorRect??(R.current?R.current.getBoundingClientRect():null),children:(()=>{if(a){if(!W)return U("div",{style:{padding:12,color:"#6b7280",fontSize:14},children:"Loading..."});if(q.isValidElement(v)){let r=[...v.props?.contextImages??[],W];try{return q.cloneElement(v,{contextImages:r})}catch{return v}}}return v})()})]})});oe.displayName="ChatEnabled";import{useCallback as ee,useEffect as se,useMemo as me,useRef as ae,useState as z}from"react";import{ChatOpenAI as he}from"@langchain/openai";import{AIMessage as ye,HumanMessage as ie,SystemMessage as be}from"@langchain/core/messages";var j="ai-hud:default-chatbot:history:";function re(u){return`${j}${u}`}function ge(u){try{typeof window<"u"&&window.localStorage.removeItem(re(u))}catch{}}function pe(){try{if(typeof window>"u")return;let u=[];for(let g=0;g<window.localStorage.length;g++){let f=window.localStorage.key(g);f&&f.startsWith(j)&&u.push(f)}u.forEach(g=>window.localStorage.removeItem(g))}catch{}}import{jsx as m,jsxs as N}from"react/jsx-runtime";async function ve(u){return new Promise((g,f)=>{let y=new FileReader;y.onload=()=>g(y.result),y.onerror=f,y.readAsDataURL(u)})}var we=({model:u="gpt-4o-mini",placeholderApiKey:g,systemPrompt:f="You are a helpful assistant.",welcome:y="Hi! How can I help you today?",className:w,style:_,conversationId:k,context:H,contextImages:T,inputPlaceholder:B,inputValue:P})=>{let M=(e=>{if(e&&e!=="REPLACE_WITH_YOUR_OPENAI_API_KEY")return e;try{let t=globalThis||{};if(typeof t.AI_HUD_OPENAI_API_KEY=="string"&&t.AI_HUD_OPENAI_API_KEY)return t.AI_HUD_OPENAI_API_KEY;if(typeof t.__AI_HUD_OPENAI_API_KEY__=="string"&&t.__AI_HUD_OPENAI_API_KEY__)return t.__AI_HUD_OPENAI_API_KEY__}catch{}try{let t=globalThis.process;if(t&&t.env&&typeof t.env.AI_HUD_OPENAI_API_KEY=="string")return t.env.AI_HUD_OPENAI_API_KEY}catch{}return null})(g),F=ae(null);if(!k&&!F.current){let e=(()=>{try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`conv_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`})();F.current=e}let K=k??F.current,x=`${j}${K}`,[C,l]=z(()=>{try{let e=typeof window<"u"?window.localStorage.getItem(x):null;if(e){let t=JSON.parse(e);if(Array.isArray(t))return t}}catch{}return[{id:"welcome",role:"assistant",text:y}]}),[b,v]=z(()=>typeof P=="string"?P:""),[d,O]=z([]),[I,p]=z(!1),A=ae(null),R=ee(()=>{A.current?.scrollIntoView({behavior:"smooth"})},[]),$=async e=>{let t=Array.from(e.target.files||[]);if(t.length===0)return;let n=await Promise.all(t.map(ve));O(o=>[...o,...n]),e.target.value=""},L=e=>{O(t=>t.filter((n,o)=>o!==e))},W=ee((e,t)=>{let n=[];if(f&&n.push({role:"system",content:f}),typeof H<"u"){let o="";try{o=JSON.stringify(H)}catch{o=String(H)}n.push({role:"system",content:`Context: ${o}`})}if(Array.isArray(T)&&T.length>0){let o=T.filter(a=>typeof a=="string"&&(a.startsWith("data:image/")||a.startsWith("http")));if(o.length>0){let a=[{type:"text",text:"Context images"},...o.map(h=>({type:"image_url",image_url:{url:h}}))];n.push({role:"user",content:a})}}for(let o of e)if(o.role==="assistant")n.push({role:"assistant",content:o.text||""});else if((o.images?.length||0)>0){let a=[{type:"text",text:o.text||""},...o.images.map(h=>({type:"image_url",image_url:{url:h}}))];n.push({role:"user",content:a})}else n.push({role:"user",content:o.text||""});if(t)if(t.images.length>0){let o=[{type:"text",text:t.text},...t.images.map(a=>({type:"image_url",image_url:{url:a}}))];n.push({role:"user",content:o})}else n.push({role:"user",content:t.text});return console.log("result",n),n},[f,H]),s=ee(async()=>{let e=b.trim();if(!e&&d.length===0)return;let t={id:String(Date.now()),role:"user",text:e||void 0,images:d.length?d:void 0};l(n=>[...n,t]),v(""),O([]),p(!0);try{let n=[],o=W(C,{text:t.text||"",images:t.images||[]});for(let r of o)if(r.role==="system")n.push(new be(r.content));else if(r.role==="assistant")n.push(new ye(r.content));else if(r.role==="user"){let E=r.content;Array.isArray(E)?n.push(new ie({content:E})):n.push(new ie(r.content))}let h=await new he({modelName:u,temperature:.7,apiKey:M??void 0}).invoke(n),D=typeof h.content=="string"?h.content:JSON.stringify(h.content),c={id:String(Date.now()+1),role:"assistant",text:typeof D=="string"?D:String(D)};l(r=>[...r,c]),setTimeout(R,0)}catch(n){let o={id:String(Date.now()+1),role:"assistant",text:`Error: ${n?.message||"Failed to contact OpenAI"}`};l(a=>[...a,o])}finally{p(!1)}},[W,b,C,d,g,u,R]),i=me(()=>(b.trim().length>0||d.length>0)&&!I,[b,d.length,I]);return se(()=>{try{typeof window<"u"&&window.localStorage.setItem(x,JSON.stringify(C))}catch{}},[C,x]),se(()=>()=>{if(!k)try{typeof window<"u"&&window.localStorage.removeItem(x)}catch{}},[k,x]),N("div",{className:w,style:{display:"flex",flexDirection:"column",height:"100%",..._},children:[N("div",{style:{flex:1,overflow:"auto",padding:12,background:"#ffffff"},children:[C.map(e=>m("div",{style:{marginBottom:10,display:"flex",justifyContent:e.role==="user"?"flex-end":"flex-start"},children:N("div",{style:{maxWidth:"80%",padding:"8px 10px",borderRadius:10,border:"1px solid rgba(0,0,0,0.06)",background:e.role==="user"?"#111827":"#f3f4f6",color:e.role==="user"?"#ffffff":"#111827",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:[e.text,e.images&&e.images.length>0&&m("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:e.images.map((t,n)=>m("img",{src:t,alt:"upload",style:{width:96,height:72,objectFit:"cover",borderRadius:8,border:"1px solid rgba(0,0,0,0.06)"}},n))})]})},e.id)),m("div",{ref:A})]}),N("div",{style:{padding:12,borderTop:"1px solid rgba(0,0,0,0.06)",background:"#fafafa"},children:[N("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[m("input",{type:"file",accept:"image/*",multiple:!0,onChange:$,style:{display:"none"},id:"ai-hud-chatbot-file"}),m("label",{htmlFor:"ai-hud-chatbot-file",children:m("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:36,height:36,border:"1px solid rgba(0,0,0,0.08)",borderRadius:8,background:"white",cursor:"pointer"},children:N("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[m("path",{d:"M18.5 12.5l-5 5-3-3-5 5"}),m("path",{d:"M20 7a4 4 0 0 0-8 0v10a4 4 0 0 0 8 0Z"})]})})}),m("input",{value:b,onChange:e=>v(e.target.value),placeholder:B??"Type a message...",onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),i&&s())},style:{flex:1,height:36,border:"1px solid rgba(0,0,0,0.15)",borderRadius:8,padding:"0 10px"}}),m("button",{type:"button",disabled:!i,onClick:()=>void s(),style:{height:36,padding:"0 12px",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:i?"#111827":"#e5e7eb",color:i?"#ffffff":"#9ca3af",cursor:i?"pointer":"not-allowed"},children:"Send"})]}),d.length>0&&m("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:d.map((e,t)=>N("div",{style:{position:"relative"},children:[m("img",{src:e,alt:"selected",style:{width:64,height:48,objectFit:"cover",borderRadius:6,border:"1px solid rgba(0,0,0,0.06)"}}),m("button",{type:"button",onClick:()=>L(t),"aria-label":"Remove image",style:{position:"absolute",top:-6,right:-6,width:20,height:20,borderRadius:9999,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer"},children:"\xD7"})]},t))})]})]})};export{j as CHAT_STORAGE_PREFIX,oe as ChatEnabled,we as DefaultChatbot,G as FloatingWindow,pe as clearAllConversations,ge as clearConversation,re as getConversationStorageKey};
//# sourceMappingURL=index.js.map