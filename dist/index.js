import le,{useEffect as Ce,useMemo as Ee,useRef as ce,useState as ue}from"react";import Ie from"html2canvas";import{useEffect as xe,useRef as fe,useState as se}from"react";import{jsx as q,jsxs as ae}from"react/jsx-runtime";var ie=({children:d,title:p,onClose:g,position:w="bottom-right",width:I=360,height:P=480,minWidth:L=280,minHeight:O=240,offset:D=16,zIndex:z=1e3,className:M,style:N,headerClassName:R,bodyClassName:Q,closeButtonAriaLabel:X="Close",closeOnEscape:S=!0,draggable:W=!0,anchorRect:a})=>{let[x,m]=se(!1),y=fe(null),[$,l]=se(!1),f=fe(null),[k,T]=se(null);xe(()=>{if(!S)return;let r=i=>{i.key==="Escape"&&g?.()};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[S,g]);let B=(()=>{let r=`${D}px`;switch(w){case"top-left":return{top:r,left:r};case"top-right":return{top:r,right:r};case"bottom-left":return{bottom:r,left:r};case"bottom-right":default:return{bottom:r,right:r}}})(),H=(()=>{if(w!=="auto"||!a)return null;let r=window.innerWidth,i=window.innerHeight,h=D,v=a.top<i/2,C=a.left>r/2,E=v?["bottom","top"]:["top","bottom"],c=C?["right","left"]:["left","right"],t=[`${E[0]}-${c[0]}`,`${E[0]}-${c[1]}`,`${E[1]}-${c[0]}`,`${E[1]}-${c[1]}`];for(let n of t){let s=0,u=0;if(n==="bottom-right"?(s=a.bottom+h,u=a.right-I):n==="bottom-left"?(s=a.bottom+h,u=a.left):n==="top-right"?(s=a.top-P-h,u=a.right-I):(s=a.top-P-h,u=a.left),s>=0&&u>=0&&s+P<=i&&u+I<=r)return{top:s,left:u}}let o=Math.min(Math.max(a.bottom+h,0),i-P),e=Math.min(Math.max(a.right-I,0),r-I);return{top:o,left:e}})(),K=r=>{if(!W)return;let i=y.current;if(!i)return;let h=i.getBoundingClientRect();f.current={x:r.clientX,y:r.clientY,top:h.top,left:h.left},T({top:h.top,left:h.left}),l(!0);let v=E=>{if(!f.current)return;let c=E.clientX-f.current.x,t=E.clientY-f.current.y;T({top:f.current.top+t,left:f.current.left+c})},C=()=>{l(!1),f.current=null,window.removeEventListener("pointermove",v),window.removeEventListener("pointerup",C)};window.addEventListener("pointermove",v),window.addEventListener("pointerup",C,{once:!0})};return ae("div",{ref:y,role:"dialog","aria-modal":"false",className:M,style:{position:"fixed",...k?{top:k.top,left:k.left}:H?{top:H.top,left:H.left}:B,width:I,height:P,minWidth:L,minHeight:O,zIndex:z,background:"#ffffff",border:"1px solid rgba(0,0,0,0.06)",borderRadius:12,boxShadow:"0 10px 30px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08)",display:"flex",flexDirection:"column",overflow:"hidden",userSelect:$?"none":void 0,...N},children:[ae("div",{className:R,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 12px",borderBottom:"1px solid rgba(0,0,0,0.06)",background:"#f9fafb",cursor:W?"move":void 0},onPointerDown:K,children:[q("div",{style:{fontWeight:600,color:"#111827"},children:p}),q("button",{type:"button",onClick:g,"aria-label":X,onMouseEnter:()=>m(!0),onMouseLeave:()=>m(!1),style:{width:28,height:28,display:"inline-flex",alignItems:"center",justifyContent:"center",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer",color:x?"#ef4444":void 0,transition:"color 120ms ease"},children:ae("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[q("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),q("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),q("div",{className:Q,style:{flex:1,overflow:"auto",background:"#ffffff"},children:d})]})};import{jsx as J,jsxs as _e}from"react/jsx-runtime";var pe=le.forwardRef(({children:d,onClick:p,label:g="Open chat",position:w="top-right",offset:I=8,icon:P,className:L,containerStyle:O,buttonClassName:D,buttonStyle:z,buttonSize:M=36,zIndex:N=10,disabled:R=!1,trigger:Q,open:X,onOpenChange:S,renderButton:W,openWindowOnClick:a=!1,windowProps:x,windowContent:m},y)=>{let[$,l]=ue(!1),[f,k]=ue(!1),T=ce(null),B=ce(null),H=ce(null),[K,r]=ue(null),i=Q??"hover",h=Ee(()=>{let e={position:"absolute"},n=`${I}px`;switch(w){case"top-left":return{...e,top:n,left:n};case"top-right":return{...e,top:n,right:n};case"bottom-left":return{...e,bottom:n,left:n};case"bottom-right":default:return{...e,bottom:n,right:n}}},[w,I]),v=i==="always"?!0:i==="manual"?!!X:$,C=e=>{S&&S(e)},E={onMouseEnter:i==="hover"?()=>{l(!0),C(!0)}:void 0,onMouseLeave:i==="hover"?()=>{l(!1),C(!1)}:void 0,onFocus:i==="focus"?()=>{l(!0),C(!0)}:void 0,onBlur:i==="focus"?()=>{l(!1),C(!1)}:void 0},c=!!x?.sendComponentImageAsContext;Ce(()=>{f&&(async()=>{if(!c)return;let n=H.current;if(n)try{await new Promise(_=>requestAnimationFrame(()=>setTimeout(_,50)));let u=(await Ie(n,{useCORS:!0,backgroundColor:null,scale:Math.min(2,Math.max(1,Math.ceil(n.offsetWidth/280)))})).toDataURL("image/png",.92);r(u)}catch{}})()},[f,c]);let t=e=>{T.current=e,typeof y=="function"?y(e):y&&typeof y=="object"&&(y.current=e)},o={type:"button","aria-label":g,onClick:e=>{p?.(e),!R&&a&&k(!0)},className:D,disabled:R,style:{...h,zIndex:N,width:M,height:M,borderRadius:9999,display:"flex",alignItems:"center",justifyContent:"center",border:"1px solid rgba(0,0,0,0.08)",background:R?"#f3f4f6":"white",color:R?"#9ca3af":void 0,boxShadow:"0 2px 6px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06)",cursor:R?"not-allowed":"pointer",transition:"opacity 120ms ease, transform 120ms ease",opacity:v?1:0,transform:v?"scale(1)":"scale(0.95)",pointerEvents:v?"auto":"none",...z},tabIndex:v?0:-1,"aria-hidden":v?void 0:!0,ref:t,visible:v};return _e("div",{className:L,style:{position:"relative",display:"inline-block",...O},...E,ref:B,children:[J("div",{ref:H,style:{display:"inline-block"},children:d}),W?W(o):J("button",{...o,children:P??J("svg",{xmlns:"http://www.w3.org/2000/svg",width:Math.max(12,Math.floor(M*.5)),height:Math.max(12,Math.floor(M*.5)),viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:J("path",{d:"M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"})})}),a&&f&&m&&J(ie,{...x,onClose:()=>{x?.onClose?.(),k(!1),r(null)},anchorRect:x?.anchorRect??(T.current?T.current.getBoundingClientRect():null),children:(()=>{if(c){if(!K)return J("div",{style:{padding:12,color:"#6b7280",fontSize:14},children:"Loading..."});if(le.isValidElement(m)){let n=[...m.props?.contextImages??[],K];try{return le.cloneElement(m,{contextImages:n})}catch{return m}}}return m})()})]})});pe.displayName="ChatEnabled";import{useCallback as ne,useEffect as ye,useMemo as he,useRef as be,useState as oe}from"react";import{ChatOpenAI as Me}from"@langchain/openai";import{AIMessage as Re,HumanMessage as ve,SystemMessage as Se,ToolMessage as ke}from"@langchain/core/messages";var Z="ai-hud:default-chatbot:history:";function me(d){return`${Z}${d}`}function Ae(d){try{typeof window<"u"&&window.localStorage.removeItem(me(d))}catch{}}function Pe(){try{if(typeof window>"u")return;let d=[];for(let p=0;p<window.localStorage.length;p++){let g=window.localStorage.key(p);g&&g.startsWith(Z)&&d.push(g)}d.forEach(p=>window.localStorage.removeItem(p))}catch{}}import{jsx as b,jsxs as U}from"react/jsx-runtime";async function Te(d){return new Promise((p,g)=>{let w=new FileReader;w.onload=()=>p(w.result),w.onerror=g,w.readAsDataURL(d)})}var He=({model:d="gpt-4o-mini",placeholderApiKey:p,systemPrompt:g="You are a helpful assistant.",welcome:w="Hi! How can I help you today?",className:I,style:P,conversationId:L,context:O,contextImages:D,inputPlaceholder:z,inputValue:M,tools:N,toolMaxIterations:R=3})=>{let X=(t=>{if(t&&t!=="REPLACE_WITH_YOUR_OPENAI_API_KEY")return t;try{let o=globalThis||{};if(typeof o.AI_HUD_OPENAI_API_KEY=="string"&&o.AI_HUD_OPENAI_API_KEY)return o.AI_HUD_OPENAI_API_KEY;if(typeof o.__AI_HUD_OPENAI_API_KEY__=="string"&&o.__AI_HUD_OPENAI_API_KEY__)return o.__AI_HUD_OPENAI_API_KEY__}catch{}try{let o=globalThis.process;if(o&&o.env&&typeof o.env.AI_HUD_OPENAI_API_KEY=="string")return o.env.AI_HUD_OPENAI_API_KEY}catch{}return null})(p),S=be(null);if(!L&&!S.current){let t=(()=>{try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`conv_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`})();S.current=t}let W=L??S.current,a=`${Z}${W}`,[x,m]=oe(()=>{try{let t=typeof window<"u"?window.localStorage.getItem(a):null;if(t){let o=JSON.parse(t);if(Array.isArray(o))return o}}catch{}return[{id:"welcome",role:"assistant",text:w}]}),[y,$]=oe(()=>typeof M=="string"?M:""),[l,f]=oe([]),[k,T]=oe(!1),B=be(null),H=ne(()=>{B.current?.scrollIntoView({behavior:"smooth"})},[]),K=ne(t=>t?t.replace(/\\\(/g,"(").replace(/\\\)/g,")").replace(/\\times/g,"\xD7").replace(/\\n/g,`
`):"",[]),{toolSchemas:r,toolExecutors:i}=he(()=>{if(!Array.isArray(N))return{toolSchemas:[],toolExecutors:{}};let t=N.map(e=>({type:"function",function:{name:e.function.name,description:e.function.description??"",parameters:e.function.parameters??{type:"object",properties:{}}}})),o={};for(let e of N)o[e.function.name]=async n=>await e.execute(n);return{toolSchemas:t,toolExecutors:o}},[N]),h=async t=>{let o=Array.from(t.target.files||[]);if(o.length===0)return;let e=await Promise.all(o.map(Te));f(n=>[...n,...e]),t.target.value=""},v=t=>{f(o=>o.filter((e,n)=>n!==t))},C=ne((t,o)=>{let e=[];if(g&&e.push({role:"system",content:g}),typeof O<"u"){let n="";try{n=JSON.stringify(O)}catch{n=String(O)}e.push({role:"system",content:`Context: ${n}`})}if(Array.isArray(D)&&D.length>0){let n=D.filter(s=>typeof s=="string"&&(s.startsWith("data:image/")||s.startsWith("http")));if(n.length>0){let s=[{type:"text",text:"Context images"},...n.map(u=>({type:"image_url",image_url:{url:u}}))];e.push({role:"user",content:s})}}for(let n of t)if(n.role==="assistant")e.push({role:"assistant",content:n.text||""});else if((n.images?.length||0)>0){let s=[{type:"text",text:n.text||""},...n.images.map(u=>({type:"image_url",image_url:{url:u}}))];e.push({role:"user",content:s})}else e.push({role:"user",content:n.text||""});if(o)if(o.images.length>0){let n=[{type:"text",text:o.text},...o.images.map(s=>({type:"image_url",image_url:{url:s}}))];e.push({role:"user",content:n})}else e.push({role:"user",content:o.text});return console.log("result",e),e},[g,O]),E=ne(async()=>{let t=y.trim();if(!t&&l.length===0)return;let o={id:String(Date.now()),role:"user",text:t||void 0,images:l.length?l:void 0};m(e=>[...e,o]),$(""),f([]),T(!0);try{let e=[],n=C(x,{text:o.text||"",images:o.images||[]});for(let A of n)if(A.role==="system")e.push(new Se(A.content));else if(A.role==="assistant")e.push(new Re(A.content));else if(A.role==="user"){let V=A.content;Array.isArray(V)?e.push(new ve({content:V})):e.push(new ve(A.content))}let s=new Me({modelName:d,temperature:.7,apiKey:X??void 0}),u=r.length>0?s.bind({tools:r}):s,_=await u.invoke(e),de=0;for(;de<R&&Array.isArray(_.tool_calls)&&_.tool_calls.length>0&&r.length>0;){let A=_.tool_calls,V=[];for(let G of A){let Y=G.name??G.function?.name,ee=G.args??G.function?.arguments,j=ee;if(typeof ee=="string")try{j=JSON.parse(ee)}catch{j=ee}let ge=Y?i[Y]:void 0,F=`Tool '${Y}' not found`;try{ge&&(F=await ge(j))}catch(te){F=`Error from tool '${Y}': ${te?.message||String(te)}`}m(te=>[...te,{id:`${Date.now()}_${Y}`,role:"tool",text:`Called ${Y} with ${typeof j=="string"?j:JSON.stringify(j)}
\u2192 ${typeof F=="string"?F:JSON.stringify(F)}`}]),V.push(new ke({tool_call_id:G.id,content:typeof F=="string"?F:JSON.stringify(F)}))}e=[...e,_,...V],_=await u.invoke(e),de+=1}let re=typeof _.content=="string"?_.content:JSON.stringify(_.content),we={id:String(Date.now()+1),role:"assistant",text:typeof re=="string"?re:String(re)};m(A=>[...A,we]),setTimeout(H,0)}catch(e){let n={id:String(Date.now()+1),role:"assistant",text:`Error: ${e?.message||"Failed to contact OpenAI"}`};m(s=>[...s,n])}finally{T(!1)}},[C,y,x,l,p,d,H]),c=he(()=>(y.trim().length>0||l.length>0)&&!k,[y,l.length,k]);return ye(()=>{try{typeof window<"u"&&window.localStorage.setItem(a,JSON.stringify(x))}catch{}},[x,a]),ye(()=>()=>{if(!L)try{typeof window<"u"&&window.localStorage.removeItem(a)}catch{}},[L,a]),U("div",{className:I,style:{display:"flex",flexDirection:"column",height:"100%",...P},children:[U("div",{style:{flex:1,overflow:"auto",padding:12,background:"#ffffff"},children:[x.map(t=>b("div",{style:{marginBottom:10,display:"flex",justifyContent:t.role==="user"?"flex-end":"flex-start"},children:U("div",{style:{maxWidth:"80%",padding:"8px 10px",borderRadius:10,border:t.role==="tool"?"1px dashed rgba(0,0,0,0.2)":"1px solid rgba(0,0,0,0.06)",background:t.role==="user"?"#111827":t.role==="tool"?"#fff7ed":"#f3f4f6",color:t.role==="user"?"#ffffff":"#111827",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:[t.role==="assistant"?K(t.text):t.text,t.images&&t.images.length>0&&b("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:t.images.map((o,e)=>b("img",{src:o,alt:"upload",style:{width:96,height:72,objectFit:"cover",borderRadius:8,border:"1px solid rgba(0,0,0,0.06)"}},e))})]})},t.id)),b("div",{ref:B})]}),U("div",{style:{padding:12,borderTop:"1px solid rgba(0,0,0,0.06)",background:"#fafafa"},children:[U("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[b("input",{type:"file",accept:"image/*",multiple:!0,onChange:h,style:{display:"none"},id:"ai-hud-chatbot-file"}),b("label",{htmlFor:"ai-hud-chatbot-file",children:b("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:36,height:36,border:"1px solid rgba(0,0,0,0.08)",borderRadius:8,background:"white",cursor:"pointer"},children:U("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[b("path",{d:"M18.5 12.5l-5 5-3-3-5 5"}),b("path",{d:"M20 7a4 4 0 0 0-8 0v10a4 4 0 0 0 8 0Z"})]})})}),b("input",{value:y,onChange:t=>$(t.target.value),placeholder:z??"Type a message...",onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),c&&E())},style:{flex:1,height:36,border:"1px solid rgba(0,0,0,0.15)",borderRadius:8,padding:"0 10px"}}),b("button",{type:"button",disabled:!c,onClick:()=>void E(),style:{height:36,padding:"0 12px",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:c?"#111827":"#e5e7eb",color:c?"#ffffff":"#9ca3af",cursor:c?"pointer":"not-allowed"},children:"Send"})]}),l.length>0&&b("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:l.map((t,o)=>U("div",{style:{position:"relative"},children:[b("img",{src:t,alt:"selected",style:{width:64,height:48,objectFit:"cover",borderRadius:6,border:"1px solid rgba(0,0,0,0.06)"}}),b("button",{type:"button",onClick:()=>v(o),"aria-label":"Remove image",style:{position:"absolute",top:-6,right:-6,width:20,height:20,borderRadius:9999,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer"},children:"\xD7"})]},o))})]})]})};export{Z as CHAT_STORAGE_PREFIX,pe as ChatEnabled,He as DefaultChatbot,ie as FloatingWindow,Pe as clearAllConversations,Ae as clearConversation,me as getConversationStorageKey};
//# sourceMappingURL=index.js.map