import q,{useEffect as le,useMemo as de,useRef as Z,useState as Q}from"react";import ce from"html2canvas";import{useEffect as ie,useRef as ne,useState as J}from"react";import{jsx as Y,jsxs as V}from"react/jsx-runtime";var G=({children:u,title:p,onClose:f,position:b="bottom-right",width:w=360,height:_=480,minWidth:S=280,minHeight:k=240,offset:T=16,zIndex:B=1e3,className:P,style:z,headerClassName:E,bodyClassName:D,closeButtonAriaLabel:$="Close",closeOnEscape:x=!0,draggable:C=!0,anchorRect:i})=>{let[y,v]=J(!1),c=ne(null),[O,I]=J(!1),g=ne(null),[R,A]=J(null);ie(()=>{if(!x)return;let r=a=>{a.key==="Escape"&&f?.()};return window.addEventListener("keydown",r),()=>window.removeEventListener("keydown",r)},[x,f]);let K=(()=>{let r=`${T}px`;switch(b){case"top-left":return{top:r,left:r};case"top-right":return{top:r,right:r};case"bottom-left":return{bottom:r,left:r};case"bottom-right":default:return{bottom:r,right:r}}})(),L=(()=>{if(b!=="auto"||!i)return null;let r=window.innerWidth,a=window.innerHeight,e=T,t=i.top<a/2,o=i.left>r/2,n=t?["bottom","top"]:["top","bottom"],s=o?["right","left"]:["left","right"],h=[`${n[0]}-${s[0]}`,`${n[0]}-${s[1]}`,`${n[1]}-${s[0]}`,`${n[1]}-${s[1]}`];for(let d of h){let H=0,M=0;if(d==="bottom-right"?(H=i.bottom+e,M=i.right-w):d==="bottom-left"?(H=i.bottom+e,M=i.left):d==="top-right"?(H=i.top-_-e,M=i.right-w):(H=i.top-_-e,M=i.left),H>=0&&M>=0&&H+_<=a&&M+w<=r)return{top:H,left:M}}let N=Math.min(Math.max(i.bottom+e,0),a-_),l=Math.min(Math.max(i.right-w,0),r-w);return{top:N,left:l}})(),F=r=>{if(!C)return;let a=c.current;if(!a)return;let e=a.getBoundingClientRect();g.current={x:r.clientX,y:r.clientY,top:e.top,left:e.left},A({top:e.top,left:e.left}),I(!0);let t=n=>{if(!g.current)return;let s=n.clientX-g.current.x,h=n.clientY-g.current.y;A({top:g.current.top+h,left:g.current.left+s})},o=()=>{I(!1),g.current=null,window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",o)};window.addEventListener("pointermove",t),window.addEventListener("pointerup",o,{once:!0})};return V("div",{ref:c,role:"dialog","aria-modal":"false",className:P,style:{position:"fixed",...R?{top:R.top,left:R.left}:L?{top:L.top,left:L.left}:K,width:w,height:_,minWidth:S,minHeight:k,zIndex:B,background:"#ffffff",border:"1px solid rgba(0,0,0,0.06)",borderRadius:12,boxShadow:"0 10px 30px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08)",display:"flex",flexDirection:"column",overflow:"hidden",userSelect:O?"none":void 0,...z},children:[V("div",{className:E,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 12px",borderBottom:"1px solid rgba(0,0,0,0.06)",background:"#f9fafb",cursor:C?"move":void 0},onPointerDown:F,children:[Y("div",{style:{fontWeight:600,color:"#111827"},children:p}),Y("button",{type:"button",onClick:f,"aria-label":$,onMouseEnter:()=>v(!0),onMouseLeave:()=>v(!1),style:{width:28,height:28,display:"inline-flex",alignItems:"center",justifyContent:"center",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer",color:y?"#ef4444":void 0,transition:"color 120ms ease"},children:V("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[Y("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),Y("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),Y("div",{className:D,style:{flex:1,overflow:"auto",background:"#ffffff"},children:u})]})};import{jsx as U,jsxs as ue}from"react/jsx-runtime";var oe=q.forwardRef(({children:u,onClick:p,label:f="Open chat",position:b="top-right",offset:w=8,icon:_,className:S,containerStyle:k,buttonClassName:T,buttonStyle:B,buttonSize:P=36,zIndex:z=10,disabled:E=!1,trigger:D,open:$,onOpenChange:x,renderButton:C,openWindowOnClick:i=!1,windowProps:y,windowContent:v},c)=>{let[O,I]=Q(!1),[g,R]=Q(!1),A=Z(null),K=Z(null),L=Z(null),[F,r]=Q(null),a=D??"hover",e=de(()=>{let l={position:"absolute"},d=`${w}px`;switch(b){case"top-left":return{...l,top:d,left:d};case"top-right":return{...l,top:d,right:d};case"bottom-left":return{...l,bottom:d,left:d};case"bottom-right":default:return{...l,bottom:d,right:d}}},[b,w]),t=a==="always"?!0:a==="manual"?!!$:O,o=l=>{x&&x(l)},n={onMouseEnter:a==="hover"?()=>{I(!0),o(!0)}:void 0,onMouseLeave:a==="hover"?()=>{I(!1),o(!1)}:void 0,onFocus:a==="focus"?()=>{I(!0),o(!0)}:void 0,onBlur:a==="focus"?()=>{I(!1),o(!1)}:void 0},s=!!y?.sendComponentImageAsContext;le(()=>{g&&(async()=>{if(!s)return;let d=L.current;if(d)try{await new Promise(te=>requestAnimationFrame(()=>setTimeout(te,50)));let M=(await ce(d,{useCORS:!0,backgroundColor:null,scale:Math.min(2,Math.max(1,Math.ceil(d.offsetWidth/280)))})).toDataURL("image/png",.92);r(M)}catch{}})()},[g,s]);let h=l=>{A.current=l,typeof c=="function"?c(l):c&&typeof c=="object"&&(c.current=l)},N={type:"button","aria-label":f,onClick:l=>{p?.(l),!E&&i&&R(!0)},className:T,disabled:E,style:{...e,zIndex:z,width:P,height:P,borderRadius:9999,display:"flex",alignItems:"center",justifyContent:"center",border:"1px solid rgba(0,0,0,0.08)",background:E?"#f3f4f6":"white",color:E?"#9ca3af":void 0,boxShadow:"0 2px 6px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06)",cursor:E?"not-allowed":"pointer",transition:"opacity 120ms ease, transform 120ms ease",opacity:t?1:0,transform:t?"scale(1)":"scale(0.95)",pointerEvents:t?"auto":"none",...B},tabIndex:t?0:-1,"aria-hidden":t?void 0:!0,ref:h,visible:t};return ue("div",{className:S,style:{position:"relative",display:"inline-block",...k},...n,ref:K,children:[U("div",{ref:L,style:{display:"inline-block"},children:u}),C?C(N):U("button",{...N,children:_??U("svg",{xmlns:"http://www.w3.org/2000/svg",width:Math.max(12,Math.floor(P*.5)),height:Math.max(12,Math.floor(P*.5)),viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:U("path",{d:"M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"})})}),i&&g&&v&&U(G,{...y,onClose:()=>{y?.onClose?.(),R(!1),r(null)},anchorRect:y?.anchorRect??(A.current?A.current.getBoundingClientRect():null),children:(()=>{if(s){if(!F)return U("div",{style:{padding:12,color:"#6b7280",fontSize:14},children:"Loading..."});if(q.isValidElement(v)){let d=[...v.props?.contextImages??[],F];try{return q.cloneElement(v,{contextImages:d})}catch{return v}}}return v})()})]})});oe.displayName="ChatEnabled";import{useCallback as ee,useEffect as se,useMemo as ge,useRef as ae,useState as X}from"react";var j="ai-hud:default-chatbot:history:";function re(u){return`${j}${u}`}function fe(u){try{typeof window<"u"&&window.localStorage.removeItem(re(u))}catch{}}function pe(){try{if(typeof window>"u")return;let u=[];for(let p=0;p<window.localStorage.length;p++){let f=window.localStorage.key(p);f&&f.startsWith(j)&&u.push(f)}u.forEach(p=>window.localStorage.removeItem(p))}catch{}}import{jsx as m,jsxs as W}from"react/jsx-runtime";var me="https://api.openai.com/v1/chat/completions";async function he(u){return new Promise((p,f)=>{let b=new FileReader;b.onload=()=>p(b.result),b.onerror=f,b.readAsDataURL(u)})}var be=({model:u="gpt-4o-mini",placeholderApiKey:p,systemPrompt:f="You are a helpful assistant.",welcome:b="Hi! How can I help you today?",className:w,style:_,conversationId:S,context:k,contextImages:T,inputPlaceholder:B,inputValue:P})=>{let E=(e=>{if(e&&e!=="REPLACE_WITH_YOUR_OPENAI_API_KEY")return e;try{let t=globalThis||{};if(typeof t.AI_HUD_OPENAI_API_KEY=="string"&&t.AI_HUD_OPENAI_API_KEY)return t.AI_HUD_OPENAI_API_KEY;if(typeof t.__AI_HUD_OPENAI_API_KEY__=="string"&&t.__AI_HUD_OPENAI_API_KEY__)return t.__AI_HUD_OPENAI_API_KEY__}catch{}try{let t=globalThis.process;if(t&&t.env&&typeof t.env.AI_HUD_OPENAI_API_KEY=="string")return t.env.AI_HUD_OPENAI_API_KEY}catch{}return null})(p),D=ae(null);if(!S&&!D.current){let e=(()=>{try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`conv_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`})();D.current=e}let $=S??D.current,x=`${j}${$}`,[C,i]=X(()=>{try{let e=typeof window<"u"?window.localStorage.getItem(x):null;if(e){let t=JSON.parse(e);if(Array.isArray(t))return t}}catch{}return[{id:"welcome",role:"assistant",text:b}]}),[y,v]=X(()=>typeof P=="string"?P:""),[c,O]=X([]),[I,g]=X(!1),R=ae(null),A=ee(()=>{R.current?.scrollIntoView({behavior:"smooth"})},[]),K=async e=>{let t=Array.from(e.target.files||[]);if(t.length===0)return;let o=await Promise.all(t.map(he));O(n=>[...n,...o]),e.target.value=""},L=e=>{O(t=>t.filter((o,n)=>n!==e))},F=ee((e,t)=>{let o=[];if(f&&o.push({role:"system",content:f}),typeof k<"u"){let n="";try{n=JSON.stringify(k)}catch{n=String(k)}o.push({role:"system",content:`Context: ${n}`})}if(Array.isArray(T)&&T.length>0){let n=T.filter(s=>typeof s=="string"&&(s.startsWith("data:image/")||s.startsWith("http")));if(n.length>0){let s=[{type:"text",text:"Context images"},...n.map(h=>({type:"image_url",image_url:{url:h}}))];o.push({role:"user",content:s})}}for(let n of e)if(n.role==="assistant")o.push({role:"assistant",content:n.text||""});else if((n.images?.length||0)>0){let s=[{type:"text",text:n.text||""},...n.images.map(h=>({type:"image_url",image_url:{url:h}}))];o.push({role:"user",content:s})}else o.push({role:"user",content:n.text||""});if(t)if(t.images.length>0){let n=[{type:"text",text:t.text},...t.images.map(s=>({type:"image_url",image_url:{url:s}}))];o.push({role:"user",content:n})}else o.push({role:"user",content:t.text});return console.log("result",o),o},[f,k]),r=ee(async()=>{let e=y.trim();if(!e&&c.length===0)return;let t={id:String(Date.now()),role:"user",text:e||void 0,images:c.length?c:void 0};i(o=>[...o,t]),v(""),O([]),g(!0);try{let o=F(C,{text:t.text||"",images:t.images||[]}),n=await fetch(me,{method:"POST",headers:{"Content-Type":"application/json",...E?{Authorization:`Bearer ${E}`}:{}},body:JSON.stringify({model:u,messages:o,temperature:.7})});if(!n.ok)throw new Error(`OpenAI error: ${n.status}`);let h=(await n.json())?.choices?.[0]?.message?.content??"",N={id:String(Date.now()+1),role:"assistant",text:typeof h=="string"?h:String(h)};i(l=>[...l,N]),setTimeout(A,0)}catch(o){let n={id:String(Date.now()+1),role:"assistant",text:`Error: ${o?.message||"Failed to contact OpenAI"}`};i(s=>[...s,n])}finally{g(!1)}},[F,y,C,c,p,u,A]),a=ge(()=>(y.trim().length>0||c.length>0)&&!I,[y,c.length,I]);return se(()=>{try{typeof window<"u"&&window.localStorage.setItem(x,JSON.stringify(C))}catch{}},[C,x]),se(()=>()=>{if(!S)try{typeof window<"u"&&window.localStorage.removeItem(x)}catch{}},[S,x]),W("div",{className:w,style:{display:"flex",flexDirection:"column",height:"100%",..._},children:[W("div",{style:{flex:1,overflow:"auto",padding:12,background:"#ffffff"},children:[C.map(e=>m("div",{style:{marginBottom:10,display:"flex",justifyContent:e.role==="user"?"flex-end":"flex-start"},children:W("div",{style:{maxWidth:"80%",padding:"8px 10px",borderRadius:10,border:"1px solid rgba(0,0,0,0.06)",background:e.role==="user"?"#111827":"#f3f4f6",color:e.role==="user"?"#ffffff":"#111827",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:[e.text,e.images&&e.images.length>0&&m("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:e.images.map((t,o)=>m("img",{src:t,alt:"upload",style:{width:96,height:72,objectFit:"cover",borderRadius:8,border:"1px solid rgba(0,0,0,0.06)"}},o))})]})},e.id)),m("div",{ref:R})]}),W("div",{style:{padding:12,borderTop:"1px solid rgba(0,0,0,0.06)",background:"#fafafa"},children:[W("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[m("input",{type:"file",accept:"image/*",multiple:!0,onChange:K,style:{display:"none"},id:"ai-hud-chatbot-file"}),m("label",{htmlFor:"ai-hud-chatbot-file",children:m("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:36,height:36,border:"1px solid rgba(0,0,0,0.08)",borderRadius:8,background:"white",cursor:"pointer"},children:W("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[m("path",{d:"M18.5 12.5l-5 5-3-3-5 5"}),m("path",{d:"M20 7a4 4 0 0 0-8 0v10a4 4 0 0 0 8 0Z"})]})})}),m("input",{value:y,onChange:e=>v(e.target.value),placeholder:B??"Type a message...",onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),a&&r())},style:{flex:1,height:36,border:"1px solid rgba(0,0,0,0.15)",borderRadius:8,padding:"0 10px"}}),m("button",{type:"button",disabled:!a,onClick:()=>void r(),style:{height:36,padding:"0 12px",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:a?"#111827":"#e5e7eb",color:a?"#ffffff":"#9ca3af",cursor:a?"pointer":"not-allowed"},children:"Send"})]}),c.length>0&&m("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:c.map((e,t)=>W("div",{style:{position:"relative"},children:[m("img",{src:e,alt:"selected",style:{width:64,height:48,objectFit:"cover",borderRadius:6,border:"1px solid rgba(0,0,0,0.06)"}}),m("button",{type:"button",onClick:()=>L(t),"aria-label":"Remove image",style:{position:"absolute",top:-6,right:-6,width:20,height:20,borderRadius:9999,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer"},children:"\xD7"})]},t))})]})]})};export{j as CHAT_STORAGE_PREFIX,oe as ChatEnabled,be as DefaultChatbot,G as FloatingWindow,pe as clearAllConversations,fe as clearConversation,re as getConversationStorageKey};
//# sourceMappingURL=index.js.map