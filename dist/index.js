import ae,{useEffect as xe,useMemo as Ce,useRef as ie,useState as le}from"react";import Ee from"html2canvas";import{useEffect as we,useRef as de,useState as oe}from"react";import{jsx as V,jsxs as re}from"react/jsx-runtime";var se=({children:u,title:m,onClose:f,position:x="bottom-right",width:I=360,height:A=480,minWidth:H=280,minHeight:L=240,offset:O=16,zIndex:K=1e3,className:M,style:N,headerClassName:P,bodyClassName:q,closeButtonAriaLabel:Y="Close",closeOnEscape:R=!0,draggable:F=!0,anchorRect:a})=>{let[C,w]=oe(!1),y=de(null),[U,c]=oe(!1),d=de(null),[S,k]=oe(null);we(()=>{if(!R)return;let s=l=>{l.key==="Escape"&&f?.()};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[R,f]);let B=(()=>{let s=`${O}px`;switch(x){case"top-left":return{top:s,left:s};case"top-right":return{top:s,right:s};case"bottom-left":return{bottom:s,left:s};case"bottom-right":default:return{bottom:s,right:s}}})(),T=(()=>{if(x!=="auto"||!a)return null;let s=window.innerWidth,l=window.innerHeight,h=O,b=a.top<l/2,E=a.left>s/2,g=b?["bottom","top"]:["top","bottom"],t=E?["right","left"]:["left","right"],n=[`${g[0]}-${t[0]}`,`${g[0]}-${t[1]}`,`${g[1]}-${t[0]}`,`${g[1]}-${t[1]}`];for(let r of n){let p=0,i=0;if(r==="bottom-right"?(p=a.bottom+h,i=a.right-I):r==="bottom-left"?(p=a.bottom+h,i=a.left):r==="top-right"?(p=a.top-A-h,i=a.right-I):(p=a.top-A-h,i=a.left),p>=0&&i>=0&&p+A<=l&&i+I<=s)return{top:p,left:i}}let e=Math.min(Math.max(a.bottom+h,0),l-A),o=Math.min(Math.max(a.right-I,0),s-I);return{top:e,left:o}})(),D=s=>{if(!F)return;let l=y.current;if(!l)return;let h=l.getBoundingClientRect();d.current={x:s.clientX,y:s.clientY,top:h.top,left:h.left},k({top:h.top,left:h.left}),c(!0);let b=g=>{if(!d.current)return;let t=g.clientX-d.current.x,n=g.clientY-d.current.y;k({top:d.current.top+n,left:d.current.left+t})},E=()=>{c(!1),d.current=null,window.removeEventListener("pointermove",b),window.removeEventListener("pointerup",E)};window.addEventListener("pointermove",b),window.addEventListener("pointerup",E,{once:!0})};return re("div",{ref:y,role:"dialog","aria-modal":"false",className:M,style:{position:"fixed",...S?{top:S.top,left:S.left}:T?{top:T.top,left:T.left}:B,width:I,height:A,minWidth:H,minHeight:L,zIndex:K,background:"#ffffff",border:"1px solid rgba(0,0,0,0.06)",borderRadius:12,boxShadow:"0 10px 30px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08)",display:"flex",flexDirection:"column",overflow:"hidden",userSelect:U?"none":void 0,...N},children:[re("div",{className:P,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 12px",borderBottom:"1px solid rgba(0,0,0,0.06)",background:"#f9fafb",cursor:F?"move":void 0},onPointerDown:D,children:[V("div",{style:{fontWeight:600,color:"#111827"},children:m}),V("button",{type:"button",onClick:f,"aria-label":Y,onMouseEnter:()=>w(!0),onMouseLeave:()=>w(!1),style:{width:28,height:28,display:"inline-flex",alignItems:"center",justifyContent:"center",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer",color:C?"#ef4444":void 0,transition:"color 120ms ease"},children:re("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[V("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),V("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),V("div",{className:q,style:{flex:1,overflow:"auto",background:"#ffffff"},children:u})]})};import{jsx as $,jsxs as Ie}from"react/jsx-runtime";var ge=ae.forwardRef(({children:u,onClick:m,label:f="Open chat",position:x="top-right",offset:I=8,icon:A,className:H,containerStyle:L,buttonClassName:O,buttonStyle:K,buttonSize:M=36,zIndex:N=10,disabled:P=!1,trigger:q,open:Y,onOpenChange:R,renderButton:F,openWindowOnClick:a=!1,windowProps:C,windowContent:w},y)=>{let[U,c]=le(!1),[d,S]=le(!1),k=ie(null),B=ie(null),T=ie(null),[D,s]=le(null),l=q??"hover",h=Ce(()=>{let o={position:"absolute"},r=`${I}px`;switch(x){case"top-left":return{...o,top:r,left:r};case"top-right":return{...o,top:r,right:r};case"bottom-left":return{...o,bottom:r,left:r};case"bottom-right":default:return{...o,bottom:r,right:r}}},[x,I]),b=l==="always"?!0:l==="manual"?!!Y:U,E=o=>{R&&R(o)},g={onMouseEnter:l==="hover"?()=>{c(!0),E(!0)}:void 0,onMouseLeave:l==="hover"?()=>{c(!1),E(!1)}:void 0,onFocus:l==="focus"?()=>{c(!0),E(!0)}:void 0,onBlur:l==="focus"?()=>{c(!1),E(!1)}:void 0},t=!!C?.sendComponentImageAsContext;xe(()=>{d&&(async()=>{if(!t)return;let r=T.current;if(r)try{await new Promise(j=>requestAnimationFrame(()=>setTimeout(j,50)));let i=(await Ee(r,{useCORS:!0,backgroundColor:null,scale:Math.min(2,Math.max(1,Math.ceil(r.offsetWidth/280)))})).toDataURL("image/png",.92);s(i)}catch{}})()},[d,t]);let n=o=>{k.current=o,typeof y=="function"?y(o):y&&typeof y=="object"&&(y.current=o)},e={type:"button","aria-label":f,onClick:o=>{m?.(o),!P&&a&&S(!0)},className:O,disabled:P,style:{...h,zIndex:N,width:M,height:M,borderRadius:9999,display:"flex",alignItems:"center",justifyContent:"center",border:"1px solid rgba(0,0,0,0.08)",background:P?"#f3f4f6":"white",color:P?"#9ca3af":void 0,boxShadow:"0 2px 6px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06)",cursor:P?"not-allowed":"pointer",transition:"opacity 120ms ease, transform 120ms ease",opacity:b?1:0,transform:b?"scale(1)":"scale(0.95)",pointerEvents:b?"auto":"none",...K},tabIndex:b?0:-1,"aria-hidden":b?void 0:!0,ref:n,visible:b};return Ie("div",{className:H,style:{position:"relative",display:"inline-block",...L},...g,ref:B,children:[$("div",{ref:T,style:{display:"inline-block"},children:u}),F?F(e):$("button",{...e,children:A??$("svg",{xmlns:"http://www.w3.org/2000/svg",width:Math.max(12,Math.floor(M*.5)),height:Math.max(12,Math.floor(M*.5)),viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:$("path",{d:"M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"})})}),a&&d&&w&&$(se,{...C,onClose:()=>{C?.onClose?.(),S(!1),s(null)},anchorRect:C?.anchorRect??(k.current?k.current.getBoundingClientRect():null),children:(()=>{if(t){if(!D)return $("div",{style:{padding:12,color:"#6b7280",fontSize:14},children:"Loading..."});if(ae.isValidElement(w)){let r=[...w.props?.contextImages??[],D];try{return ae.cloneElement(w,{contextImages:r})}catch{return w}}}return w})()})]})});ge.displayName="ChatEnabled";import{useCallback as ce,useEffect as me,useMemo as ye,useRef as he,useState as ee}from"react";import{ChatOpenAI as Me}from"@langchain/openai";import{AIMessage as Pe,HumanMessage as be,SystemMessage as Re,ToolMessage as Se}from"@langchain/core/messages";var G="ai-hud:default-chatbot:history:";function pe(u){return`${G}${u}`}function _e(u){try{typeof window<"u"&&window.localStorage.removeItem(pe(u))}catch{}}function Ae(){try{if(typeof window>"u")return;let u=[];for(let m=0;m<window.localStorage.length;m++){let f=window.localStorage.key(m);f&&f.startsWith(G)&&u.push(f)}u.forEach(m=>window.localStorage.removeItem(m))}catch{}}import{jsx as v,jsxs as W}from"react/jsx-runtime";async function ke(u){return new Promise((m,f)=>{let x=new FileReader;x.onload=()=>m(x.result),x.onerror=f,x.readAsDataURL(u)})}var Te=({model:u="gpt-4o-mini",placeholderApiKey:m,systemPrompt:f="You are a helpful assistant.",welcome:x="Hi! How can I help you today?",className:I,style:A,conversationId:H,context:L,contextImages:O,inputPlaceholder:K,inputValue:M,tools:N,toolMaxIterations:P=3})=>{let Y=(t=>{if(t&&t!=="REPLACE_WITH_YOUR_OPENAI_API_KEY")return t;try{let n=globalThis||{};if(typeof n.AI_HUD_OPENAI_API_KEY=="string"&&n.AI_HUD_OPENAI_API_KEY)return n.AI_HUD_OPENAI_API_KEY;if(typeof n.__AI_HUD_OPENAI_API_KEY__=="string"&&n.__AI_HUD_OPENAI_API_KEY__)return n.__AI_HUD_OPENAI_API_KEY__}catch{}try{let n=globalThis.process;if(n&&n.env&&typeof n.env.AI_HUD_OPENAI_API_KEY=="string")return n.env.AI_HUD_OPENAI_API_KEY}catch{}return null})(m),R=he(null);if(!H&&!R.current){let t=(()=>{try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`conv_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`})();R.current=t}let F=H??R.current,a=`${G}${F}`,[C,w]=ee(()=>{try{let t=typeof window<"u"?window.localStorage.getItem(a):null;if(t){let n=JSON.parse(t);if(Array.isArray(n))return n}}catch{}return[{id:"welcome",role:"assistant",text:x}]}),[y,U]=ee(()=>typeof M=="string"?M:""),[c,d]=ee([]),[S,k]=ee(!1),B=he(null),T=ce(()=>{B.current?.scrollIntoView({behavior:"smooth"})},[]),{toolSchemas:D,toolExecutors:s}=ye(()=>{let t=[],n={};if(Array.isArray(N)){for(let e of N)if(e){if(e.type==="function"&&e.function&&e.function.name){t.push({type:"function",function:e.function});let o=e.function.name;typeof e.invoke=="function"?n[o]=e.invoke.bind(e):typeof e.call=="function"?n[o]=e.call.bind(e):typeof e.func=="function"&&(n[o]=e.func.bind(e))}else if(e.type==="function"&&e.name){let o={name:e.name,description:e.description??"",parameters:e.parameters??{type:"object",properties:{}}};t.push({type:"function",function:o}),typeof e.invoke=="function"?n[e.name]=e.invoke.bind(e):typeof e.call=="function"?n[e.name]=e.call.bind(e):typeof e.func=="function"&&(n[e.name]=e.func.bind(e))}}}return{toolSchemas:t,toolExecutors:n}},[N]),l=async t=>{let n=Array.from(t.target.files||[]);if(n.length===0)return;let e=await Promise.all(n.map(ke));d(o=>[...o,...e]),t.target.value=""},h=t=>{d(n=>n.filter((e,o)=>o!==t))},b=ce((t,n)=>{let e=[];if(f&&e.push({role:"system",content:f}),typeof L<"u"){let o="";try{o=JSON.stringify(L)}catch{o=String(L)}e.push({role:"system",content:`Context: ${o}`})}if(Array.isArray(O)&&O.length>0){let o=O.filter(r=>typeof r=="string"&&(r.startsWith("data:image/")||r.startsWith("http")));if(o.length>0){let r=[{type:"text",text:"Context images"},...o.map(p=>({type:"image_url",image_url:{url:p}}))];e.push({role:"user",content:r})}}for(let o of t)if(o.role==="assistant")e.push({role:"assistant",content:o.text||""});else if((o.images?.length||0)>0){let r=[{type:"text",text:o.text||""},...o.images.map(p=>({type:"image_url",image_url:{url:p}}))];e.push({role:"user",content:r})}else e.push({role:"user",content:o.text||""});if(n)if(n.images.length>0){let o=[{type:"text",text:n.text},...n.images.map(r=>({type:"image_url",image_url:{url:r}}))];e.push({role:"user",content:o})}else e.push({role:"user",content:n.text});return console.log("result",e),e},[f,L]),E=ce(async()=>{let t=y.trim();if(!t&&c.length===0)return;let n={id:String(Date.now()),role:"user",text:t||void 0,images:c.length?c:void 0};w(e=>[...e,n]),U(""),d([]),k(!0);try{let e=[],o=b(C,{text:n.text||"",images:n.images||[]});for(let _ of o)if(_.role==="system")e.push(new Re(_.content));else if(_.role==="assistant")e.push(new Pe(_.content));else if(_.role==="user"){let J=_.content;Array.isArray(J)?e.push(new be({content:J})):e.push(new be(_.content))}let r=new Me({modelName:u,temperature:.7,apiKey:Y??void 0}),p=D.length>0?r.bind({tools:D}):r,i=await p.invoke(e),j=0;for(;j<P&&Array.isArray(i.tool_calls)&&i.tool_calls.length>0&&D.length>0;){let _=i.tool_calls,J=[];for(let X of _){let Z=X.name??X.function?.name,Q=X.args??X.function?.arguments,ne=Q;if(typeof Q=="string")try{ne=JSON.parse(Q)}catch{ne=Q}let ue=Z?s[Z]:void 0,z=`Tool '${Z}' not found`;try{ue&&(z=await ue(ne))}catch(fe){z=`Error from tool '${Z}': ${fe?.message||String(fe)}`}J.push(new Se({tool_call_id:X.id,content:typeof z=="string"?z:JSON.stringify(z)}))}e=[...e,i,...J],i=await p.invoke(e),j+=1}let te=typeof i.content=="string"?i.content:JSON.stringify(i.content),ve={id:String(Date.now()+1),role:"assistant",text:typeof te=="string"?te:String(te)};w(_=>[..._,ve]),setTimeout(T,0)}catch(e){let o={id:String(Date.now()+1),role:"assistant",text:`Error: ${e?.message||"Failed to contact OpenAI"}`};w(r=>[...r,o])}finally{k(!1)}},[b,y,C,c,m,u,T]),g=ye(()=>(y.trim().length>0||c.length>0)&&!S,[y,c.length,S]);return me(()=>{try{typeof window<"u"&&window.localStorage.setItem(a,JSON.stringify(C))}catch{}},[C,a]),me(()=>()=>{if(!H)try{typeof window<"u"&&window.localStorage.removeItem(a)}catch{}},[H,a]),W("div",{className:I,style:{display:"flex",flexDirection:"column",height:"100%",...A},children:[W("div",{style:{flex:1,overflow:"auto",padding:12,background:"#ffffff"},children:[C.map(t=>v("div",{style:{marginBottom:10,display:"flex",justifyContent:t.role==="user"?"flex-end":"flex-start"},children:W("div",{style:{maxWidth:"80%",padding:"8px 10px",borderRadius:10,border:"1px solid rgba(0,0,0,0.06)",background:t.role==="user"?"#111827":"#f3f4f6",color:t.role==="user"?"#ffffff":"#111827",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:[t.text,t.images&&t.images.length>0&&v("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:t.images.map((n,e)=>v("img",{src:n,alt:"upload",style:{width:96,height:72,objectFit:"cover",borderRadius:8,border:"1px solid rgba(0,0,0,0.06)"}},e))})]})},t.id)),v("div",{ref:B})]}),W("div",{style:{padding:12,borderTop:"1px solid rgba(0,0,0,0.06)",background:"#fafafa"},children:[W("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[v("input",{type:"file",accept:"image/*",multiple:!0,onChange:l,style:{display:"none"},id:"ai-hud-chatbot-file"}),v("label",{htmlFor:"ai-hud-chatbot-file",children:v("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:36,height:36,border:"1px solid rgba(0,0,0,0.08)",borderRadius:8,background:"white",cursor:"pointer"},children:W("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[v("path",{d:"M18.5 12.5l-5 5-3-3-5 5"}),v("path",{d:"M20 7a4 4 0 0 0-8 0v10a4 4 0 0 0 8 0Z"})]})})}),v("input",{value:y,onChange:t=>U(t.target.value),placeholder:K??"Type a message...",onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),g&&E())},style:{flex:1,height:36,border:"1px solid rgba(0,0,0,0.15)",borderRadius:8,padding:"0 10px"}}),v("button",{type:"button",disabled:!g,onClick:()=>void E(),style:{height:36,padding:"0 12px",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:g?"#111827":"#e5e7eb",color:g?"#ffffff":"#9ca3af",cursor:g?"pointer":"not-allowed"},children:"Send"})]}),c.length>0&&v("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:c.map((t,n)=>W("div",{style:{position:"relative"},children:[v("img",{src:t,alt:"selected",style:{width:64,height:48,objectFit:"cover",borderRadius:6,border:"1px solid rgba(0,0,0,0.06)"}}),v("button",{type:"button",onClick:()=>h(n),"aria-label":"Remove image",style:{position:"absolute",top:-6,right:-6,width:20,height:20,borderRadius:9999,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer"},children:"\xD7"})]},n))})]})]})};export{G as CHAT_STORAGE_PREFIX,ge as ChatEnabled,Te as DefaultChatbot,se as FloatingWindow,Ae as clearAllConversations,_e as clearConversation,pe as getConversationStorageKey};
//# sourceMappingURL=index.js.map