import Z,{useEffect as le,useMemo as de,useRef as q,useState as Q}from"react";import ce from"html2canvas";import{useEffect as se,useRef as oe,useState as z}from"react";import{jsx as K,jsxs as Y}from"react/jsx-runtime";var V=({children:d,title:u,onClose:c,position:h="bottom-right",width:y=360,height:R=480,minWidth:L=280,minHeight:W=240,offset:A=16,zIndex:O=1e3,className:H,style:E,headerClassName:g,bodyClassName:N,closeButtonAriaLabel:M="Close",closeOnEscape:D=!0,draggable:f=!0,anchorRect:a})=>{let[S,b]=z(!1),v=oe(null),[$,k]=z(!1),m=oe(null),[P,I]=z(null);se(()=>{if(!D)return;let e=t=>{t.key==="Escape"&&c?.()};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[D,c]);let T=(()=>{let e=`${A}px`;switch(h){case"top-left":return{top:e,left:e};case"top-right":return{top:e,right:e};case"bottom-left":return{bottom:e,left:e};case"bottom-right":default:return{bottom:e,right:e}}})(),o=(()=>{if(h!=="auto"||!a)return null;let e=window.innerWidth,t=window.innerHeight,r=A,i=a.top<t/2,w=a.left>e/2,x=i?["bottom","top"]:["top","bottom"],C=w?["right","left"]:["left","right"],j=[`${x[0]}-${C[0]}`,`${x[0]}-${C[1]}`,`${x[1]}-${C[0]}`,`${x[1]}-${C[1]}`];for(let s of j){let B=0,F=0;if(s==="bottom-right"?(B=a.bottom+r,F=a.right-y):s==="bottom-left"?(B=a.bottom+r,F=a.left):s==="top-right"?(B=a.top-R-r,F=a.right-y):(B=a.top-R-r,F=a.left),B>=0&&F>=0&&B+R<=t&&F+y<=e)return{top:B,left:F}}let J=Math.min(Math.max(a.bottom+r,0),t-R),l=Math.min(Math.max(a.right-y,0),e-y);return{top:J,left:l}})(),n=e=>{if(!f)return;let t=v.current;if(!t)return;let r=t.getBoundingClientRect();m.current={x:e.clientX,y:e.clientY,top:r.top,left:r.left},I({top:r.top,left:r.left}),k(!0);let i=x=>{if(!m.current)return;let C=x.clientX-m.current.x,j=x.clientY-m.current.y;I({top:m.current.top+j,left:m.current.left+C})},w=()=>{k(!1),m.current=null,window.removeEventListener("pointermove",i),window.removeEventListener("pointerup",w)};window.addEventListener("pointermove",i),window.addEventListener("pointerup",w,{once:!0})};return Y("div",{ref:v,role:"dialog","aria-modal":"false",className:H,style:{position:"fixed",...P?{top:P.top,left:P.left}:o?{top:o.top,left:o.left}:T,width:y,height:R,minWidth:L,minHeight:W,zIndex:O,background:"#ffffff",border:"1px solid rgba(0,0,0,0.06)",borderRadius:12,boxShadow:"0 10px 30px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08)",display:"flex",flexDirection:"column",overflow:"hidden",userSelect:$?"none":void 0,...E},children:[Y("div",{className:g,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 12px",borderBottom:"1px solid rgba(0,0,0,0.06)",background:"#f9fafb",cursor:f?"move":void 0},onPointerDown:n,children:[K("div",{style:{fontWeight:600,color:"#111827"},children:u}),K("button",{type:"button",onClick:c,"aria-label":M,onMouseEnter:()=>b(!0),onMouseLeave:()=>b(!1),style:{width:28,height:28,display:"inline-flex",alignItems:"center",justifyContent:"center",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer",color:S?"#ef4444":void 0,transition:"color 120ms ease"},children:Y("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[K("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),K("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),K("div",{className:N,style:{flex:1,overflow:"auto",background:"#ffffff"},children:d})]})};import{jsx as _,jsxs as ue}from"react/jsx-runtime";var ne=Z.forwardRef(({children:d,onClick:u,label:c="Open chat",position:h="top-right",offset:y=8,icon:R,className:L,containerStyle:W,buttonClassName:A,buttonStyle:O,buttonSize:H=36,zIndex:E=10,disabled:g=!1,trigger:N,open:M,onOpenChange:D,renderButton:f,openWindowOnClick:a=!1,windowProps:S,windowContent:b},v)=>{let[$,k]=Q(!1),[m,P]=Q(!1),I=q(null),T=q(null),o=q(null),[n,e]=Q(null),t=N??"hover",r=de(()=>{let l={position:"absolute"},s=`${y}px`;switch(h){case"top-left":return{...l,top:s,left:s};case"top-right":return{...l,top:s,right:s};case"bottom-left":return{...l,bottom:s,left:s};case"bottom-right":default:return{...l,bottom:s,right:s}}},[h,y]),i=t==="always"?!0:t==="manual"?!!M:$,w=l=>{D&&D(l)},x={onMouseEnter:t==="hover"?()=>{k(!0),w(!0)}:void 0,onMouseLeave:t==="hover"?()=>{k(!1),w(!1)}:void 0,onFocus:t==="focus"?()=>{k(!0),w(!0)}:void 0,onBlur:t==="focus"?()=>{k(!1),w(!1)}:void 0},C=!!S?.sendComponentImageAsContext;le(()=>{m&&(async()=>{if(!C)return;let s=o.current;if(s)try{await new Promise(te=>requestAnimationFrame(()=>setTimeout(te,50)));let F=(await ce(s,{useCORS:!0,backgroundColor:null,scale:Math.min(2,Math.max(1,Math.ceil(s.offsetWidth/280)))})).toDataURL("image/png",.92);e(F)}catch{}})()},[m,C]);let j=l=>{I.current=l,typeof v=="function"?v(l):v&&typeof v=="object"&&(v.current=l)},J={type:"button","aria-label":c,onClick:l=>{u?.(l),!g&&a&&P(!0)},className:A,disabled:g,style:{...r,zIndex:E,width:H,height:H,borderRadius:9999,display:"flex",alignItems:"center",justifyContent:"center",border:"1px solid rgba(0,0,0,0.08)",background:g?"#f3f4f6":"white",color:g?"#9ca3af":void 0,boxShadow:"0 2px 6px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06)",cursor:g?"not-allowed":"pointer",transition:"opacity 120ms ease, transform 120ms ease",opacity:i?1:0,transform:i?"scale(1)":"scale(0.95)",pointerEvents:i?"auto":"none",...O},tabIndex:i?0:-1,"aria-hidden":i?void 0:!0,ref:j,visible:i};return ue("div",{className:L,style:{position:"relative",display:"inline-block",...W},...x,ref:T,children:[_("div",{ref:o,style:{display:"inline-block"},children:d}),f?f(J):_("button",{...J,children:R??_("svg",{xmlns:"http://www.w3.org/2000/svg",width:Math.max(12,Math.floor(H*.5)),height:Math.max(12,Math.floor(H*.5)),viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:_("path",{d:"M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"})})}),a&&m&&b&&_(V,{...S,onClose:()=>{S?.onClose?.(),P(!1),e(null)},anchorRect:S?.anchorRect??(I.current?I.current.getBoundingClientRect():null),children:(()=>{if(C){if(!n)return _("div",{style:{padding:12,color:"#6b7280",fontSize:14},children:"Preparing context\u2026"});if(Z.isValidElement(b)){let s=[...b.props?.contextImages??[],n];try{return Z.cloneElement(b,{contextImages:s})}catch{return b}}}return b})()})]})});ne.displayName="ChatEnabled";import{useCallback as ee,useEffect as ae,useMemo as ge,useRef as ie,useState as X}from"react";var G="ai-hud:default-chatbot:history:";function re(d){return`${G}${d}`}function fe(d){try{typeof window<"u"&&window.localStorage.removeItem(re(d))}catch{}}function pe(){try{if(typeof window>"u")return;let d=[];for(let u=0;u<window.localStorage.length;u++){let c=window.localStorage.key(u);c&&c.startsWith(G)&&d.push(c)}d.forEach(u=>window.localStorage.removeItem(u))}catch{}}import{jsx as p,jsxs as U}from"react/jsx-runtime";var me="https://api.openai.com/v1/chat/completions";async function he(d){return new Promise((u,c)=>{let h=new FileReader;h.onload=()=>u(h.result),h.onerror=c,h.readAsDataURL(d)})}var be=({model:d="gpt-4o-mini",placeholderApiKey:u="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",systemPrompt:c="You are a helpful assistant.",welcome:h="Hi! How can I help you today?",className:y,style:R,conversationId:L,context:W,contextImages:A})=>{let O=ie(null);if(!L&&!O.current){let o=(()=>{try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`conv_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`})();O.current=o}let H=L??O.current,E=`${G}${H}`,[g,N]=X(()=>{try{let o=typeof window<"u"?window.localStorage.getItem(E):null;if(o){let n=JSON.parse(o);if(Array.isArray(n))return n}}catch{}return[{id:"welcome",role:"assistant",text:h}]}),[M,D]=X(""),[f,a]=X([]),[S,b]=X(!1),v=ie(null),$=ee(()=>{v.current?.scrollIntoView({behavior:"smooth"})},[]),k=async o=>{let n=Array.from(o.target.files||[]);if(n.length===0)return;let e=await Promise.all(n.map(he));a(t=>[...t,...e]),o.target.value=""},m=o=>{a(n=>n.filter((e,t)=>t!==o))},P=ee((o,n)=>{let e=[];if(c&&e.push({role:"system",content:c}),typeof W<"u"){let t="";try{t=JSON.stringify(W)}catch{t=String(W)}e.push({role:"system",content:`Context: ${t}`})}if(Array.isArray(A)&&A.length>0){let t=A.filter(r=>typeof r=="string"&&(r.startsWith("data:image/")||r.startsWith("http")));if(t.length>0){let r=[{type:"text",text:"Context images"},...t.map(i=>({type:"image_url",image_url:{url:i}}))];e.push({role:"user",content:r})}}for(let t of o)if(t.role==="assistant")e.push({role:"assistant",content:t.text||""});else if((t.images?.length||0)>0){let r=[{type:"text",text:t.text||""},...t.images.map(i=>({type:"image_url",image_url:{url:i}}))];e.push({role:"user",content:r})}else e.push({role:"user",content:t.text||""});if(n)if(n.images.length>0){let t=[{type:"text",text:n.text},...n.images.map(r=>({type:"image_url",image_url:{url:r}}))];e.push({role:"user",content:t})}else e.push({role:"user",content:n.text});return console.log("result",e),e},[c,W]),I=ee(async()=>{let o=M.trim();if(!o&&f.length===0)return;let n={id:String(Date.now()),role:"user",text:o||void 0,images:f.length?f:void 0};N(e=>[...e,n]),D(""),a([]),b(!0);try{let e=P(g,{text:n.text||"",images:n.images||[]}),t=await fetch(me,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`},body:JSON.stringify({model:d,messages:e,modalities:["text","image"],temperature:.7})});if(!t.ok)throw new Error(`OpenAI error: ${t.status}`);let i=(await t.json())?.choices?.[0]?.message?.content??"",w={id:String(Date.now()+1),role:"assistant",text:typeof i=="string"?i:String(i)};N(x=>[...x,w]),setTimeout($,0)}catch(e){let t={id:String(Date.now()+1),role:"assistant",text:`Error: ${e?.message||"Failed to contact OpenAI"}`};N(r=>[...r,t])}finally{b(!1)}},[P,M,g,f,u,d,$]),T=ge(()=>(M.trim().length>0||f.length>0)&&!S,[M,f.length,S]);return ae(()=>{try{typeof window<"u"&&window.localStorage.setItem(E,JSON.stringify(g))}catch{}},[g,E]),ae(()=>()=>{if(!L)try{typeof window<"u"&&window.localStorage.removeItem(E)}catch{}},[L,E]),U("div",{className:y,style:{display:"flex",flexDirection:"column",height:"100%",...R},children:[U("div",{style:{flex:1,overflow:"auto",padding:12,background:"#ffffff"},children:[g.map(o=>p("div",{style:{marginBottom:10,display:"flex",justifyContent:o.role==="user"?"flex-end":"flex-start"},children:U("div",{style:{maxWidth:"80%",padding:"8px 10px",borderRadius:10,border:"1px solid rgba(0,0,0,0.06)",background:o.role==="user"?"#111827":"#f3f4f6",color:o.role==="user"?"#ffffff":"#111827",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:[o.text,o.images&&o.images.length>0&&p("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:o.images.map((n,e)=>p("img",{src:n,alt:"upload",style:{width:96,height:72,objectFit:"cover",borderRadius:8,border:"1px solid rgba(0,0,0,0.06)"}},e))})]})},o.id)),p("div",{ref:v})]}),U("div",{style:{padding:12,borderTop:"1px solid rgba(0,0,0,0.06)",background:"#fafafa"},children:[U("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[p("input",{type:"file",accept:"image/*",multiple:!0,onChange:k,style:{display:"none"},id:"ai-hud-chatbot-file"}),p("label",{htmlFor:"ai-hud-chatbot-file",children:p("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:36,height:36,border:"1px solid rgba(0,0,0,0.08)",borderRadius:8,background:"white",cursor:"pointer"},children:U("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[p("path",{d:"M18.5 12.5l-5 5-3-3-5 5"}),p("path",{d:"M20 7a4 4 0 0 0-8 0v10a4 4 0 0 0 8 0Z"})]})})}),p("input",{value:M,onChange:o=>D(o.target.value),placeholder:"Type a message...",onKeyDown:o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),T&&I())},style:{flex:1,height:36,border:"1px solid rgba(0,0,0,0.15)",borderRadius:8,padding:"0 10px"}}),p("button",{type:"button",disabled:!T,onClick:()=>void I(),style:{height:36,padding:"0 12px",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:T?"#111827":"#e5e7eb",color:T?"#ffffff":"#9ca3af",cursor:T?"pointer":"not-allowed"},children:"Send"})]}),f.length>0&&p("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:f.map((o,n)=>U("div",{style:{position:"relative"},children:[p("img",{src:o,alt:"selected",style:{width:64,height:48,objectFit:"cover",borderRadius:6,border:"1px solid rgba(0,0,0,0.06)"}}),p("button",{type:"button",onClick:()=>m(n),"aria-label":"Remove image",style:{position:"absolute",top:-6,right:-6,width:20,height:20,borderRadius:9999,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer"},children:"\xD7"})]},n))})]})]})};export{G as CHAT_STORAGE_PREFIX,ne as ChatEnabled,be as DefaultChatbot,V as FloatingWindow,pe as clearAllConversations,fe as clearConversation,re as getConversationStorageKey};
//# sourceMappingURL=index.js.map