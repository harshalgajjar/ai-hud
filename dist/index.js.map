{"version":3,"sources":["../src/react/ChatEnabled.tsx","../src/react/FloatingWindow.tsx","../src/react/DefaultChatbot.tsx","../src/react/chatStorage.ts"],"sourcesContent":["import React, { useEffect, useMemo, useRef, useState } from \"react\";\nimport html2canvas from \"html2canvas\";\nimport { FloatingWindow, FloatingWindowProps } from \"./FloatingWindow\";\n\nexport type ChatEnabledTrigger = \"hover\" | \"focus\" | \"always\" | \"manual\";\n\nexport type ChatEnabledProps = {\n  children: React.ReactNode;\n  onClick?: (event: React.MouseEvent<HTMLButtonElement>) => void;\n  label?: string;\n  position?: \"top-left\" | \"top-right\" | \"bottom-left\" | \"bottom-right\";\n  offset?: number;\n  icon?: React.ReactNode;\n  className?: string; // container className\n  containerStyle?: React.CSSProperties;\n  buttonClassName?: string;\n  buttonStyle?: React.CSSProperties;\n  buttonSize?: number; // px, default 36\n  zIndex?: number; // default 10\n  disabled?: boolean;\n  trigger?: ChatEnabledTrigger; // default 'hover'\n  open?: boolean; // used when trigger is 'manual'\n  onOpenChange?: (open: boolean) => void; // notifies visibility changes\n  renderButton?: (\n    props: React.ButtonHTMLAttributes<HTMLButtonElement> & {\n      visible: boolean;\n      ref: React.Ref<HTMLButtonElement>;\n    }\n  ) => React.ReactNode;\n  // Optional built-in floating window support\n  openWindowOnClick?: boolean; // default false\n  windowProps?: (Omit<FloatingWindowProps, \"children\"> & { sendComponentImageAsContext?: boolean });\n  windowContent?: React.ReactNode; // custom content; if absent, shows nothing\n};\n\nexport const ChatEnabled = React.forwardRef<HTMLButtonElement, ChatEnabledProps>(\n  (\n    {\n      children,\n      onClick,\n      label = \"Open chat\",\n      position = \"top-right\",\n      offset = 8,\n      icon,\n      className,\n      containerStyle,\n      buttonClassName,\n      buttonStyle,\n      buttonSize = 36,\n      zIndex = 10,\n      disabled = false,\n      trigger,\n      open,\n      onOpenChange,\n      renderButton,\n      openWindowOnClick = false,\n      windowProps,\n      windowContent,\n    },\n    ref\n  ) => {\n    const [isHoveredOrFocused, setIsHoveredOrFocused] = useState(false);\n    const [isWindowOpen, setIsWindowOpen] = useState(false);\n    const internalButtonRef = useRef<HTMLButtonElement | null>(null);\n    const containerRef = useRef<HTMLDivElement | null>(null);\n    const captureRef = useRef<HTMLDivElement | null>(null);\n    const [capturedImage, setCapturedImage] = useState<string | null>(null);\n\n    const resolvedTrigger: ChatEnabledTrigger = trigger ?? \"hover\";\n\n    const positionStyle = useMemo<React.CSSProperties>(() => {\n      const base: React.CSSProperties = { position: \"absolute\" };\n      const offsetPx = `${offset}px`;\n      switch (position) {\n        case \"top-left\":\n          return { ...base, top: offsetPx, left: offsetPx };\n        case \"top-right\":\n          return { ...base, top: offsetPx, right: offsetPx };\n        case \"bottom-left\":\n          return { ...base, bottom: offsetPx, left: offsetPx };\n        case \"bottom-right\":\n        default:\n          return { ...base, bottom: offsetPx, right: offsetPx };\n      }\n    }, [position, offset]);\n\n    const computedVisible = (() => {\n      if (resolvedTrigger === \"always\") return true;\n      if (resolvedTrigger === \"manual\") return Boolean(open);\n      // hover or focus: we use the same internal state\n      return isHoveredOrFocused;\n    })();\n\n    const notifyOpenChange = (next: boolean) => {\n      if (onOpenChange) onOpenChange(next);\n    };\n\n    const containerEventHandlers = {\n      onMouseEnter: resolvedTrigger === \"hover\" ? () => { setIsHoveredOrFocused(true); notifyOpenChange(true); } : undefined,\n      onMouseLeave: resolvedTrigger === \"hover\" ? () => { setIsHoveredOrFocused(false); notifyOpenChange(false); } : undefined,\n      onFocus: resolvedTrigger === \"focus\" ? () => { setIsHoveredOrFocused(true); notifyOpenChange(true); } : undefined,\n      onBlur: resolvedTrigger === \"focus\" ? () => { setIsHoveredOrFocused(false); notifyOpenChange(false); } : undefined,\n    } as const;\n    const sendImageFlag = Boolean((windowProps as any)?.sendComponentImageAsContext);\n\n    useEffect(() => {\n      const doCapture = async () => {\n        if (!sendImageFlag) return;\n        const target = captureRef.current;\n        if (!target) return;\n        try {\n          // Wait a tick to ensure layout has settled\n          await new Promise((r) => requestAnimationFrame(() => setTimeout(r, 50)));\n          const canvas = await html2canvas(target, {\n            useCORS: true,\n            backgroundColor: null,\n            scale: Math.min(2, Math.max(1, Math.ceil((target as HTMLElement).offsetWidth / 280))),\n          });\n          const dataUrl = canvas.toDataURL(\"image/png\", 0.92);\n          setCapturedImage(dataUrl);\n        } catch {\n          // ignore capture errors\n        }\n      };\n      if (isWindowOpen) {\n        void doCapture();\n      }\n    }, [isWindowOpen, sendImageFlag]);\n\n\n    const setMergedRef = (el: HTMLButtonElement | null) => {\n      internalButtonRef.current = el;\n      if (typeof ref === \"function\") {\n        ref(el);\n      } else if (ref && typeof ref === \"object\") {\n        (ref as React.MutableRefObject<HTMLButtonElement | null>).current = el;\n      }\n    };\n\n    const buttonProps: React.ButtonHTMLAttributes<HTMLButtonElement> & { ref: typeof ref; visible: boolean } = {\n      type: \"button\",\n      \"aria-label\": label,\n      onClick: (e) => {\n        onClick?.(e);\n        if (!disabled && openWindowOnClick) setIsWindowOpen(true);\n      },\n      className: buttonClassName,\n      disabled,\n      style: {\n        ...positionStyle,\n        zIndex,\n        width: buttonSize,\n        height: buttonSize,\n        borderRadius: 9999,\n        display: \"flex\",\n        alignItems: \"center\",\n        justifyContent: \"center\",\n        border: \"1px solid rgba(0,0,0,0.08)\",\n        background: disabled ? \"#f3f4f6\" : \"white\",\n        color: disabled ? \"#9ca3af\" : undefined,\n        boxShadow:\n          \"0 2px 6px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06)\",\n        cursor: disabled ? \"not-allowed\" : \"pointer\",\n        transition: \"opacity 120ms ease, transform 120ms ease\",\n        opacity: computedVisible ? 1 : 0,\n        transform: computedVisible ? \"scale(1)\" : \"scale(0.95)\",\n        pointerEvents: computedVisible ? \"auto\" : \"none\",\n        ...buttonStyle,\n      },\n      tabIndex: computedVisible ? 0 : -1,\n      \"aria-hidden\": computedVisible ? undefined : true,\n      ref: setMergedRef,\n      visible: computedVisible,\n    };\n\n    return (\n      <div\n        className={className}\n        style={{ position: \"relative\", display: \"inline-block\", ...containerStyle }}\n        {...containerEventHandlers}\n        ref={containerRef}\n      >\n        <div ref={captureRef} style={{ display: \"inline-block\" }}>\n          {children}\n        </div>\n        {renderButton ? (\n          renderButton(buttonProps)\n        ) : (\n          <button {...buttonProps}>\n            {icon ?? (\n              <svg\n                xmlns=\"http://www.w3.org/2000/svg\"\n                width={Math.max(12, Math.floor(buttonSize * 0.5))}\n                height={Math.max(12, Math.floor(buttonSize * 0.5))}\n                viewBox=\"0 0 24 24\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                strokeWidth=\"2\"\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n              >\n                <path d=\"M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z\" />\n              </svg>\n            )}\n          </button>\n        )}\n        {openWindowOnClick && isWindowOpen && windowContent && (\n          <FloatingWindow\n            {...(windowProps as FloatingWindowProps)}\n            onClose={() => {\n              windowProps?.onClose?.();\n              setIsWindowOpen(false);\n              setCapturedImage(null);\n            }}\n            anchorRect={\n              (windowProps as FloatingWindowProps | undefined)?.anchorRect ??\n              (internalButtonRef.current\n                ? internalButtonRef.current.getBoundingClientRect()\n                : null)\n            }\n          >\n            {(() => {\n              if (sendImageFlag) {\n                if (!capturedImage) {\n                  return (\n                    <div style={{ padding: 12, color: \"#6b7280\", fontSize: 14 }}>\n                      Loading...\n                    </div>\n                  );\n                }\n                if (React.isValidElement(windowContent)) {\n                  const prev = (windowContent.props as any)?.contextImages as string[] | undefined;\n                  const merged = [...(prev ?? []), capturedImage];\n                  try {\n                    return React.cloneElement(windowContent as any, { contextImages: merged });\n                  } catch {\n                    return windowContent;\n                  }\n                }\n              }\n              return windowContent;\n            })()}\n          </FloatingWindow>\n        )}\n      </div>\n    );\n  }\n);\n\nChatEnabled.displayName = \"ChatEnabled\";\n\n// For convenience, also export a lower-cased alias for named import\n// Note: in JSX you must still use <ChatEnabled />, not <chatEnabled />\nexport const chatEnabled = ChatEnabled;\n\n\n","import React, { useEffect, useRef, useState } from \"react\";\n\nexport type FloatingWindowCorner = \"top-left\" | \"top-right\" | \"bottom-left\" | \"bottom-right\";\nexport type FloatingWindowPosition = FloatingWindowCorner | \"auto\";\n\nexport type FloatingWindowProps = {\n  children: React.ReactNode;\n  title?: React.ReactNode;\n  onClose?: () => void;\n  position?: FloatingWindowPosition;\n  width?: number; // px\n  height?: number; // px\n  minWidth?: number;\n  minHeight?: number;\n  offset?: number; // px from edges\n  zIndex?: number;\n  className?: string;\n  style?: React.CSSProperties;\n  headerClassName?: string;\n  bodyClassName?: string;\n  closeButtonAriaLabel?: string;\n  closeOnEscape?: boolean;\n  draggable?: boolean;\n  // When position is 'auto', anchorRect helps place the window near the trigger button\n  anchorRect?: { top: number; left: number; right: number; bottom: number; width: number; height: number } | null;\n};\n\nexport const FloatingWindow: React.FC<FloatingWindowProps> = ({\n  children,\n  title,\n  onClose,\n  position = \"bottom-right\",\n  width = 360,\n  height = 480,\n  minWidth = 280,\n  minHeight = 240,\n  offset = 16,\n  zIndex = 1000,\n  className,\n  style,\n  headerClassName,\n  bodyClassName,\n  closeButtonAriaLabel = \"Close\",\n  closeOnEscape = true,\n  draggable = true,\n  anchorRect,\n}) => {\n  const [isCloseHovered, setIsCloseHovered] = useState(false);\n  const containerRef = useRef<HTMLDivElement | null>(null);\n  const [dragging, setDragging] = useState(false);\n  const dragStart = useRef<{ x: number; y: number; top: number; left: number } | null>(null);\n  const [dragTopLeft, setDragTopLeft] = useState<{ top: number; left: number } | null>(null);\n  useEffect(() => {\n    if (!closeOnEscape) return;\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") {\n        onClose?.();\n      }\n    };\n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n  }, [closeOnEscape, onClose]);\n\n  const edgeStyle: React.CSSProperties = (() => {\n    const o = `${offset}px`;\n    switch (position) {\n      case \"top-left\":\n        return { top: o, left: o };\n      case \"top-right\":\n        return { top: o, right: o };\n      case \"bottom-left\":\n        return { bottom: o, left: o };\n      case \"bottom-right\":\n      default:\n        return { bottom: o, right: o };\n    }\n  })();\n\n  const autoTopLeft: { top: number; left: number } | null = (() => {\n    if (position !== \"auto\" || !anchorRect) return null;\n    const vw = window.innerWidth;\n    const vh = window.innerHeight;\n    const gap = offset;\n    const preferBottom = anchorRect.top < vh / 2;\n    const preferRight = anchorRect.left > vw / 2;\n    const verticalOrder = preferBottom ? [\"bottom\", \"top\"] : [\"top\", \"bottom\"] as const;\n    const horizontalOrder = preferRight ? [\"right\", \"left\"] : [\"left\", \"right\"] as const;\n\n    const candidates: Array<\"top-left\" | \"top-right\" | \"bottom-left\" | \"bottom-right\"> = [\n      `${verticalOrder[0]}-${horizontalOrder[0]}` as any,\n      `${verticalOrder[0]}-${horizontalOrder[1]}` as any,\n      `${verticalOrder[1]}-${horizontalOrder[0]}` as any,\n      `${verticalOrder[1]}-${horizontalOrder[1]}` as any,\n    ];\n\n    for (const c of candidates) {\n      let top = 0;\n      let left = 0;\n      if (c === \"bottom-right\") {\n        top = anchorRect.bottom + gap;\n        left = anchorRect.right - width;\n      } else if (c === \"bottom-left\") {\n        top = anchorRect.bottom + gap;\n        left = anchorRect.left;\n      } else if (c === \"top-right\") {\n        top = anchorRect.top - height - gap;\n        left = anchorRect.right - width;\n      } else {\n        top = anchorRect.top - height - gap;\n        left = anchorRect.left;\n      }\n      const fits = top >= 0 && left >= 0 && top + height <= vh && left + width <= vw;\n      if (fits) return { top, left };\n    }\n    // Fallback: clamp bottom-right relative to anchor\n    let top = Math.min(Math.max(anchorRect.bottom + gap, 0), vh - height);\n    let left = Math.min(Math.max(anchorRect.right - width, 0), vw - width);\n    return { top, left };\n  })();\n\n  const handlePointerDown = (e: React.PointerEvent<HTMLDivElement>) => {\n    if (!draggable) return;\n    const el = containerRef.current;\n    if (!el) return;\n    const rect = el.getBoundingClientRect();\n    dragStart.current = { x: e.clientX, y: e.clientY, top: rect.top, left: rect.left };\n    setDragTopLeft({ top: rect.top, left: rect.left });\n    setDragging(true);\n    const handleMove = (ev: PointerEvent) => {\n      if (!dragStart.current) return;\n      const dx = ev.clientX - dragStart.current.x;\n      const dy = ev.clientY - dragStart.current.y;\n      setDragTopLeft({ top: dragStart.current.top + dy, left: dragStart.current.left + dx });\n    };\n    const handleUp = () => {\n      setDragging(false);\n      dragStart.current = null;\n      window.removeEventListener(\"pointermove\", handleMove);\n      window.removeEventListener(\"pointerup\", handleUp);\n    };\n    window.addEventListener(\"pointermove\", handleMove);\n    window.addEventListener(\"pointerup\", handleUp, { once: true });\n  };\n\n  return (\n    <div\n      ref={containerRef}\n      role=\"dialog\"\n      aria-modal=\"false\"\n      className={className}\n      style={{\n        position: \"fixed\",\n        ...(dragTopLeft\n          ? { top: dragTopLeft.top, left: dragTopLeft.left }\n          : autoTopLeft\n          ? { top: autoTopLeft.top, left: autoTopLeft.left }\n          : edgeStyle),\n        width,\n        height,\n        minWidth,\n        minHeight,\n        zIndex,\n        background: \"#ffffff\",\n        border: \"1px solid rgba(0,0,0,0.06)\",\n        borderRadius: 12,\n        boxShadow:\n          \"0 10px 30px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08)\",\n        display: \"flex\",\n        flexDirection: \"column\",\n        overflow: \"hidden\",\n        userSelect: dragging ? \"none\" : undefined,\n        ...style,\n      }}\n    >\n      <div\n        className={headerClassName}\n        style={{\n          display: \"flex\",\n          alignItems: \"center\",\n          justifyContent: \"space-between\",\n          padding: \"10px 12px\",\n          borderBottom: \"1px solid rgba(0,0,0,0.06)\",\n          background: \"#f9fafb\",\n          cursor: draggable ? \"move\" : undefined,\n        }}\n        onPointerDown={handlePointerDown}\n      >\n        <div style={{ fontWeight: 600, color: \"#111827\" }}>{title}</div>\n        <button\n          type=\"button\"\n          onClick={onClose}\n          aria-label={closeButtonAriaLabel}\n          onMouseEnter={() => setIsCloseHovered(true)}\n          onMouseLeave={() => setIsCloseHovered(false)}\n          style={{\n            width: 28,\n            height: 28,\n            display: \"inline-flex\",\n            alignItems: \"center\",\n            justifyContent: \"center\",\n            borderRadius: 8,\n            border: \"1px solid rgba(0,0,0,0.08)\",\n            background: \"white\",\n            cursor: \"pointer\",\n            color: isCloseHovered ? \"#ef4444\" : undefined,\n            transition: \"color 120ms ease\",\n          }}\n        >\n          <svg\n            xmlns=\"http://www.w3.org/2000/svg\"\n            width=\"16\"\n            height=\"16\"\n            viewBox=\"0 0 24 24\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            strokeWidth=\"2\"\n            strokeLinecap=\"round\"\n            strokeLinejoin=\"round\"\n          >\n            <line x1=\"18\" y1=\"6\" x2=\"6\" y2=\"18\" />\n            <line x1=\"6\" y1=\"6\" x2=\"18\" y2=\"18\" />\n          </svg>\n        </button>\n      </div>\n      <div\n        className={bodyClassName}\n        style={{ flex: 1, overflow: \"auto\", background: \"#ffffff\" }}\n      >\n        {children}\n      </div>\n    </div>\n  );\n};\n\n\n","import React, { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport { ChatOpenAI } from \"@langchain/openai\";\nimport { AIMessage, HumanMessage, SystemMessage, ToolMessage } from \"@langchain/core/messages\";\nimport { CHAT_STORAGE_PREFIX } from \"./chatStorage\";\n\ntype UiMessage = {\n  id: string;\n  role: \"user\" | \"assistant\";\n  text?: string;\n  images?: string[]; // data URLs for previews\n};\n\ntype UserContentPart =\n  | { type: \"text\"; text: string }\n  | { type: \"image_url\"; image_url: { url: string } };\n\ntype OpenAIMessage =\n  | { role: \"system\"; content: string }\n  | { role: \"assistant\"; content: string }\n  | { role: \"user\"; content: string | UserContentPart[] };\n\nexport type DefaultChatbotProps = {\n  model?: string; // OpenAI model id with vision support\n  placeholderApiKey?: string; // optional explicit key (prefer server proxy in production)\n  systemPrompt?: string;\n  welcome?: string;\n  className?: string;\n  style?: React.CSSProperties;\n  conversationId?: string | null; // when null/undefined, a new id is generated per mount\n  context?: unknown; // arbitrary JSON-like object passed to the model as system context\n  contextImages?: string[]; // optional images to prepend as context (data URLs or https URLs)\n  inputPlaceholder?: string; // placeholder text for the input box\n  inputValue?: string; // externally controlled input value\n  tools?: any[]; // optional LangChain tools (e.g., from @langchain/core/tools)\n  toolMaxIterations?: number; // safety cap for tool loops\n};\n\nconst OPENAI_API_URL = \"https://api.openai.com/v1/chat/completions\";\n\nasync function fileToDataUrl(file: File): Promise<string> {\n  return new Promise((resolve, reject) => {\n    const reader = new FileReader();\n    reader.onload = () => resolve(reader.result as string);\n    reader.onerror = reject;\n    reader.readAsDataURL(file);\n  });\n}\n\nexport const DefaultChatbot: React.FC<DefaultChatbotProps> = ({\n  model = \"gpt-4o-mini\",\n  placeholderApiKey,\n  systemPrompt = \"You are a helpful assistant.\",\n  welcome = \"Hi! How can I help you today?\",\n  className,\n  style,\n  conversationId,\n  context,\n  contextImages,\n  inputPlaceholder,\n  inputValue,\n  tools,\n  toolMaxIterations = 3,\n}) => {\n  const resolveApiKey = (explicit?: string): string | null => {\n    if (explicit && explicit !== \"REPLACE_WITH_YOUR_OPENAI_API_KEY\") return explicit;\n    try {\n      const g = (globalThis as any) || {};\n      if (typeof g.AI_HUD_OPENAI_API_KEY === \"string\" && g.AI_HUD_OPENAI_API_KEY) return g.AI_HUD_OPENAI_API_KEY;\n      if (typeof g.__AI_HUD_OPENAI_API_KEY__ === \"string\" && g.__AI_HUD_OPENAI_API_KEY__) return g.__AI_HUD_OPENAI_API_KEY__;\n    } catch {}\n    try {\n      const p = (globalThis as any).process;\n      if (p && p.env && typeof p.env.AI_HUD_OPENAI_API_KEY === \"string\") {\n        return p.env.AI_HUD_OPENAI_API_KEY as string;\n      }\n    } catch {}\n    return null;\n  };\n\n  const apiKey = resolveApiKey(placeholderApiKey);\n  const generatedIdRef = useRef<string | null>(null);\n  if (!conversationId && !generatedIdRef.current) {\n    const gen = ((): string => {\n      try {\n        if (typeof crypto !== \"undefined\" && (crypto as any).randomUUID) return (crypto as any).randomUUID();\n      } catch {}\n      return `conv_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;\n    })();\n    generatedIdRef.current = gen;\n  }\n  const effectiveConversationId = conversationId ?? generatedIdRef.current!;\n  const storageKey = `${CHAT_STORAGE_PREFIX}${effectiveConversationId}`;\n  const [messages, setMessages] = useState<UiMessage[]>(() => {\n    try {\n      const raw = typeof window !== \"undefined\" ? window.localStorage.getItem(storageKey) : null;\n      if (raw) {\n        const parsed = JSON.parse(raw) as UiMessage[];\n        if (Array.isArray(parsed)) return parsed;\n      }\n    } catch {}\n    return [{ id: \"welcome\", role: \"assistant\", text: welcome }];\n  });\n  const [input, setInput] = useState<string>(() =>\n    typeof inputValue === \"string\" ? inputValue : \"\"\n  );\n  const [pendingImages, setPendingImages] = useState<string[]>([]);\n  const [isSending, setIsSending] = useState(false);\n  const endRef = useRef<HTMLDivElement | null>(null);\n\n  const scrollToEnd = useCallback(() => {\n    endRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, []);\n\n  // Normalize tools to OpenAI schema and keep an executor map\n  const { toolSchemas, toolExecutors } = useMemo(() => {\n    const schemas: any[] = [];\n    const exec: Record<string, (args: any) => Promise<any>> = {};\n    if (Array.isArray(tools)) {\n      for (const t of tools as any[]) {\n        if (!t) continue;\n        // Accept either { type:'function', function:{ name, parameters, description } } or simplified { type:'function', name, parameters, description }\n        if (t.type === \"function\" && t.function && t.function.name) {\n          schemas.push({ type: \"function\", function: t.function });\n          const fname = t.function.name;\n          if (typeof t.invoke === \"function\") exec[fname] = t.invoke.bind(t);\n          else if (typeof t.call === \"function\") exec[fname] = t.call.bind(t);\n          else if (typeof t.func === \"function\") exec[fname] = t.func.bind(t);\n        } else if (t.type === \"function\" && t.name) {\n          const fn = { name: t.name, description: t.description ?? \"\", parameters: t.parameters ?? { type: \"object\", properties: {} } };\n          schemas.push({ type: \"function\", function: fn });\n          if (typeof t.invoke === \"function\") exec[t.name] = t.invoke.bind(t);\n          else if (typeof t.call === \"function\") exec[t.name] = t.call.bind(t);\n          else if (typeof t.func === \"function\") exec[t.name] = t.func.bind(t);\n        }\n      }\n    }\n    return { toolSchemas: schemas, toolExecutors: exec };\n  }, [tools]);\n\n  const handlePickImages = async (\n    e: React.ChangeEvent<HTMLInputElement>\n  ) => {\n    const files = Array.from(e.target.files || []);\n    if (files.length === 0) return;\n    const urls = await Promise.all(files.map(fileToDataUrl));\n    setPendingImages((prev) => [...prev, ...urls]);\n    e.target.value = \"\";\n  };\n\n  const removePendingImage = (idx: number) => {\n    setPendingImages((prev) => prev.filter((_, i) => i !== idx));\n  };\n\n  const buildOpenAIMessages = useCallback(\n    (\n      uiMessages: UiMessage[],\n      nextUser?: { text: string; images: string[] }\n    ): OpenAIMessage[] => {\n      const result: OpenAIMessage[] = [];\n      if (systemPrompt) {\n        result.push({ role: \"system\", content: systemPrompt });\n      }\n      if (typeof context !== \"undefined\") {\n        let serialized = \"\";\n        try {\n          serialized = JSON.stringify(context);\n        } catch {\n          serialized = String(context);\n        }\n        result.push({ role: \"system\", content: `Context: ${serialized}` });\n      }\n      if (Array.isArray(contextImages) && contextImages.length > 0) {\n        // Ensure data URLs are converted to https if needed (OpenAI requires hosted URLs in some models)\n        // Many vision models now accept data URLs; keep as-is but filter invalid ones.\n        const valid = contextImages.filter((u) => typeof u === \"string\" && (u.startsWith(\"data:image/\") || u.startsWith(\"http\")));\n        if (valid.length > 0) {\n          const parts: UserContentPart[] = [\n            { type: \"text\", text: \"Context images\" },\n            ...valid.map<UserContentPart>((url) => ({ type: \"image_url\", image_url: { url } })),\n          ];\n          result.push({ role: \"user\", content: parts });\n        }\n      }\n      for (const m of uiMessages) {\n        if (m.role === \"assistant\") {\n          result.push({ role: \"assistant\", content: m.text || \"\" });\n        } else {\n          if ((m.images?.length || 0) > 0) {\n            const parts: UserContentPart[] = [\n              { type: \"text\", text: m.text || \"\" },\n              ...m.images!.map<UserContentPart>((url) => ({ type: \"image_url\", image_url: { url } })),\n            ];\n            result.push({ role: \"user\", content: parts });\n          } else {\n            result.push({ role: \"user\", content: m.text || \"\" });\n          }\n        }\n      }\n      if (nextUser) {\n        if (nextUser.images.length > 0) {\n          const parts: UserContentPart[] = [\n            { type: \"text\", text: nextUser.text },\n            ...nextUser.images.map<UserContentPart>((url) => ({ type: \"image_url\", image_url: { url } })),\n          ];\n          result.push({ role: \"user\", content: parts });\n        } else {\n          result.push({ role: \"user\", content: nextUser.text });\n        }\n      }\n      console.log(\"result\", result)\n      return result;\n    },\n    [systemPrompt, context]\n  );\n\n  const send = useCallback(async () => {\n    const text = input.trim();\n    if (!text && pendingImages.length === 0) return;\n    const userMsg: UiMessage = {\n      id: String(Date.now()),\n      role: \"user\",\n      text: text || undefined,\n      images: pendingImages.length ? pendingImages : undefined,\n    };\n    setMessages((prev) => [...prev, userMsg]);\n    setInput(\"\");\n    setPendingImages([]);\n    setIsSending(true);\n\n    try {\n      // Translate our OpenAI-like structure to LangChain messages\n      let lcMsgs: (SystemMessage | HumanMessage | AIMessage)[] = [];\n      const openaiMessages = buildOpenAIMessages(messages, {\n        text: userMsg.text || \"\",\n        images: userMsg.images || [],\n      });\n      for (const m of openaiMessages) {\n        if (m.role === \"system\") {\n          lcMsgs.push(new SystemMessage(m.content as string));\n        } else if (m.role === \"assistant\") {\n          lcMsgs.push(new AIMessage(m.content as string));\n        } else if (m.role === \"user\") {\n          const c: any = (m as any).content;\n          if (Array.isArray(c)) {\n            // Preserve multimodal structure for vision models\n            lcMsgs.push(new HumanMessage({ content: c } as any));\n          } else {\n            lcMsgs.push(new HumanMessage(m.content as string));\n          }\n        }\n      }\n\n      const base = new ChatOpenAI({ modelName: model, temperature: 0.7, apiKey: apiKey ?? undefined });\n      const chat = (toolSchemas.length > 0 ? (base as any).bind({ tools: toolSchemas }) : base) as ChatOpenAI;\n\n      let response: AIMessage = await (chat as any).invoke(lcMsgs);\n\n      // Tool-calling loop: execute tools then feed results back until no calls or cap reached\n      let iterations = 0;\n      while (\n        iterations < toolMaxIterations &&\n        Array.isArray((response as any).tool_calls) &&\n        (response as any).tool_calls.length > 0 &&\n        toolSchemas.length > 0\n      ) {\n        const calls: Array<{ id: string; name?: string; args?: any; function?: { name: string; arguments: string } }> = (response as any).tool_calls;\n        const toolMsgs: ToolMessage[] = [];\n        for (const call of calls) {\n          const fname = call.name ?? call.function?.name;\n          const rawArgs = call.args ?? call.function?.arguments;\n          let parsedArgs: any = rawArgs;\n          if (typeof rawArgs === \"string\") {\n            try { parsedArgs = JSON.parse(rawArgs); } catch { parsedArgs = rawArgs; }\n          }\n          const exec = fname ? toolExecutors[fname] : undefined;\n          let out: any = `Tool '${fname}' not found`;\n          try {\n            if (exec) out = await exec(parsedArgs);\n          } catch (e: any) {\n            out = `Error from tool '${fname}': ${e?.message || String(e)}`;\n          }\n          toolMsgs.push(new ToolMessage({ tool_call_id: call.id, content: typeof out === \"string\" ? out : JSON.stringify(out) }));\n        }\n        lcMsgs = [...lcMsgs, response, ...toolMsgs];\n        response = await (chat as any).invoke(lcMsgs);\n        iterations += 1;\n      }\n\n      const content = typeof response.content === \"string\" ? response.content : JSON.stringify(response.content);\n      const assistant: UiMessage = {\n        id: String(Date.now() + 1),\n        role: \"assistant\",\n        text: typeof content === \"string\" ? content : String(content),\n      };\n      setMessages((prev) => [...prev, assistant]);\n      setTimeout(scrollToEnd, 0);\n    } catch (err: any) {\n      const assistant: UiMessage = {\n        id: String(Date.now() + 1),\n        role: \"assistant\",\n        text: `Error: ${err?.message || \"Failed to contact OpenAI\"}`,\n      };\n      setMessages((prev) => [...prev, assistant]);\n    } finally {\n      setIsSending(false);\n    }\n  }, [buildOpenAIMessages, input, messages, pendingImages, placeholderApiKey, model, scrollToEnd]);\n\n  const canSend = useMemo(() => {\n    return (input.trim().length > 0 || pendingImages.length > 0) && !isSending;\n  }, [input, pendingImages.length, isSending]);\n\n  // Persist conversation per conversationId\n  useEffect(() => {\n    try {\n      if (typeof window !== \"undefined\") {\n        window.localStorage.setItem(storageKey, JSON.stringify(messages));\n      }\n    } catch {}\n  }, [messages, storageKey]);\n\n  // If no explicit conversationId was provided (auto-generated),\n  // clear storage on unmount to avoid accumulating transient threads.\n  useEffect(() => {\n    return () => {\n      if (!conversationId) {\n        try {\n          if (typeof window !== \"undefined\") {\n            window.localStorage.removeItem(storageKey);\n          }\n        } catch {}\n      }\n    };\n  }, [conversationId, storageKey]);\n\n  return (\n    <div className={className} style={{ display: \"flex\", flexDirection: \"column\", height: \"100%\", ...style }}>\n      <div style={{ flex: 1, overflow: \"auto\", padding: 12, background: \"#ffffff\" }}>\n        {messages.map((m) => (\n          <div key={m.id} style={{ marginBottom: 10, display: \"flex\", justifyContent: m.role === \"user\" ? \"flex-end\" : \"flex-start\" }}>\n            <div\n              style={{\n                maxWidth: \"80%\",\n                padding: \"8px 10px\",\n                borderRadius: 10,\n                border: \"1px solid rgba(0,0,0,0.06)\",\n                background: m.role === \"user\" ? \"#111827\" : \"#f3f4f6\",\n                color: m.role === \"user\" ? \"#ffffff\" : \"#111827\",\n                whiteSpace: \"pre-wrap\",\n                wordBreak: \"break-word\",\n              }}\n            >\n              {m.text}\n              {m.images && m.images.length > 0 && (\n                <div style={{ display: \"flex\", gap: 8, marginTop: 8, flexWrap: \"wrap\" }}>\n                  {m.images.map((url, i) => (\n                    <img key={i} src={url} alt=\"upload\" style={{ width: 96, height: 72, objectFit: \"cover\", borderRadius: 8, border: \"1px solid rgba(0,0,0,0.06)\" }} />\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n        ))}\n        <div ref={endRef} />\n      </div>\n      <div style={{ padding: 12, borderTop: \"1px solid rgba(0,0,0,0.06)\", background: \"#fafafa\" }}>\n        <div style={{ display: \"flex\", gap: 8, alignItems: \"center\" }}>\n          <input\n            type=\"file\"\n            accept=\"image/*\"\n            multiple\n            onChange={handlePickImages}\n            style={{ display: \"none\" }}\n            id=\"ai-hud-chatbot-file\"\n          />\n          <label htmlFor=\"ai-hud-chatbot-file\">\n            <span\n              style={{\n                display: \"inline-flex\",\n                alignItems: \"center\",\n                justifyContent: \"center\",\n                width: 36,\n                height: 36,\n                border: \"1px solid rgba(0,0,0,0.08)\",\n                borderRadius: 8,\n                background: \"white\",\n                cursor: \"pointer\",\n              }}\n            >\n              <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\n                <path d=\"M18.5 12.5l-5 5-3-3-5 5\" />\n                <path d=\"M20 7a4 4 0 0 0-8 0v10a4 4 0 0 0 8 0Z\" />\n              </svg>\n            </span>\n          </label>\n          <input\n            value={input}\n            onChange={(e) => setInput(e.target.value)}\n            placeholder={inputPlaceholder ?? \"Type a message...\"}\n            onKeyDown={(e) => {\n              if (e.key === \"Enter\" && !e.shiftKey) {\n                e.preventDefault();\n                if (canSend) void send();\n              }\n            }}\n            style={{\n              flex: 1,\n              height: 36,\n              border: \"1px solid rgba(0,0,0,0.15)\",\n              borderRadius: 8,\n              padding: \"0 10px\",\n            }}\n          />\n          <button\n            type=\"button\"\n            disabled={!canSend}\n            onClick={() => void send()}\n            style={{\n              height: 36,\n              padding: \"0 12px\",\n              borderRadius: 8,\n              border: \"1px solid rgba(0,0,0,0.08)\",\n              background: canSend ? \"#111827\" : \"#e5e7eb\",\n              color: canSend ? \"#ffffff\" : \"#9ca3af\",\n              cursor: canSend ? \"pointer\" : \"not-allowed\",\n            }}\n          >\n            Send\n          </button>\n        </div>\n        {pendingImages.length > 0 && (\n          <div style={{ display: \"flex\", gap: 8, marginTop: 8, flexWrap: \"wrap\" }}>\n            {pendingImages.map((url, i) => (\n              <div key={i} style={{ position: \"relative\" }}>\n                <img src={url} alt=\"selected\" style={{ width: 64, height: 48, objectFit: \"cover\", borderRadius: 6, border: \"1px solid rgba(0,0,0,0.06)\" }} />\n                <button\n                  type=\"button\"\n                  onClick={() => removePendingImage(i)}\n                  aria-label=\"Remove image\"\n                  style={{\n                    position: \"absolute\",\n                    top: -6,\n                    right: -6,\n                    width: 20,\n                    height: 20,\n                    borderRadius: 9999,\n                    border: \"1px solid rgba(0,0,0,0.08)\",\n                    background: \"white\",\n                    cursor: \"pointer\",\n                  }}\n                >\n                  Ã—\n                </button>\n              </div>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n};\n\n\n","export const CHAT_STORAGE_PREFIX = \"ai-hud:default-chatbot:history:\";\n\nexport function getConversationStorageKey(conversationId: string): string {\n  return `${CHAT_STORAGE_PREFIX}${conversationId}`;\n}\n\nexport function clearConversation(conversationId: string): void {\n  try {\n    if (typeof window !== \"undefined\") {\n      window.localStorage.removeItem(getConversationStorageKey(conversationId));\n    }\n  } catch {}\n}\n\nexport function clearAllConversations(): void {\n  try {\n    if (typeof window === \"undefined\") return;\n    const keys: string[] = [];\n    for (let i = 0; i < window.localStorage.length; i++) {\n      const key = window.localStorage.key(i);\n      if (key && key.startsWith(CHAT_STORAGE_PREFIX)) keys.push(key);\n    }\n    keys.forEach((k) => window.localStorage.removeItem(k));\n  } catch {}\n}\n\n\n"],"mappings":"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","names":["React","useEffect","useMemo","useRef","useState","html2canvas","useEffect","useRef","useState","jsx","jsxs","FloatingWindow","children","title","onClose","position","width","height","minWidth","minHeight","offset","zIndex","className","style","headerClassName","bodyClassName","closeButtonAriaLabel","closeOnEscape","draggable","anchorRect","isCloseHovered","setIsCloseHovered","containerRef","dragging","setDragging","dragStart","dragTopLeft","setDragTopLeft","handleKeyDown","e","edgeStyle","o","autoTopLeft","vw","vh","gap","preferBottom","preferRight","verticalOrder","horizontalOrder","candidates","c","top","left","handlePointerDown","el","rect","handleMove","ev","dx","dy","handleUp","jsx","jsxs","ChatEnabled","React","children","onClick","label","position","offset","icon","className","containerStyle","buttonClassName","buttonStyle","buttonSize","zIndex","disabled","trigger","open","onOpenChange","renderButton","openWindowOnClick","windowProps","windowContent","ref","isHoveredOrFocused","setIsHoveredOrFocused","useState","isWindowOpen","setIsWindowOpen","internalButtonRef","useRef","containerRef","captureRef","capturedImage","setCapturedImage","resolvedTrigger","positionStyle","useMemo","base","offsetPx","computedVisible","notifyOpenChange","next","containerEventHandlers","sendImageFlag","useEffect","target","r","dataUrl","html2canvas","setMergedRef","el","buttonProps","e","FloatingWindow","merged","useCallback","useEffect","useMemo","useRef","useState","ChatOpenAI","AIMessage","HumanMessage","SystemMessage","ToolMessage","CHAT_STORAGE_PREFIX","getConversationStorageKey","conversationId","clearConversation","clearAllConversations","keys","i","key","k","jsx","jsxs","fileToDataUrl","file","resolve","reject","reader","DefaultChatbot","model","placeholderApiKey","systemPrompt","welcome","className","style","conversationId","context","contextImages","inputPlaceholder","inputValue","tools","toolMaxIterations","apiKey","explicit","g","p","generatedIdRef","useRef","gen","effectiveConversationId","storageKey","CHAT_STORAGE_PREFIX","messages","setMessages","useState","raw","parsed","input","setInput","pendingImages","setPendingImages","isSending","setIsSending","endRef","scrollToEnd","useCallback","toolSchemas","toolExecutors","useMemo","schemas","exec","t","fname","fn","handlePickImages","e","files","urls","prev","removePendingImage","idx","_","i","buildOpenAIMessages","uiMessages","nextUser","result","serialized","valid","u","parts","url","m","send","text","userMsg","lcMsgs","openaiMessages","SystemMessage","AIMessage","c","HumanMessage","base","ChatOpenAI","chat","response","iterations","calls","toolMsgs","call","rawArgs","parsedArgs","out","ToolMessage","content","assistant","err","canSend","useEffect","jsxs","jsx"]}