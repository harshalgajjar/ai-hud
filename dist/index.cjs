"use strict";var le=Object.create;var G=Object.defineProperty;var ce=Object.getOwnPropertyDescriptor;var de=Object.getOwnPropertyNames;var ue=Object.getPrototypeOf,fe=Object.prototype.hasOwnProperty;var ge=(r,a)=>{for(var i in a)G(r,i,{get:a[i],enumerable:!0})},te=(r,a,i,b)=>{if(a&&typeof a=="object"||typeof a=="function")for(let p of de(a))!fe.call(r,p)&&p!==i&&G(r,p,{get:()=>a[p],enumerable:!(b=ce(a,p))||b.enumerable});return r};var ne=(r,a,i)=>(i=r!=null?le(ue(r)):{},te(a||!r||!r.__esModule?G(i,"default",{value:r,enumerable:!0}):i,r)),pe=r=>te(G({},"__esModule",{value:!0}),r);var he={};ge(he,{CHAT_STORAGE_PREFIX:()=>j,ChatEnabled:()=>Z,DefaultChatbot:()=>ie,FloatingWindow:()=>q,clearAllConversations:()=>se,clearConversation:()=>re,getConversationStorageKey:()=>Q});module.exports=pe(he);var y=ne(require("react"),1),oe=ne(require("html2canvas"),1);var L=require("react"),M=require("react/jsx-runtime"),q=({children:r,title:a,onClose:i,position:b="bottom-right",width:p=360,height:A=480,minWidth:F=280,minHeight:O=240,offset:W=16,zIndex:X=1e3,className:R,style:V,headerClassName:S,bodyClassName:B,closeButtonAriaLabel:z="Close",closeOnEscape:E=!0,draggable:I=!0,anchorRect:f})=>{let[x,C]=(0,L.useState)(!1),m=(0,L.useRef)(null),[K,P]=(0,L.useState)(!1),v=(0,L.useRef)(null),[k,H]=(0,L.useState)(null);(0,L.useEffect)(()=>{if(!E)return;let l=u=>{u.key==="Escape"&&i?.()};return window.addEventListener("keydown",l),()=>window.removeEventListener("keydown",l)},[E,i]);let J=(()=>{let l=`${W}px`;switch(b){case"top-left":return{top:l,left:l};case"top-right":return{top:l,right:l};case"bottom-left":return{bottom:l,left:l};case"bottom-right":default:return{bottom:l,right:l}}})(),N=(()=>{if(b!=="auto"||!f)return null;let l=window.innerWidth,u=window.innerHeight,e=W,t=f.top<u/2,n=f.left>l/2,o=t?["bottom","top"]:["top","bottom"],c=n?["right","left"]:["left","right"],w=[`${o[0]}-${c[0]}`,`${o[0]}-${c[1]}`,`${o[1]}-${c[0]}`,`${o[1]}-${c[1]}`];for(let s of w){let _=0,T=0;if(s==="bottom-right"?(_=f.bottom+e,T=f.right-p):s==="bottom-left"?(_=f.bottom+e,T=f.left):s==="top-right"?(_=f.top-A-e,T=f.right-p):(_=f.top-A-e,T=f.left),_>=0&&T>=0&&_+A<=u&&T+p<=l)return{top:_,left:T}}let U=Math.min(Math.max(f.bottom+e,0),u-A),g=Math.min(Math.max(f.right-p,0),l-p);return{top:U,left:g}})(),$=l=>{if(!I)return;let u=m.current;if(!u)return;let e=u.getBoundingClientRect();v.current={x:l.clientX,y:l.clientY,top:e.top,left:e.left},H({top:e.top,left:e.left}),P(!0);let t=o=>{if(!v.current)return;let c=o.clientX-v.current.x,w=o.clientY-v.current.y;H({top:v.current.top+w,left:v.current.left+c})},n=()=>{P(!1),v.current=null,window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",n)};window.addEventListener("pointermove",t),window.addEventListener("pointerup",n,{once:!0})};return(0,M.jsxs)("div",{ref:m,role:"dialog","aria-modal":"false",className:R,style:{position:"fixed",...k?{top:k.top,left:k.left}:N?{top:N.top,left:N.left}:J,width:p,height:A,minWidth:F,minHeight:O,zIndex:X,background:"#ffffff",border:"1px solid rgba(0,0,0,0.06)",borderRadius:12,boxShadow:"0 10px 30px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08)",display:"flex",flexDirection:"column",overflow:"hidden",userSelect:K?"none":void 0,...V},children:[(0,M.jsxs)("div",{className:S,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 12px",borderBottom:"1px solid rgba(0,0,0,0.06)",background:"#f9fafb",cursor:I?"move":void 0},onPointerDown:$,children:[(0,M.jsx)("div",{style:{fontWeight:600,color:"#111827"},children:a}),(0,M.jsx)("button",{type:"button",onClick:i,"aria-label":z,onMouseEnter:()=>C(!0),onMouseLeave:()=>C(!1),style:{width:28,height:28,display:"inline-flex",alignItems:"center",justifyContent:"center",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer",color:x?"#ef4444":void 0,transition:"color 120ms ease"},children:(0,M.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,M.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,M.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),(0,M.jsx)("div",{className:B,style:{flex:1,overflow:"auto",background:"#ffffff"},children:r})]})};var D=require("react/jsx-runtime"),Z=y.default.forwardRef(({children:r,onClick:a,label:i="Open chat",position:b="top-right",offset:p=8,icon:A,className:F,containerStyle:O,buttonClassName:W,buttonStyle:X,buttonSize:R=36,zIndex:V=10,disabled:S=!1,trigger:B,open:z,onOpenChange:E,renderButton:I,openWindowOnClick:f=!1,windowProps:x,windowContent:C},m)=>{let[K,P]=(0,y.useState)(!1),[v,k]=(0,y.useState)(!1),H=(0,y.useRef)(null),J=(0,y.useRef)(null),N=(0,y.useRef)(null),[$,l]=(0,y.useState)(null),u=B??"hover",e=(0,y.useMemo)(()=>{let g={position:"absolute"},s=`${p}px`;switch(b){case"top-left":return{...g,top:s,left:s};case"top-right":return{...g,top:s,right:s};case"bottom-left":return{...g,bottom:s,left:s};case"bottom-right":default:return{...g,bottom:s,right:s}}},[b,p]),t=u==="always"?!0:u==="manual"?!!z:K,n=g=>{E&&E(g)},o={onMouseEnter:u==="hover"?()=>{P(!0),n(!0)}:void 0,onMouseLeave:u==="hover"?()=>{P(!1),n(!1)}:void 0,onFocus:u==="focus"?()=>{P(!0),n(!0)}:void 0,onBlur:u==="focus"?()=>{P(!1),n(!1)}:void 0},c=!!x?.sendComponentImageAsContext;(0,y.useEffect)(()=>{v&&(async()=>{if(!c)return;let s=N.current;if(s)try{await new Promise(ee=>requestAnimationFrame(()=>setTimeout(ee,50)));let T=(await(0,oe.default)(s,{useCORS:!0,backgroundColor:null,scale:Math.min(2,Math.max(1,Math.ceil(s.offsetWidth/280)))})).toDataURL("image/png",.92);l(T)}catch{}})()},[v,c]);let w=g=>{H.current=g,typeof m=="function"?m(g):m&&typeof m=="object"&&(m.current=g)},U={type:"button","aria-label":i,onClick:g=>{a?.(g),!S&&f&&k(!0)},className:W,disabled:S,style:{...e,zIndex:V,width:R,height:R,borderRadius:9999,display:"flex",alignItems:"center",justifyContent:"center",border:"1px solid rgba(0,0,0,0.08)",background:S?"#f3f4f6":"white",color:S?"#9ca3af":void 0,boxShadow:"0 2px 6px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06)",cursor:S?"not-allowed":"pointer",transition:"opacity 120ms ease, transform 120ms ease",opacity:t?1:0,transform:t?"scale(1)":"scale(0.95)",pointerEvents:t?"auto":"none",...X},tabIndex:t?0:-1,"aria-hidden":t?void 0:!0,ref:w,visible:t};return(0,D.jsxs)("div",{className:F,style:{position:"relative",display:"inline-block",...O},...o,ref:J,children:[(0,D.jsx)("div",{ref:N,style:{display:"inline-block"},children:r}),I?I(U):(0,D.jsx)("button",{...U,children:A??(0,D.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:Math.max(12,Math.floor(R*.5)),height:Math.max(12,Math.floor(R*.5)),viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,D.jsx)("path",{d:"M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"})})}),f&&v&&C&&(0,D.jsx)(q,{...x,onClose:()=>{x?.onClose?.(),k(!1),l(null)},anchorRect:x?.anchorRect??(H.current?H.current.getBoundingClientRect():null),children:(()=>{if(c){if(!$)return(0,D.jsx)("div",{style:{padding:12,color:"#6b7280",fontSize:14},children:"Loading..."});if(y.default.isValidElement(C)){let s=[...C.props?.contextImages??[],$];try{return y.default.cloneElement(C,{contextImages:s})}catch{return C}}}return C})()})]})});Z.displayName="ChatEnabled";var h=require("react"),ae=require("@langchain/openai"),Y=require("@langchain/core/messages");var j="ai-hud:default-chatbot:history:";function Q(r){return`${j}${r}`}function re(r){try{typeof window<"u"&&window.localStorage.removeItem(Q(r))}catch{}}function se(){try{if(typeof window>"u")return;let r=[];for(let a=0;a<window.localStorage.length;a++){let i=window.localStorage.key(a);i&&i.startsWith(j)&&r.push(i)}r.forEach(a=>window.localStorage.removeItem(a))}catch{}}var d=require("react/jsx-runtime");async function me(r){return new Promise((a,i)=>{let b=new FileReader;b.onload=()=>a(b.result),b.onerror=i,b.readAsDataURL(r)})}var ie=({model:r="gpt-4o-mini",placeholderApiKey:a,systemPrompt:i="You are a helpful assistant.",welcome:b="Hi! How can I help you today?",className:p,style:A,conversationId:F,context:O,contextImages:W,inputPlaceholder:X,inputValue:R})=>{let S=(e=>{if(e&&e!=="REPLACE_WITH_YOUR_OPENAI_API_KEY")return e;try{let t=globalThis||{};if(typeof t.AI_HUD_OPENAI_API_KEY=="string"&&t.AI_HUD_OPENAI_API_KEY)return t.AI_HUD_OPENAI_API_KEY;if(typeof t.__AI_HUD_OPENAI_API_KEY__=="string"&&t.__AI_HUD_OPENAI_API_KEY__)return t.__AI_HUD_OPENAI_API_KEY__}catch{}try{let t=globalThis.process;if(t&&t.env&&typeof t.env.AI_HUD_OPENAI_API_KEY=="string")return t.env.AI_HUD_OPENAI_API_KEY}catch{}return null})(a),B=(0,h.useRef)(null);if(!F&&!B.current){let e=(()=>{try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`conv_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`})();B.current=e}let z=F??B.current,E=`${j}${z}`,[I,f]=(0,h.useState)(()=>{try{let e=typeof window<"u"?window.localStorage.getItem(E):null;if(e){let t=JSON.parse(e);if(Array.isArray(t))return t}}catch{}return[{id:"welcome",role:"assistant",text:b}]}),[x,C]=(0,h.useState)(()=>typeof R=="string"?R:""),[m,K]=(0,h.useState)([]),[P,v]=(0,h.useState)(!1),k=(0,h.useRef)(null),H=(0,h.useCallback)(()=>{k.current?.scrollIntoView({behavior:"smooth"})},[]),J=async e=>{let t=Array.from(e.target.files||[]);if(t.length===0)return;let n=await Promise.all(t.map(me));K(o=>[...o,...n]),e.target.value=""},N=e=>{K(t=>t.filter((n,o)=>o!==e))},$=(0,h.useCallback)((e,t)=>{let n=[];if(i&&n.push({role:"system",content:i}),typeof O<"u"){let o="";try{o=JSON.stringify(O)}catch{o=String(O)}n.push({role:"system",content:`Context: ${o}`})}if(Array.isArray(W)&&W.length>0){let o=W.filter(c=>typeof c=="string"&&(c.startsWith("data:image/")||c.startsWith("http")));if(o.length>0){let c=[{type:"text",text:"Context images"},...o.map(w=>({type:"image_url",image_url:{url:w}}))];n.push({role:"user",content:c})}}for(let o of e)if(o.role==="assistant")n.push({role:"assistant",content:o.text||""});else if((o.images?.length||0)>0){let c=[{type:"text",text:o.text||""},...o.images.map(w=>({type:"image_url",image_url:{url:w}}))];n.push({role:"user",content:c})}else n.push({role:"user",content:o.text||""});if(t)if(t.images.length>0){let o=[{type:"text",text:t.text},...t.images.map(c=>({type:"image_url",image_url:{url:c}}))];n.push({role:"user",content:o})}else n.push({role:"user",content:t.text});return console.log("result",n),n},[i,O]),l=(0,h.useCallback)(async()=>{let e=x.trim();if(!e&&m.length===0)return;let t={id:String(Date.now()),role:"user",text:e||void 0,images:m.length?m:void 0};f(n=>[...n,t]),C(""),K([]),v(!0);try{let n=[],o=$(I,{text:t.text||"",images:t.images||[]});for(let s of o)if(s.role==="system")n.push(new Y.SystemMessage(s.content));else if(s.role==="assistant")n.push(new Y.AIMessage(s.content));else if(s.role==="user"){let _=s.content;Array.isArray(_)?n.push(new Y.HumanMessage({content:_})):n.push(new Y.HumanMessage(s.content))}let w=await new ae.ChatOpenAI({modelName:r,temperature:.7,apiKey:S??void 0}).invoke(n),U=typeof w.content=="string"?w.content:JSON.stringify(w.content),g={id:String(Date.now()+1),role:"assistant",text:typeof U=="string"?U:String(U)};f(s=>[...s,g]),setTimeout(H,0)}catch(n){let o={id:String(Date.now()+1),role:"assistant",text:`Error: ${n?.message||"Failed to contact OpenAI"}`};f(c=>[...c,o])}finally{v(!1)}},[$,x,I,m,a,r,H]),u=(0,h.useMemo)(()=>(x.trim().length>0||m.length>0)&&!P,[x,m.length,P]);return(0,h.useEffect)(()=>{try{typeof window<"u"&&window.localStorage.setItem(E,JSON.stringify(I))}catch{}},[I,E]),(0,h.useEffect)(()=>()=>{if(!F)try{typeof window<"u"&&window.localStorage.removeItem(E)}catch{}},[F,E]),(0,d.jsxs)("div",{className:p,style:{display:"flex",flexDirection:"column",height:"100%",...A},children:[(0,d.jsxs)("div",{style:{flex:1,overflow:"auto",padding:12,background:"#ffffff"},children:[I.map(e=>(0,d.jsx)("div",{style:{marginBottom:10,display:"flex",justifyContent:e.role==="user"?"flex-end":"flex-start"},children:(0,d.jsxs)("div",{style:{maxWidth:"80%",padding:"8px 10px",borderRadius:10,border:"1px solid rgba(0,0,0,0.06)",background:e.role==="user"?"#111827":"#f3f4f6",color:e.role==="user"?"#ffffff":"#111827",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:[e.text,e.images&&e.images.length>0&&(0,d.jsx)("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:e.images.map((t,n)=>(0,d.jsx)("img",{src:t,alt:"upload",style:{width:96,height:72,objectFit:"cover",borderRadius:8,border:"1px solid rgba(0,0,0,0.06)"}},n))})]})},e.id)),(0,d.jsx)("div",{ref:k})]}),(0,d.jsxs)("div",{style:{padding:12,borderTop:"1px solid rgba(0,0,0,0.06)",background:"#fafafa"},children:[(0,d.jsxs)("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[(0,d.jsx)("input",{type:"file",accept:"image/*",multiple:!0,onChange:J,style:{display:"none"},id:"ai-hud-chatbot-file"}),(0,d.jsx)("label",{htmlFor:"ai-hud-chatbot-file",children:(0,d.jsx)("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:36,height:36,border:"1px solid rgba(0,0,0,0.08)",borderRadius:8,background:"white",cursor:"pointer"},children:(0,d.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,d.jsx)("path",{d:"M18.5 12.5l-5 5-3-3-5 5"}),(0,d.jsx)("path",{d:"M20 7a4 4 0 0 0-8 0v10a4 4 0 0 0 8 0Z"})]})})}),(0,d.jsx)("input",{value:x,onChange:e=>C(e.target.value),placeholder:X??"Type a message...",onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),u&&l())},style:{flex:1,height:36,border:"1px solid rgba(0,0,0,0.15)",borderRadius:8,padding:"0 10px"}}),(0,d.jsx)("button",{type:"button",disabled:!u,onClick:()=>void l(),style:{height:36,padding:"0 12px",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:u?"#111827":"#e5e7eb",color:u?"#ffffff":"#9ca3af",cursor:u?"pointer":"not-allowed"},children:"Send"})]}),m.length>0&&(0,d.jsx)("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:m.map((e,t)=>(0,d.jsxs)("div",{style:{position:"relative"},children:[(0,d.jsx)("img",{src:e,alt:"selected",style:{width:64,height:48,objectFit:"cover",borderRadius:6,border:"1px solid rgba(0,0,0,0.06)"}}),(0,d.jsx)("button",{type:"button",onClick:()=>N(t),"aria-label":"Remove image",style:{position:"absolute",top:-6,right:-6,width:20,height:20,borderRadius:9999,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer"},children:"\xD7"})]},t))})]})]})};0&&(module.exports={CHAT_STORAGE_PREFIX,ChatEnabled,DefaultChatbot,FloatingWindow,clearAllConversations,clearConversation,getConversationStorageKey});
//# sourceMappingURL=index.cjs.map