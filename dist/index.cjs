"use strict";var we=Object.create;var se=Object.defineProperty;var xe=Object.getOwnPropertyDescriptor;var Ce=Object.getOwnPropertyNames;var Ee=Object.getPrototypeOf,Ie=Object.prototype.hasOwnProperty;var _e=(r,s)=>{for(var i in s)se(r,i,{get:s[i],enumerable:!0})},ge=(r,s,i,b)=>{if(s&&typeof s=="object"||typeof s=="function")for(let g of Ce(s))!Ie.call(r,g)&&g!==i&&se(r,g,{get:()=>s[g],enumerable:!(b=xe(s,g))||b.enumerable});return r};var fe=(r,s,i)=>(i=r!=null?we(Ee(r)):{},ge(s||!r||!r.__esModule?se(i,"default",{value:r,enumerable:!0}):i,r)),Ae=r=>ge(se({},"__esModule",{value:!0}),r);var Me={};_e(Me,{CHAT_STORAGE_PREFIX:()=>q,ChatEnabled:()=>le,DefaultChatbot:()=>be,FloatingWindow:()=>ae,clearAllConversations:()=>ye,clearConversation:()=>me,getConversationStorageKey:()=>ce});module.exports=Ae(Me);var h=fe(require("react"),1),pe=fe(require("html2canvas"),1);var N=require("react"),R=require("react/jsx-runtime"),ae=({children:r,title:s,onClose:i,position:b="bottom-right",width:g=360,height:S=480,minWidth:U=280,minHeight:$=240,offset:B=16,zIndex:Z=1e3,className:k,style:K,headerClassName:T,bodyClassName:ne,closeButtonAriaLabel:Q="Close",closeOnEscape:H=!0,draggable:j=!0,anchorRect:u})=>{let[I,w]=(0,N.useState)(!1),x=(0,N.useRef)(null),[J,p]=(0,N.useState)(!1),v=(0,N.useRef)(null),[L,O]=(0,N.useState)(null);(0,N.useEffect)(()=>{if(!H)return;let a=f=>{f.key==="Escape"&&i?.()};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[H,i]);let z=(()=>{let a=`${B}px`;switch(b){case"top-left":return{top:a,left:a};case"top-right":return{top:a,right:a};case"bottom-left":return{bottom:a,left:a};case"bottom-right":default:return{bottom:a,right:a}}})(),D=(()=>{if(b!=="auto"||!u)return null;let a=window.innerWidth,f=window.innerHeight,C=B,E=u.top<f/2,_=u.left>a/2,A=E?["bottom","top"]:["top","bottom"],m=_?["right","left"]:["left","right"],t=[`${A[0]}-${m[0]}`,`${A[0]}-${m[1]}`,`${A[1]}-${m[0]}`,`${A[1]}-${m[1]}`];for(let n of t){let l=0,y=0;if(n==="bottom-right"?(l=u.bottom+C,y=u.right-g):n==="bottom-left"?(l=u.bottom+C,y=u.left):n==="top-right"?(l=u.top-S-C,y=u.right-g):(l=u.top-S-C,y=u.left),l>=0&&y>=0&&l+S<=f&&y+g<=a)return{top:l,left:y}}let o=Math.min(Math.max(u.bottom+C,0),f-S),e=Math.min(Math.max(u.right-g,0),a-g);return{top:o,left:e}})(),X=a=>{if(!j)return;let f=x.current;if(!f)return;let C=f.getBoundingClientRect();v.current={x:a.clientX,y:a.clientY,top:C.top,left:C.left},O({top:C.top,left:C.left}),p(!0);let E=A=>{if(!v.current)return;let m=A.clientX-v.current.x,t=A.clientY-v.current.y;O({top:v.current.top+t,left:v.current.left+m})},_=()=>{p(!1),v.current=null,window.removeEventListener("pointermove",E),window.removeEventListener("pointerup",_)};window.addEventListener("pointermove",E),window.addEventListener("pointerup",_,{once:!0})};return(0,R.jsxs)("div",{ref:x,role:"dialog","aria-modal":"false",className:k,style:{position:"fixed",...L?{top:L.top,left:L.left}:D?{top:D.top,left:D.left}:z,width:g,height:S,minWidth:U,minHeight:$,zIndex:Z,background:"#ffffff",border:"1px solid rgba(0,0,0,0.06)",borderRadius:12,boxShadow:"0 10px 30px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08)",display:"flex",flexDirection:"column",overflow:"hidden",userSelect:J?"none":void 0,...K},children:[(0,R.jsxs)("div",{className:T,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 12px",borderBottom:"1px solid rgba(0,0,0,0.06)",background:"#f9fafb",cursor:j?"move":void 0},onPointerDown:X,children:[(0,R.jsx)("div",{style:{fontWeight:600,color:"#111827"},children:s}),(0,R.jsx)("button",{type:"button",onClick:i,"aria-label":Q,onMouseEnter:()=>w(!0),onMouseLeave:()=>w(!1),style:{width:28,height:28,display:"inline-flex",alignItems:"center",justifyContent:"center",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer",color:I?"#ef4444":void 0,transition:"color 120ms ease"},children:(0,R.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,R.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,R.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),(0,R.jsx)("div",{className:ne,style:{flex:1,overflow:"auto",background:"#ffffff"},children:r})]})};var F=require("react/jsx-runtime"),le=h.default.forwardRef(({children:r,onClick:s,label:i="Open chat",position:b="top-right",offset:g=8,icon:S,className:U,containerStyle:$,buttonClassName:B,buttonStyle:Z,buttonSize:k=36,zIndex:K=10,disabled:T=!1,trigger:ne,open:Q,onOpenChange:H,renderButton:j,openWindowOnClick:u=!1,windowProps:I,windowContent:w},x)=>{let[J,p]=(0,h.useState)(!1),[v,L]=(0,h.useState)(!1),O=(0,h.useRef)(null),z=(0,h.useRef)(null),D=(0,h.useRef)(null),[X,a]=(0,h.useState)(null),f=ne??"hover",C=(0,h.useMemo)(()=>{let e={position:"absolute"},n=`${g}px`;switch(b){case"top-left":return{...e,top:n,left:n};case"top-right":return{...e,top:n,right:n};case"bottom-left":return{...e,bottom:n,left:n};case"bottom-right":default:return{...e,bottom:n,right:n}}},[b,g]),E=f==="always"?!0:f==="manual"?!!Q:J,_=e=>{H&&H(e)},A={onMouseEnter:f==="hover"?()=>{p(!0),_(!0)}:void 0,onMouseLeave:f==="hover"?()=>{p(!1),_(!1)}:void 0,onFocus:f==="focus"?()=>{p(!0),_(!0)}:void 0,onBlur:f==="focus"?()=>{p(!1),_(!1)}:void 0},m=!!I?.sendComponentImageAsContext;(0,h.useEffect)(()=>{v&&(async()=>{if(!m)return;let n=D.current;if(n)try{await new Promise(P=>requestAnimationFrame(()=>setTimeout(P,50)));let y=(await(0,pe.default)(n,{useCORS:!0,backgroundColor:null,scale:Math.min(2,Math.max(1,Math.ceil(n.offsetWidth/280)))})).toDataURL("image/png",.92);a(y)}catch{}})()},[v,m]);let t=e=>{O.current=e,typeof x=="function"?x(e):x&&typeof x=="object"&&(x.current=e)},o={type:"button","aria-label":i,onClick:e=>{s?.(e),!T&&u&&L(!0)},className:B,disabled:T,style:{...C,zIndex:K,width:k,height:k,borderRadius:9999,display:"flex",alignItems:"center",justifyContent:"center",border:"1px solid rgba(0,0,0,0.08)",background:T?"#f3f4f6":"white",color:T?"#9ca3af":void 0,boxShadow:"0 2px 6px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06)",cursor:T?"not-allowed":"pointer",transition:"opacity 120ms ease, transform 120ms ease",opacity:E?1:0,transform:E?"scale(1)":"scale(0.95)",pointerEvents:E?"auto":"none",...Z},tabIndex:E?0:-1,"aria-hidden":E?void 0:!0,ref:t,visible:E};return(0,F.jsxs)("div",{className:U,style:{position:"relative",display:"inline-block",...$},...A,ref:z,children:[(0,F.jsx)("div",{ref:D,style:{display:"inline-block"},children:r}),j?j(o):(0,F.jsx)("button",{...o,children:S??(0,F.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:Math.max(12,Math.floor(k*.5)),height:Math.max(12,Math.floor(k*.5)),viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,F.jsx)("path",{d:"M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"})})}),u&&v&&w&&(0,F.jsx)(ae,{...I,onClose:()=>{I?.onClose?.(),L(!1),a(null)},anchorRect:I?.anchorRect??(O.current?O.current.getBoundingClientRect():null),children:(()=>{if(m){if(!X)return(0,F.jsx)("div",{style:{padding:12,color:"#6b7280",fontSize:14},children:"Loading..."});if(h.default.isValidElement(w)){let n=[...w.props?.contextImages??[],X];try{return h.default.cloneElement(w,{contextImages:n})}catch{return w}}}return w})()})]})});le.displayName="ChatEnabled";var d=require("react"),he=require("@langchain/openai"),W=require("@langchain/core/messages");var q="ai-hud:default-chatbot:history:";function ce(r){return`${q}${r}`}function me(r){try{typeof window<"u"&&window.localStorage.removeItem(ce(r))}catch{}}function ye(){try{if(typeof window>"u")return;let r=[];for(let s=0;s<window.localStorage.length;s++){let i=window.localStorage.key(s);i&&i.startsWith(q)&&r.push(i)}r.forEach(s=>window.localStorage.removeItem(s))}catch{}}var c=require("react/jsx-runtime");async function Pe(r){return new Promise((s,i)=>{let b=new FileReader;b.onload=()=>s(b.result),b.onerror=i,b.readAsDataURL(r)})}var be=({model:r="gpt-4o-mini",placeholderApiKey:s,systemPrompt:i="You are a helpful assistant.",welcome:b="Hi! How can I help you today?",className:g,style:S,conversationId:U,context:$,contextImages:B,inputPlaceholder:Z,inputValue:k,tools:K,toolMaxIterations:T=3})=>{let Q=(t=>{if(t&&t!=="REPLACE_WITH_YOUR_OPENAI_API_KEY")return t;try{let o=globalThis||{};if(typeof o.AI_HUD_OPENAI_API_KEY=="string"&&o.AI_HUD_OPENAI_API_KEY)return o.AI_HUD_OPENAI_API_KEY;if(typeof o.__AI_HUD_OPENAI_API_KEY__=="string"&&o.__AI_HUD_OPENAI_API_KEY__)return o.__AI_HUD_OPENAI_API_KEY__}catch{}try{let o=globalThis.process;if(o&&o.env&&typeof o.env.AI_HUD_OPENAI_API_KEY=="string")return o.env.AI_HUD_OPENAI_API_KEY}catch{}return null})(s),H=(0,d.useRef)(null);if(!U&&!H.current){let t=(()=>{try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`conv_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`})();H.current=t}let j=U??H.current,u=`${q}${j}`,[I,w]=(0,d.useState)(()=>{try{let t=typeof window<"u"?window.localStorage.getItem(u):null;if(t){let o=JSON.parse(t);if(Array.isArray(o))return o}}catch{}return[{id:"welcome",role:"assistant",text:b}]}),[x,J]=(0,d.useState)(()=>typeof k=="string"?k:""),[p,v]=(0,d.useState)([]),[L,O]=(0,d.useState)(!1),z=(0,d.useRef)(null),D=(0,d.useCallback)(()=>{z.current?.scrollIntoView({behavior:"smooth"})},[]),X=(0,d.useCallback)(t=>t?t.replace(/\\\(/g,"(").replace(/\\\)/g,")").replace(/\\times/g,"\xD7").replace(/\\n/g,`
`):"",[]),{toolSchemas:a,toolExecutors:f}=(0,d.useMemo)(()=>{if(!Array.isArray(K))return{toolSchemas:[],toolExecutors:{}};let t=K.map(e=>({type:"function",function:{name:e.function.name,description:e.function.description??"",parameters:e.function.parameters??{type:"object",properties:{}}}})),o={};for(let e of K)o[e.function.name]=async n=>await e.execute(n);return{toolSchemas:t,toolExecutors:o}},[K]),C=async t=>{let o=Array.from(t.target.files||[]);if(o.length===0)return;let e=await Promise.all(o.map(Pe));v(n=>[...n,...e]),t.target.value=""},E=t=>{v(o=>o.filter((e,n)=>n!==t))},_=(0,d.useCallback)((t,o)=>{let e=[];if(i&&e.push({role:"system",content:i}),typeof $<"u"){let n="";try{n=JSON.stringify($)}catch{n=String($)}e.push({role:"system",content:`Context: ${n}`})}if(Array.isArray(B)&&B.length>0){let n=B.filter(l=>typeof l=="string"&&(l.startsWith("data:image/")||l.startsWith("http")));if(n.length>0){let l=[{type:"text",text:"Context images"},...n.map(y=>({type:"image_url",image_url:{url:y}}))];e.push({role:"user",content:l})}}for(let n of t)if(n.role==="assistant")e.push({role:"assistant",content:n.text||""});else if((n.images?.length||0)>0){let l=[{type:"text",text:n.text||""},...n.images.map(y=>({type:"image_url",image_url:{url:y}}))];e.push({role:"user",content:l})}else e.push({role:"user",content:n.text||""});if(o)if(o.images.length>0){let n=[{type:"text",text:o.text},...o.images.map(l=>({type:"image_url",image_url:{url:l}}))];e.push({role:"user",content:n})}else e.push({role:"user",content:o.text});return console.log("result",e),e},[i,$]),A=(0,d.useCallback)(async()=>{let t=x.trim();if(!t&&p.length===0)return;let o={id:String(Date.now()),role:"user",text:t||void 0,images:p.length?p:void 0};w(e=>[...e,o]),J(""),v([]),O(!0);try{let e=[],n=_(I,{text:o.text||"",images:o.images||[]});for(let M of n)if(M.role==="system")e.push(new W.SystemMessage(M.content));else if(M.role==="assistant")e.push(new W.AIMessage(M.content));else if(M.role==="user"){let ee=M.content;Array.isArray(ee)?e.push(new W.HumanMessage({content:ee})):e.push(new W.HumanMessage(M.content))}let l=new he.ChatOpenAI({modelName:r,temperature:.7,apiKey:Q??void 0}),y=a.length>0?l.bind({tools:a}):l,P=await y.invoke(e),ue=0;for(;ue<T&&Array.isArray(P.tool_calls)&&P.tool_calls.length>0&&a.length>0;){let M=P.tool_calls,ee=[];for(let te of M){let V=te.name??te.function?.name,oe=te.args??te.function?.arguments,G=oe;if(typeof oe=="string")try{G=JSON.parse(oe)}catch{G=oe}let de=V?f[V]:void 0,Y=`Tool '${V}' not found`;try{de&&(Y=await de(G))}catch(re){Y=`Error from tool '${V}': ${re?.message||String(re)}`}w(re=>[...re,{id:`${Date.now()}_${V}`,role:"tool",text:`Called ${V} with ${typeof G=="string"?G:JSON.stringify(G)}
\u2192 ${typeof Y=="string"?Y:JSON.stringify(Y)}`}]),ee.push(new W.ToolMessage({tool_call_id:te.id,content:typeof Y=="string"?Y:JSON.stringify(Y)}))}e=[...e,P,...ee],P=await y.invoke(e),ue+=1}let ie=typeof P.content=="string"?P.content:JSON.stringify(P.content),ve={id:String(Date.now()+1),role:"assistant",text:typeof ie=="string"?ie:String(ie)};w(M=>[...M,ve]),setTimeout(D,0)}catch(e){let n={id:String(Date.now()+1),role:"assistant",text:`Error: ${e?.message||"Failed to contact OpenAI"}`};w(l=>[...l,n])}finally{O(!1)}},[_,x,I,p,s,r,D]),m=(0,d.useMemo)(()=>(x.trim().length>0||p.length>0)&&!L,[x,p.length,L]);return(0,d.useEffect)(()=>{try{typeof window<"u"&&window.localStorage.setItem(u,JSON.stringify(I))}catch{}},[I,u]),(0,d.useEffect)(()=>()=>{if(!U)try{typeof window<"u"&&window.localStorage.removeItem(u)}catch{}},[U,u]),(0,c.jsxs)("div",{className:g,style:{display:"flex",flexDirection:"column",height:"100%",...S},children:[(0,c.jsxs)("div",{style:{flex:1,overflow:"auto",padding:12,background:"#ffffff"},children:[I.map(t=>(0,c.jsx)("div",{style:{marginBottom:10,display:"flex",justifyContent:t.role==="user"?"flex-end":"flex-start"},children:(0,c.jsxs)("div",{style:{maxWidth:"80%",padding:"8px 10px",borderRadius:10,border:t.role==="tool"?"1px dashed rgba(0,0,0,0.2)":"1px solid rgba(0,0,0,0.06)",background:t.role==="user"?"#111827":t.role==="tool"?"#fff7ed":"#f3f4f6",color:t.role==="user"?"#ffffff":"#111827",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:[t.role==="assistant"?X(t.text):t.text,t.images&&t.images.length>0&&(0,c.jsx)("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:t.images.map((o,e)=>(0,c.jsx)("img",{src:o,alt:"upload",style:{width:96,height:72,objectFit:"cover",borderRadius:8,border:"1px solid rgba(0,0,0,0.06)"}},e))})]})},t.id)),(0,c.jsx)("div",{ref:z})]}),(0,c.jsxs)("div",{style:{padding:12,borderTop:"1px solid rgba(0,0,0,0.06)",background:"#fafafa"},children:[(0,c.jsxs)("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[(0,c.jsx)("input",{type:"file",accept:"image/*",multiple:!0,onChange:C,style:{display:"none"},id:"ai-hud-chatbot-file"}),(0,c.jsx)("label",{htmlFor:"ai-hud-chatbot-file",children:(0,c.jsx)("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:36,height:36,border:"1px solid rgba(0,0,0,0.08)",borderRadius:8,background:"white",cursor:"pointer"},children:(0,c.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,c.jsx)("path",{d:"M18.5 12.5l-5 5-3-3-5 5"}),(0,c.jsx)("path",{d:"M20 7a4 4 0 0 0-8 0v10a4 4 0 0 0 8 0Z"})]})})}),(0,c.jsx)("input",{value:x,onChange:t=>J(t.target.value),placeholder:Z??"Type a message...",onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),m&&A())},style:{flex:1,height:36,border:"1px solid rgba(0,0,0,0.15)",borderRadius:8,padding:"0 10px"}}),(0,c.jsx)("button",{type:"button",disabled:!m,onClick:()=>void A(),style:{height:36,padding:"0 12px",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:m?"#111827":"#e5e7eb",color:m?"#ffffff":"#9ca3af",cursor:m?"pointer":"not-allowed"},children:"Send"})]}),p.length>0&&(0,c.jsx)("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:p.map((t,o)=>(0,c.jsxs)("div",{style:{position:"relative"},children:[(0,c.jsx)("img",{src:t,alt:"selected",style:{width:64,height:48,objectFit:"cover",borderRadius:6,border:"1px solid rgba(0,0,0,0.06)"}}),(0,c.jsx)("button",{type:"button",onClick:()=>E(o),"aria-label":"Remove image",style:{position:"absolute",top:-6,right:-6,width:20,height:20,borderRadius:9999,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer"},children:"\xD7"})]},o))})]})]})};0&&(module.exports={CHAT_STORAGE_PREFIX,ChatEnabled,DefaultChatbot,FloatingWindow,clearAllConversations,clearConversation,getConversationStorageKey});
//# sourceMappingURL=index.cjs.map