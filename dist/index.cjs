"use strict";var ve=Object.create;var oe=Object.defineProperty;var we=Object.getOwnPropertyDescriptor;var xe=Object.getOwnPropertyNames;var Ce=Object.getPrototypeOf,Ee=Object.prototype.hasOwnProperty;var Ie=(s,a)=>{for(var i in a)oe(s,i,{get:a[i],enumerable:!0})},fe=(s,a,i,h)=>{if(a&&typeof a=="object"||typeof a=="function")for(let g of xe(a))!Ee.call(s,g)&&g!==i&&oe(s,g,{get:()=>a[g],enumerable:!(h=we(a,g))||h.enumerable});return s};var de=(s,a,i)=>(i=s!=null?ve(Ce(s)):{},fe(a||!s||!s.__esModule?oe(i,"default",{value:s,enumerable:!0}):i,s)),_e=s=>fe(oe({},"__esModule",{value:!0}),s);var Me={};Ie(Me,{CHAT_STORAGE_PREFIX:()=>X,ChatEnabled:()=>ie,DefaultChatbot:()=>he,FloatingWindow:()=>re,clearAllConversations:()=>me,clearConversation:()=>pe,getConversationStorageKey:()=>le});module.exports=_e(Me);var y=de(require("react"),1),ge=de(require("html2canvas"),1);var D=require("react"),P=require("react/jsx-runtime"),re=({children:s,title:a,onClose:i,position:h="bottom-right",width:g=360,height:R=480,minWidth:W=280,minHeight:U=240,offset:B=16,zIndex:z=1e3,className:S,style:K,headerClassName:k,bodyClassName:ee,closeButtonAriaLabel:V="Close",closeOnEscape:T=!0,draggable:Y=!0,anchorRect:u})=>{let[_,I]=(0,D.useState)(!1),x=(0,D.useRef)(null),[j,m]=(0,D.useState)(!1),b=(0,D.useRef)(null),[H,L]=(0,D.useState)(null);(0,D.useEffect)(()=>{if(!T)return;let l=p=>{p.key==="Escape"&&i?.()};return window.addEventListener("keydown",l),()=>window.removeEventListener("keydown",l)},[T,i]);let J=(()=>{let l=`${B}px`;switch(h){case"top-left":return{top:l,left:l};case"top-right":return{top:l,right:l};case"bottom-left":return{bottom:l,left:l};case"bottom-right":default:return{bottom:l,right:l}}})(),O=(()=>{if(h!=="auto"||!u)return null;let l=window.innerWidth,p=window.innerHeight,C=B,E=u.top<p/2,A=u.left>l/2,v=E?["bottom","top"]:["top","bottom"],t=A?["right","left"]:["left","right"],n=[`${v[0]}-${t[0]}`,`${v[0]}-${t[1]}`,`${v[1]}-${t[0]}`,`${v[1]}-${t[1]}`];for(let r of n){let w=0,f=0;if(r==="bottom-right"?(w=u.bottom+C,f=u.right-g):r==="bottom-left"?(w=u.bottom+C,f=u.left):r==="top-right"?(w=u.top-R-C,f=u.right-g):(w=u.top-R-C,f=u.left),w>=0&&f>=0&&w+R<=p&&f+g<=l)return{top:w,left:f}}let e=Math.min(Math.max(u.bottom+C,0),p-R),o=Math.min(Math.max(u.right-g,0),l-g);return{top:e,left:o}})(),$=l=>{if(!Y)return;let p=x.current;if(!p)return;let C=p.getBoundingClientRect();b.current={x:l.clientX,y:l.clientY,top:C.top,left:C.left},L({top:C.top,left:C.left}),m(!0);let E=v=>{if(!b.current)return;let t=v.clientX-b.current.x,n=v.clientY-b.current.y;L({top:b.current.top+n,left:b.current.left+t})},A=()=>{m(!1),b.current=null,window.removeEventListener("pointermove",E),window.removeEventListener("pointerup",A)};window.addEventListener("pointermove",E),window.addEventListener("pointerup",A,{once:!0})};return(0,P.jsxs)("div",{ref:x,role:"dialog","aria-modal":"false",className:S,style:{position:"fixed",...H?{top:H.top,left:H.left}:O?{top:O.top,left:O.left}:J,width:g,height:R,minWidth:W,minHeight:U,zIndex:z,background:"#ffffff",border:"1px solid rgba(0,0,0,0.06)",borderRadius:12,boxShadow:"0 10px 30px rgba(0,0,0,0.15), 0 4px 12px rgba(0,0,0,0.08)",display:"flex",flexDirection:"column",overflow:"hidden",userSelect:j?"none":void 0,...K},children:[(0,P.jsxs)("div",{className:k,style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 12px",borderBottom:"1px solid rgba(0,0,0,0.06)",background:"#f9fafb",cursor:Y?"move":void 0},onPointerDown:$,children:[(0,P.jsx)("div",{style:{fontWeight:600,color:"#111827"},children:a}),(0,P.jsx)("button",{type:"button",onClick:i,"aria-label":V,onMouseEnter:()=>I(!0),onMouseLeave:()=>I(!1),style:{width:28,height:28,display:"inline-flex",alignItems:"center",justifyContent:"center",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer",color:_?"#ef4444":void 0,transition:"color 120ms ease"},children:(0,P.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,P.jsx)("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),(0,P.jsx)("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]}),(0,P.jsx)("div",{className:ee,style:{flex:1,overflow:"auto",background:"#ffffff"},children:s})]})};var N=require("react/jsx-runtime"),ie=y.default.forwardRef(({children:s,onClick:a,label:i="Open chat",position:h="top-right",offset:g=8,icon:R,className:W,containerStyle:U,buttonClassName:B,buttonStyle:z,buttonSize:S=36,zIndex:K=10,disabled:k=!1,trigger:ee,open:V,onOpenChange:T,renderButton:Y,openWindowOnClick:u=!1,windowProps:_,windowContent:I},x)=>{let[j,m]=(0,y.useState)(!1),[b,H]=(0,y.useState)(!1),L=(0,y.useRef)(null),J=(0,y.useRef)(null),O=(0,y.useRef)(null),[$,l]=(0,y.useState)(null),p=ee??"hover",C=(0,y.useMemo)(()=>{let o={position:"absolute"},r=`${g}px`;switch(h){case"top-left":return{...o,top:r,left:r};case"top-right":return{...o,top:r,right:r};case"bottom-left":return{...o,bottom:r,left:r};case"bottom-right":default:return{...o,bottom:r,right:r}}},[h,g]),E=p==="always"?!0:p==="manual"?!!V:j,A=o=>{T&&T(o)},v={onMouseEnter:p==="hover"?()=>{m(!0),A(!0)}:void 0,onMouseLeave:p==="hover"?()=>{m(!1),A(!1)}:void 0,onFocus:p==="focus"?()=>{m(!0),A(!0)}:void 0,onBlur:p==="focus"?()=>{m(!1),A(!1)}:void 0},t=!!_?.sendComponentImageAsContext;(0,y.useEffect)(()=>{b&&(async()=>{if(!t)return;let r=O.current;if(r)try{await new Promise(G=>requestAnimationFrame(()=>setTimeout(G,50)));let f=(await(0,ge.default)(r,{useCORS:!0,backgroundColor:null,scale:Math.min(2,Math.max(1,Math.ceil(r.offsetWidth/280)))})).toDataURL("image/png",.92);l(f)}catch{}})()},[b,t]);let n=o=>{L.current=o,typeof x=="function"?x(o):x&&typeof x=="object"&&(x.current=o)},e={type:"button","aria-label":i,onClick:o=>{a?.(o),!k&&u&&H(!0)},className:B,disabled:k,style:{...C,zIndex:K,width:S,height:S,borderRadius:9999,display:"flex",alignItems:"center",justifyContent:"center",border:"1px solid rgba(0,0,0,0.08)",background:k?"#f3f4f6":"white",color:k?"#9ca3af":void 0,boxShadow:"0 2px 6px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06)",cursor:k?"not-allowed":"pointer",transition:"opacity 120ms ease, transform 120ms ease",opacity:E?1:0,transform:E?"scale(1)":"scale(0.95)",pointerEvents:E?"auto":"none",...z},tabIndex:E?0:-1,"aria-hidden":E?void 0:!0,ref:n,visible:E};return(0,N.jsxs)("div",{className:W,style:{position:"relative",display:"inline-block",...U},...v,ref:J,children:[(0,N.jsx)("div",{ref:O,style:{display:"inline-block"},children:s}),Y?Y(e):(0,N.jsx)("button",{...e,children:R??(0,N.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:Math.max(12,Math.floor(S*.5)),height:Math.max(12,Math.floor(S*.5)),viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,N.jsx)("path",{d:"M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"})})}),u&&b&&I&&(0,N.jsx)(re,{..._,onClose:()=>{_?.onClose?.(),H(!1),l(null)},anchorRect:_?.anchorRect??(L.current?L.current.getBoundingClientRect():null),children:(()=>{if(t){if(!$)return(0,N.jsx)("div",{style:{padding:12,color:"#6b7280",fontSize:14},children:"Loading..."});if(y.default.isValidElement(I)){let r=[...I.props?.contextImages??[],$];try{return y.default.cloneElement(I,{contextImages:r})}catch{return I}}}return I})()})]})});ie.displayName="ChatEnabled";var d=require("react"),ye=require("@langchain/openai"),F=require("@langchain/core/messages");var X="ai-hud:default-chatbot:history:";function le(s){return`${X}${s}`}function pe(s){try{typeof window<"u"&&window.localStorage.removeItem(le(s))}catch{}}function me(){try{if(typeof window>"u")return;let s=[];for(let a=0;a<window.localStorage.length;a++){let i=window.localStorage.key(a);i&&i.startsWith(X)&&s.push(i)}s.forEach(a=>window.localStorage.removeItem(a))}catch{}}var c=require("react/jsx-runtime");async function Ae(s){return new Promise((a,i)=>{let h=new FileReader;h.onload=()=>a(h.result),h.onerror=i,h.readAsDataURL(s)})}var he=({model:s="gpt-4o-mini",placeholderApiKey:a,systemPrompt:i="You are a helpful assistant.",welcome:h="Hi! How can I help you today?",className:g,style:R,conversationId:W,context:U,contextImages:B,inputPlaceholder:z,inputValue:S,tools:K,toolMaxIterations:k=3})=>{let V=(t=>{if(t&&t!=="REPLACE_WITH_YOUR_OPENAI_API_KEY")return t;try{let n=globalThis||{};if(typeof n.AI_HUD_OPENAI_API_KEY=="string"&&n.AI_HUD_OPENAI_API_KEY)return n.AI_HUD_OPENAI_API_KEY;if(typeof n.__AI_HUD_OPENAI_API_KEY__=="string"&&n.__AI_HUD_OPENAI_API_KEY__)return n.__AI_HUD_OPENAI_API_KEY__}catch{}try{let n=globalThis.process;if(n&&n.env&&typeof n.env.AI_HUD_OPENAI_API_KEY=="string")return n.env.AI_HUD_OPENAI_API_KEY}catch{}return null})(a),T=(0,d.useRef)(null);if(!W&&!T.current){let t=(()=>{try{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID()}catch{}return`conv_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`})();T.current=t}let Y=W??T.current,u=`${X}${Y}`,[_,I]=(0,d.useState)(()=>{try{let t=typeof window<"u"?window.localStorage.getItem(u):null;if(t){let n=JSON.parse(t);if(Array.isArray(n))return n}}catch{}return[{id:"welcome",role:"assistant",text:h}]}),[x,j]=(0,d.useState)(()=>typeof S=="string"?S:""),[m,b]=(0,d.useState)([]),[H,L]=(0,d.useState)(!1),J=(0,d.useRef)(null),O=(0,d.useCallback)(()=>{J.current?.scrollIntoView({behavior:"smooth"})},[]),{toolSchemas:$,toolExecutors:l}=(0,d.useMemo)(()=>{let t=[],n={};if(Array.isArray(K)){for(let e of K)if(e){if(e.type==="function"&&e.function&&e.function.name){t.push({type:"function",function:e.function});let o=e.function.name;typeof e.invoke=="function"?n[o]=e.invoke.bind(e):typeof e.call=="function"?n[o]=e.call.bind(e):typeof e.func=="function"&&(n[o]=e.func.bind(e))}else if(e.type==="function"&&e.name){let o={name:e.name,description:e.description??"",parameters:e.parameters??{type:"object",properties:{}}};t.push({type:"function",function:o}),typeof e.invoke=="function"?n[e.name]=e.invoke.bind(e):typeof e.call=="function"?n[e.name]=e.call.bind(e):typeof e.func=="function"&&(n[e.name]=e.func.bind(e))}}}return{toolSchemas:t,toolExecutors:n}},[K]),p=async t=>{let n=Array.from(t.target.files||[]);if(n.length===0)return;let e=await Promise.all(n.map(Ae));b(o=>[...o,...e]),t.target.value=""},C=t=>{b(n=>n.filter((e,o)=>o!==t))},E=(0,d.useCallback)((t,n)=>{let e=[];if(i&&e.push({role:"system",content:i}),typeof U<"u"){let o="";try{o=JSON.stringify(U)}catch{o=String(U)}e.push({role:"system",content:`Context: ${o}`})}if(Array.isArray(B)&&B.length>0){let o=B.filter(r=>typeof r=="string"&&(r.startsWith("data:image/")||r.startsWith("http")));if(o.length>0){let r=[{type:"text",text:"Context images"},...o.map(w=>({type:"image_url",image_url:{url:w}}))];e.push({role:"user",content:r})}}for(let o of t)if(o.role==="assistant")e.push({role:"assistant",content:o.text||""});else if((o.images?.length||0)>0){let r=[{type:"text",text:o.text||""},...o.images.map(w=>({type:"image_url",image_url:{url:w}}))];e.push({role:"user",content:r})}else e.push({role:"user",content:o.text||""});if(n)if(n.images.length>0){let o=[{type:"text",text:n.text},...n.images.map(r=>({type:"image_url",image_url:{url:r}}))];e.push({role:"user",content:o})}else e.push({role:"user",content:n.text});return console.log("result",e),e},[i,U]),A=(0,d.useCallback)(async()=>{let t=x.trim();if(!t&&m.length===0)return;let n={id:String(Date.now()),role:"user",text:t||void 0,images:m.length?m:void 0};I(e=>[...e,n]),j(""),b([]),L(!0);try{let e=[],o=E(_,{text:n.text||"",images:n.images||[]});for(let M of o)if(M.role==="system")e.push(new F.SystemMessage(M.content));else if(M.role==="assistant")e.push(new F.AIMessage(M.content));else if(M.role==="user"){let q=M.content;Array.isArray(q)?e.push(new F.HumanMessage({content:q})):e.push(new F.HumanMessage(M.content))}let r=new ye.ChatOpenAI({modelName:s,temperature:.7,apiKey:V??void 0}),w=$.length>0?r.bind({tools:$}):r,f=await w.invoke(e),G=0;for(;G<k&&Array.isArray(f.tool_calls)&&f.tool_calls.length>0&&$.length>0;){let M=f.tool_calls,q=[];for(let Z of M){let te=Z.name??Z.function?.name,ne=Z.args??Z.function?.arguments,ae=ne;if(typeof ne=="string")try{ae=JSON.parse(ne)}catch{ae=ne}let ce=te?l[te]:void 0,Q=`Tool '${te}' not found`;try{ce&&(Q=await ce(ae))}catch(ue){Q=`Error from tool '${te}': ${ue?.message||String(ue)}`}q.push(new F.ToolMessage({tool_call_id:Z.id,content:typeof Q=="string"?Q:JSON.stringify(Q)}))}e=[...e,f,...q],f=await w.invoke(e),G+=1}let se=typeof f.content=="string"?f.content:JSON.stringify(f.content),be={id:String(Date.now()+1),role:"assistant",text:typeof se=="string"?se:String(se)};I(M=>[...M,be]),setTimeout(O,0)}catch(e){let o={id:String(Date.now()+1),role:"assistant",text:`Error: ${e?.message||"Failed to contact OpenAI"}`};I(r=>[...r,o])}finally{L(!1)}},[E,x,_,m,a,s,O]),v=(0,d.useMemo)(()=>(x.trim().length>0||m.length>0)&&!H,[x,m.length,H]);return(0,d.useEffect)(()=>{try{typeof window<"u"&&window.localStorage.setItem(u,JSON.stringify(_))}catch{}},[_,u]),(0,d.useEffect)(()=>()=>{if(!W)try{typeof window<"u"&&window.localStorage.removeItem(u)}catch{}},[W,u]),(0,c.jsxs)("div",{className:g,style:{display:"flex",flexDirection:"column",height:"100%",...R},children:[(0,c.jsxs)("div",{style:{flex:1,overflow:"auto",padding:12,background:"#ffffff"},children:[_.map(t=>(0,c.jsx)("div",{style:{marginBottom:10,display:"flex",justifyContent:t.role==="user"?"flex-end":"flex-start"},children:(0,c.jsxs)("div",{style:{maxWidth:"80%",padding:"8px 10px",borderRadius:10,border:"1px solid rgba(0,0,0,0.06)",background:t.role==="user"?"#111827":"#f3f4f6",color:t.role==="user"?"#ffffff":"#111827",whiteSpace:"pre-wrap",wordBreak:"break-word"},children:[t.text,t.images&&t.images.length>0&&(0,c.jsx)("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:t.images.map((n,e)=>(0,c.jsx)("img",{src:n,alt:"upload",style:{width:96,height:72,objectFit:"cover",borderRadius:8,border:"1px solid rgba(0,0,0,0.06)"}},e))})]})},t.id)),(0,c.jsx)("div",{ref:J})]}),(0,c.jsxs)("div",{style:{padding:12,borderTop:"1px solid rgba(0,0,0,0.06)",background:"#fafafa"},children:[(0,c.jsxs)("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[(0,c.jsx)("input",{type:"file",accept:"image/*",multiple:!0,onChange:p,style:{display:"none"},id:"ai-hud-chatbot-file"}),(0,c.jsx)("label",{htmlFor:"ai-hud-chatbot-file",children:(0,c.jsx)("span",{style:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:36,height:36,border:"1px solid rgba(0,0,0,0.08)",borderRadius:8,background:"white",cursor:"pointer"},children:(0,c.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,c.jsx)("path",{d:"M18.5 12.5l-5 5-3-3-5 5"}),(0,c.jsx)("path",{d:"M20 7a4 4 0 0 0-8 0v10a4 4 0 0 0 8 0Z"})]})})}),(0,c.jsx)("input",{value:x,onChange:t=>j(t.target.value),placeholder:z??"Type a message...",onKeyDown:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),v&&A())},style:{flex:1,height:36,border:"1px solid rgba(0,0,0,0.15)",borderRadius:8,padding:"0 10px"}}),(0,c.jsx)("button",{type:"button",disabled:!v,onClick:()=>void A(),style:{height:36,padding:"0 12px",borderRadius:8,border:"1px solid rgba(0,0,0,0.08)",background:v?"#111827":"#e5e7eb",color:v?"#ffffff":"#9ca3af",cursor:v?"pointer":"not-allowed"},children:"Send"})]}),m.length>0&&(0,c.jsx)("div",{style:{display:"flex",gap:8,marginTop:8,flexWrap:"wrap"},children:m.map((t,n)=>(0,c.jsxs)("div",{style:{position:"relative"},children:[(0,c.jsx)("img",{src:t,alt:"selected",style:{width:64,height:48,objectFit:"cover",borderRadius:6,border:"1px solid rgba(0,0,0,0.06)"}}),(0,c.jsx)("button",{type:"button",onClick:()=>C(n),"aria-label":"Remove image",style:{position:"absolute",top:-6,right:-6,width:20,height:20,borderRadius:9999,border:"1px solid rgba(0,0,0,0.08)",background:"white",cursor:"pointer"},children:"\xD7"})]},n))})]})]})};0&&(module.exports={CHAT_STORAGE_PREFIX,ChatEnabled,DefaultChatbot,FloatingWindow,clearAllConversations,clearConversation,getConversationStorageKey});
//# sourceMappingURL=index.cjs.map